<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Complete Home â€” Monterey County Field Ops</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
:root{
  --bg:#070b14;--surf:#0d1220;--card:#111827;--card2:#161f30;--elev:#1a2235;--inp:#0d1220;
  --blue:#2563eb;--bl:#3b82f6;--bg2:rgba(37,99,235,.12);--bb:rgba(59,130,246,.35);
  --green:#10b981;--gg:rgba(16,185,129,.1);--gb:rgba(16,185,129,.3);
  --amber:#f59e0b;--ag:rgba(245,158,11,.1);
  --red:#ef4444;--rg:rgba(239,68,68,.1);--rb:rgba(239,68,68,.3);
  --violet:#8b5cf6;--vg:rgba(139,92,246,.1);
  --cyan:#06b6d4;
  --t1:#f1f5f9;--t2:#94a3b8;--t3:#475569;
  --bdr:rgba(255,255,255,.07);--bdr2:rgba(255,255,255,.14);--bdrf:rgba(59,130,246,.5);
  --nav-h:56px;
  --font:'Outfit',sans-serif;--mono:'DM Mono',monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--t1);font-family:var(--font);font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased;overflow-x:hidden}
button{font-family:var(--font);cursor:pointer}
input,select,textarea{font-family:var(--font)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--elev);border-radius:3px}

/* â”€â”€ TOPNAV â”€â”€ */
#topnav{
position:sticky;top:0;z-index:200;
height:var(â€“nav-h);
background:rgba(13,18,32,.95);
border-bottom:1px solid var(â€“bdr2);
backdrop-filter:blur(16px);
display:flex;align-items:center;
padding:0 24px;gap:0;
}
.nav-brand{display:flex;align-items:center;gap:10px;margin-right:28px;flex-shrink:0}
.nav-logo{width:30px;height:30px;background:var(â€“blue);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 0 14px rgba(37,99,235,.5)}
.nav-title{font-size:14px;font-weight:800;letter-spacing:-.3px;white-space:nowrap}
.nav-sub{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);letter-spacing:1.5px;text-transform:uppercase;margin-top:1px}
.nav-links{display:flex;align-items:center;gap:2px;flex:1;overflow-x:auto;scrollbar-width:none}
.nav-links::-webkit-scrollbar{display:none}
.nav-a{
padding:7px 13px;border-radius:7px;font-size:12px;font-weight:600;
color:var(â€“t3);white-space:nowrap;border:none;background:transparent;
cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;
}
.nav-a:hover{color:var(â€“t1);background:rgba(255,255,255,.06)}
.nav-a.active{color:var(â€“bl);background:var(â€“bg2)}
.nav-right{display:flex;align-items:center;gap:8px;margin-left:16px;flex-shrink:0}
.nav-chip{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.04);border:1px solid var(â€“bdr);border-radius:7px;padding:6px 11px;font-size:11px;white-space:nowrap}
.nav-chip-val{font-weight:600;color:var(â€“t1)}
.nav-chip-lbl{color:var(â€“t3);font-family:var(â€“mono);font-size:10px}
.ndot{width:7px;height:7px;border-radius:50%;background:var(â€“green);box-shadow:0 0 6px var(â€“green);animation:pg 2s infinite}
.ndot.warn{background:var(â€“amber);box-shadow:0 0 6px var(â€“amber)}
.ndot.bad{background:var(â€“red);box-shadow:0 0 6px var(â€“red)}
@keyframes pg{0%,100%{opacity:1}50%{opacity:.45}}

/* â”€â”€ MAIN SCROLL â”€â”€ */
#page{width:100%;max-width:1600px;margin:0 auto}

/* â”€â”€ SECTIONS â”€â”€ */
.sec{padding:36px 32px;border-bottom:1px solid var(â€“bdr)}
.sec:last-child{border-bottom:none;padding-bottom:80px}
.sec-tag{font-size:10px;font-family:var(â€“mono);letter-spacing:2px;text-transform:uppercase;color:var(â€“t3);display:inline-flex;align-items:center;gap:6px;margin-bottom:5px}
.sec-tag::before{content:â€™â€™;width:14px;height:1px;background:var(â€“t3)}
.sec-hd{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;gap:16px;flex-wrap:wrap}
.sec-hd h2{font-size:20px;font-weight:800;letter-spacing:-.4px;display:flex;align-items:center;gap:9px}
.sec-hd p{font-size:13px;color:var(â€“t2);margin-top:3px}
.sec-actions{display:flex;gap:8px;align-items:center}

/* â”€â”€ MAP SECTION â€” hero â”€â”€ */
#sec-map{padding:0;border-bottom:1px solid var(â€“bdr)}
.map-topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:var(â€“surf);border-bottom:1px solid var(â€“bdr);flex-wrap:wrap;gap:10px}
.map-topbar-left{display:flex;align-items:center;gap:12px}
.map-topbar h2{font-size:15px;font-weight:700;display:flex;align-items:center;gap:7px}
.map-topbar-right{display:flex;align-items:center;gap:8px}
.map-body{display:flex;height:calc(100vh - var(â€“nav-h) - 54px);min-height:520px}
.map-panel{width:260px;flex-shrink:0;background:var(â€“surf);border-right:1px solid var(â€“bdr);display:flex;flex-direction:column;overflow:hidden}
.map-tools-row{padding:8px 10px;border-bottom:1px solid var(â€“bdr);display:flex;gap:5px}
.map-tool{flex:1;background:var(â€“elev);border:1px solid var(â€“bdr2);border-radius:7px;color:var(â€“t2);padding:7px 6px;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;text-align:center;font-family:var(â€“font)}
.map-tool:hover,.map-tool.active{border-color:var(â€“bb);color:var(â€“bl);background:var(â€“bg2)}
.map-tool.danger:hover{border-color:var(â€“rb);color:var(â€“red);background:var(â€“rg)}
.map-stats{display:grid;grid-template-columns:repeat(4,1fr);border-bottom:1px solid var(â€“bdr)}
.ms{padding:8px 0;text-align:center;border-right:1px solid var(â€“bdr)}
.ms:last-child{border-right:none}
.ms-v{font-size:17px;font-weight:800;color:var(â€“t1)}
.ms-l{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1px}
.pin-list{flex:1;overflow-y:auto}
.pin-row{display:flex;align-items:center;gap:8px;padding:9px 12px;border-bottom:1px solid var(â€“bdr);cursor:pointer;transition:background .1s}
.pin-row:hover{background:var(â€“elev)}
.pin-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.pin-name{font-size:12px;font-weight:600;color:var(â€“t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pin-addr{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.map-canvas{flex:1;position:relative}
#leaflet-map{width:100%;height:100%}
.map-hint{position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:500;background:rgba(37,99,235,.92);color:#fff;padding:8px 18px;border-radius:8px;font-size:11px;font-family:var(â€“mono);letter-spacing:.5px;display:none;box-shadow:0 4px 20px rgba(0,0,0,.4);white-space:nowrap;pointer-events:none}
.map-loader{position:absolute;inset:0;z-index:600;background:rgba(7,11,20,.75);display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px;backdrop-filter:blur(4px)}
.map-loader.show{display:flex}
.map-loader-txt{font-size:12px;color:var(â€“bl);font-family:var(â€“mono);letter-spacing:1px}
.map-legend{position:absolute;bottom:12px;right:8px;z-index:400;background:rgba(13,18,32,.94);border:1px solid var(â€“bdr2);border-radius:9px;padding:10px 13px;backdrop-filter:blur(6px)}
.map-legend h5{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:7px}
.leg-r{display:flex;align-items:center;gap:7px;margin-bottom:4px;font-size:10px;color:var(â€“t2)}
.leg-d{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* â”€â”€ COMPONENTS â”€â”€ */
.card{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;overflow:hidden;transition:border-color .2s}
.card:hover{border-color:var(â€“bdr2)}
.card-hd{padding:13px 17px;border-bottom:1px solid var(â€“bdr);display:flex;align-items:center;justify-content:space-between}
.card-hd h3{font-size:13px;font-weight:600}
.card-hd .meta{font-size:11px;color:var(â€“t3);font-family:var(â€“mono)}
.card-body{padding:15px}

/* KPI */
.kpi-row{display:grid;gap:12px;margin-bottom:20px}
.k4{grid-template-columns:repeat(4,1fr)}
.k3{grid-template-columns:repeat(3,1fr)}
@media(max-width:1000px){.k4{grid-template-columns:repeat(2,1fr)}.k3{grid-template-columns:repeat(2,1fr)}}
.kpi{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;padding:16px 20px;position:relative;overflow:hidden;transition:border-color .2s,transform .15s}
.kpi:hover{border-color:var(â€“bdr2);transform:translateY(-1px)}
.kpi::after{content:â€™â€™;position:absolute;bottom:0;left:0;right:0;height:2px;opacity:.8}
.kpi.blue::after{background:linear-gradient(90deg,transparent,var(â€“blue),transparent)}
.kpi.green::after{background:linear-gradient(90deg,transparent,var(â€“green),transparent)}
.kpi.amber::after{background:linear-gradient(90deg,transparent,var(â€“amber),transparent)}
.kpi.violet::after{background:linear-gradient(90deg,transparent,var(â€“violet),transparent)}
.kpi.cyan::after{background:linear-gradient(90deg,transparent,var(â€“cyan),transparent)}
.kpi-lbl{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(â€“t3);font-family:var(â€“mono);margin-bottom:7px}
.kpi-val{font-size:26px;font-weight:900;letter-spacing:-1px;line-height:1}
.kpi.blue .kpi-val{color:var(â€“bl)}.kpi.green .kpi-val{color:var(â€“green)}
.kpi.amber .kpi-val{color:var(â€“amber)}.kpi.violet .kpi-val{color:var(â€“violet)}.kpi.cyan .kpi-val{color:var(â€“cyan)}
.kpi-sub{font-size:11px;color:var(â€“t3);margin-top:4px}

/* BTNS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;border:none;transition:all .15s;cursor:pointer;white-space:nowrap;font-family:var(â€“font)}
.btn-primary{background:var(â€“blue);color:#fff}
.btn-primary:hover{background:var(â€“bl);box-shadow:0 4px 14px rgba(37,99,235,.4)}
.btn-success{background:var(â€“green);color:#fff}
.btn-success:hover{background:#0ea371;box-shadow:0 4px 14px rgba(16,185,129,.3)}
.btn-ghost{background:rgba(255,255,255,.05);color:var(â€“t2);border:1px solid var(â€“bdr2)}
.btn-ghost:hover{color:var(â€“t1);border-color:var(â€“bb);background:var(â€“bg2)}
.btn-danger{background:var(â€“red);color:#fff}
.btn-sm{padding:6px 13px;font-size:12px}

/* BADGES */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:600;font-family:var(â€“mono);letter-spacing:.5px;text-transform:uppercase;white-space:nowrap}
.b-blue{background:var(â€“bg2);color:var(â€“bl);border:1px solid var(â€“bb)}
.b-green{background:var(â€“gg);color:var(â€“green);border:1px solid var(â€“gb)}
.b-amber{background:var(â€“ag);color:var(â€“amber);border:1px solid rgba(245,158,11,.3)}
.b-red{background:var(â€“rg);color:var(â€“red);border:1px solid var(â€“rb)}
.b-violet{background:var(â€“vg);color:var(â€“violet);border:1px solid rgba(139,92,246,.3)}
.b-gray{background:rgba(71,85,105,.2);color:var(â€“t3);border:1px solid rgba(71,85,105,.3)}
.b-cyan{background:rgba(6,182,212,.1);color:var(â€“cyan);border:1px solid rgba(6,182,212,.3)}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot.g{background:var(â€“green);box-shadow:0 0 6px var(â€“green)}
.dot.a{background:var(â€“amber);box-shadow:0 0 6px var(â€“amber)}
.dot.r{background:var(â€“red);box-shadow:0 0 6px var(â€“red)}

/* GRIDS */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media(max-width:1100px){.g3,.g4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:700px){.g2,.g3,.g4{grid-template-columns:1fr}}

/* TABLES */
.tbl{width:100%;border-collapse:collapse}
.tbl th{padding:10px 14px;text-align:left;font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(â€“t3);font-family:var(â€“mono);border-bottom:1px solid var(â€“bdr);background:var(â€“card);white-space:nowrap}
.tbl td{padding:11px 14px;border-bottom:1px solid var(â€“bdr);font-size:13px;color:var(â€“t2);background:var(â€“card)}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(â€“card2)}
.tbl td.pri{color:var(â€“t1);font-weight:600}
.tbl td.money{color:var(â€“green);font-family:var(â€“mono);font-weight:700;font-size:14px}
.tbl td.mono{font-family:var(â€“mono);font-size:11px}

/* FORMS */
.fg{margin-bottom:13px}
.fl{display:block;font-size:11px;font-weight:600;color:var(â€“t2);margin-bottom:5px}
.fi,.fs,.ft{width:100%;background:var(â€“inp);border:1px solid var(â€“bdr2);border-radius:8px;color:var(â€“t1);padding:9px 12px;font-size:13px;font-family:var(â€“font);outline:none;transition:border-color .15s,box-shadow .15s;appearance:none}
.fi:focus,.fs:focus,.ft:focus{border-color:var(â€“bdrf);box-shadow:0 0 0 3px rgba(59,130,246,.2)}
.fs option{background:var(â€“elev)}
.ft{resize:vertical;min-height:70px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:11px}

/* ACTIVITY */
.act-item{display:flex;align-items:center;gap:11px;padding:10px 0;border-bottom:1px solid var(â€“bdr)}
.act-item:last-child{border-bottom:none}
.act-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.act-title{font-size:13px;font-weight:600;color:var(â€“t1)}
.act-sub{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);margin-top:1px}
.act-time{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);white-space:nowrap;margin-left:auto}

/* CALENDAR */
.cal-shell{display:grid;grid-template-columns:1fr 260px;gap:16px}
.cal-nav{display:flex;align-items:center;gap:8px}
.cal-arr{background:var(â€“elev);border:1px solid var(â€“bdr2);border-radius:7px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:15px;cursor:pointer;color:var(â€“t2);transition:all .15s}
.cal-arr:hover{border-color:var(â€“bb);color:var(â€“bl)}
.cal-mlbl{font-size:12px;font-weight:600;font-family:var(â€“mono);color:var(â€“t1);min-width:96px;text-align:center}
.cal-grid-hd{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:2px}
.cal-dh{text-align:center;padding:6px 4px;font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(â€“t3);font-family:var(â€“mono)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-cell{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:6px;min-height:70px;padding:5px;cursor:pointer;transition:border-color .15s}
.cal-cell:hover{border-color:var(â€“bb);background:var(â€“card2)}
.cal-cell.today{border-color:var(â€“bl);background:var(â€“bg2)}
.cal-cell.other{background:var(â€“surf);opacity:.35;cursor:default;pointer-events:none}
.cal-dn{font-size:10px;font-family:var(â€“mono);color:var(â€“t3);margin-bottom:2px}
.cal-cell.today .cal-dn{color:var(â€“bl);font-weight:700}
.cal-pill{display:block;border-radius:3px;padding:2px 4px;margin-bottom:2px;font-size:9px;font-weight:600;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.ap-demo{background:var(â€“vg);color:var(â€“violet);border-left:2px solid var(â€“violet)}
.ap-followup{background:var(â€“ag);color:var(â€“amber);border-left:2px solid var(â€“amber)}
.ap-close{background:var(â€“gg);color:var(â€“green);border-left:2px solid var(â€“green)}
.ap-visit{background:var(â€“bg2);color:var(â€“bl);border-left:2px solid var(â€“bl)}
.appt-item{padding:11px 14px;border-bottom:1px solid var(â€“bdr);cursor:pointer;transition:background .1s}
.appt-item:hover{background:var(â€“elev)}
.appt-time{font-size:10px;color:var(â€“bl);font-family:var(â€“mono);font-weight:600;margin-bottom:2px}
.appt-name{font-size:13px;font-weight:600;color:var(â€“t1)}
.appt-det{font-size:11px;color:var(â€“t3);margin-top:1px}

/* LEADERBOARD */
.podium{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.pod-card{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;padding:18px;text-align:center;transition:transform .15s}
.pod-card:hover{transform:translateY(-2px);border-color:var(â€“bdr2)}
.pod-card.gold{border-color:rgba(245,158,11,.4);background:linear-gradient(135deg,var(â€“card),rgba(245,158,11,.05))}
.pod-card.silver{border-color:rgba(148,163,184,.3)}
.pod-card.bronze{border-color:rgba(205,127,50,.3)}
.pod-medal{font-size:22px;margin-bottom:7px}
.pod-av{width:42px;height:42px;border-radius:50%;margin:0 auto 7px;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;border:2px solid}
.pod-name{font-size:14px;font-weight:700;color:var(â€“t1)}
.pod-area{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);margin-top:2px;margin-bottom:9px}
.pod-amt{font-size:20px;font-weight:900;color:var(â€“green);letter-spacing:-.5px}
.pod-meta{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);margin-top:2px}

/* AREAS */
.area-card{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;padding:16px;position:relative;overflow:hidden;transition:border-color .2s,transform .15s}
.area-card:hover{border-color:var(â€“bdr2);transform:translateY(-1px)}
.area-stripe{position:absolute;top:0;left:0;width:4px;height:100%}
.area-name{font-size:14px;font-weight:700;color:var(â€“t1);margin-bottom:2px;padding-left:8px}
.area-meta{font-size:11px;color:var(â€“t3);font-family:var(â€“mono);margin-bottom:11px;padding-left:8px}
.area-stats{display:flex;gap:16px;padding-left:8px}
.area-sv{font-size:18px;font-weight:800;letter-spacing:-.4px}
.area-sl{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1px}
.area-prog{height:3px;background:var(â€“elev);border-radius:2px;margin-top:11px}
.area-prog-fill{height:100%;border-radius:2px;transition:width .8s}
.area-note{font-size:11px;color:var(â€“t3);margin-top:7px;line-height:1.5;padding-left:8px}

/* TEAM */
.team-card{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;padding:16px;transition:border-color .2s,transform .15s}
.team-card:hover{border-color:var(â€“bdr2);transform:translateY(-1px)}
.team-top{display:flex;align-items:center;gap:11px;padding-bottom:12px;margin-bottom:12px;border-bottom:1px solid var(â€“bdr)}
.team-av{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;flex-shrink:0;border:1px solid}
.team-name{font-size:13px;font-weight:700;color:var(â€“t1)}
.team-role{font-size:10px;font-family:var(â€“mono);color:var(â€“t3);text-transform:uppercase;letter-spacing:1px;margin-top:1px}
.team-area-lbl{font-size:11px;color:var(â€“bl);margin-top:2px}
.team-metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
.tm-val{font-size:17px;font-weight:800;letter-spacing:-.3px}
.tm-lbl{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1px}

/* REP BARS */
.rep-bar-wrap{display:flex;align-items:center;gap:9px;margin-bottom:9px}
.rep-bar-name{width:64px;font-size:11px;font-family:var(â€“mono);color:var(â€“t3);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rep-bar-track{flex:1;height:20px;background:var(â€“elev);border-radius:4px;overflow:hidden}
.rep-bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:7px;transition:width .8s ease}
.rep-bar-fill span{font-size:9px;font-weight:700;color:#fff;font-family:var(â€“mono)}

/* WEATHER */
.wx-hero{display:grid;grid-template-columns:1fr 1.1fr;gap:12px;margin-bottom:14px}
.wx-main{background:linear-gradient(135deg,var(â€“card),rgba(37,99,235,.08));border:1px solid var(â€“bdr);border-radius:12px;padding:22px;display:flex;align-items:center;gap:18px}
.wx-big-icon{font-size:54px;line-height:1}
.wx-temp{font-size:44px;font-weight:900;letter-spacing:-2px;line-height:1}
.wx-cond{font-size:14px;font-weight:600;color:var(â€“bl);margin-top:4px}
.wx-loc{font-size:11px;color:var(â€“t3);font-family:var(â€“mono);margin-top:3px}
.wx-feels{font-size:12px;color:var(â€“t2);margin-top:2px}
.wx-details{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;padding:14px}
.wx-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(â€“bdr)}
.wx-row:last-child{border-bottom:none}
.wx-row-lbl{font-size:12px;color:var(â€“t2)}
.wx-row-val{font-size:12px;font-weight:600;font-family:var(â€“mono);color:var(â€“t1)}
.fc-row{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:13px}
.fc-day{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:8px;padding:10px 5px;text-align:center}
.fc-lbl{font-size:9px;font-family:var(â€“mono);color:var(â€“t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.fc-ico{font-size:18px;margin-bottom:4px}
.fc-hi{font-size:12px;font-weight:700;color:var(â€“t1)}
.fc-lo{font-size:10px;color:var(â€“t3);font-family:var(â€“mono)}
.wx-alert{background:var(â€“ag);border:1px solid rgba(245,158,11,.3);border-radius:9px;padding:11px 13px;margin-bottom:13px;display:flex;gap:9px;align-items:flex-start}
.wx-impact{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;padding:14px}
.wx-impact h4{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:11px}
.impact-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px}
.imp{background:var(â€“elev);border:1px solid var(â€“bdr);border-radius:9px;padding:11px;text-align:center}
.imp-ico{font-size:17px;margin-bottom:4px}
.imp-lbl{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
.imp-val{font-size:12px;font-weight:700}
.imp-good{color:var(â€“green)}.imp-ok{color:var(â€“amber)}.imp-bad{color:var(â€“red)}

/* CRIME */
#crime-map-wrap{border:1px solid var(â€“bdr);border-radius:12px;overflow:hidden;height:360px;margin-bottom:12px}
.crime-bar{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:9px;padding:11px 14px;margin-bottom:11px;font-size:13px;color:var(â€“t2)}
.crime-bar.ok{border-color:var(â€“gb);color:var(â€“green);background:var(â€“gg)}
.crime-bar.err{border-color:var(â€“rb);color:var(â€“red);background:var(â€“rg)}
.crime-filters{display:flex;gap:5px;margin-bottom:11px;flex-wrap:wrap}
.cf-btn{background:var(â€“elev);border:1px solid var(â€“bdr2);border-radius:7px;color:var(â€“t2);padding:5px 11px;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;font-family:var(â€“font)}
.cf-btn.active,.cf-btn:hover{background:var(â€“ag);border-color:rgba(245,158,11,.4);color:var(â€“amber)}
.log-row{display:grid;grid-template-columns:90px 1fr 70px;gap:11px;align-items:center;padding:9px 14px;border-bottom:1px solid var(â€“bdr);font-size:12px}
.log-row:last-child{border-bottom:none}
.log-time{font-family:var(â€“mono);font-size:10px;color:var(â€“t3)}
.log-msg{color:var(â€“t2)}
.log-score{font-family:var(â€“mono);font-size:10px;text-align:right;font-weight:600}

/* SERVICE STATUS */
.svc-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;margin-bottom:14px}
.svc-card{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;padding:14px;transition:border-color .2s}
.svc-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:9px}
.svc-name{font-size:13px;font-weight:600;color:var(â€“t1)}
.svc-desc{font-size:11px;color:var(â€“t3);font-family:var(â€“mono);margin-top:1px}
.svc-spark{height:36px;display:flex;align-items:flex-end;gap:2px;margin-bottom:7px}
.svc-bar{flex:1;border-radius:2px;min-height:3px}
.svc-bot{display:flex;justify-content:space-between;font-size:10px;font-family:var(â€“mono);color:var(â€“t3)}
.svc-bot .ok{color:var(â€“green);font-weight:700}
.svc-bot .down{color:var(â€“red);font-weight:700}
.svc-bot .chk{color:var(â€“amber);font-weight:700}
.ov-banner{border-radius:10px;padding:13px 16px;margin-bottom:14px;display:flex;align-items:center;gap:13px;background:var(â€“card);border:1px solid var(â€“bdr)}
.ov-banner.all-ok{border-color:var(â€“gb);background:var(â€“gg)}
.ov-banner.issues{border-color:rgba(245,158,11,.3);background:var(â€“ag)}
.ov-icon{font-size:20px}
.ov-title{font-size:14px;font-weight:700}
.ov-banner.all-ok .ov-title{color:var(â€“green)}
.ov-banner.issues .ov-title{color:var(â€“amber)}
.ov-sub{font-size:11px;color:var(â€“t3);font-family:var(â€“mono);margin-top:1px}

/* EMPTY */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;color:var(â€“t3);gap:7px}
.empty-icon{font-size:28px;opacity:.4}
.empty-title{font-size:13px;font-weight:600;color:var(â€“t2)}
.empty-sub{font-size:12px;max-width:220px;line-height:1.6}

/* SPINNER */
.spinner{width:26px;height:26px;border:3px solid var(â€“bdr2);border-top-color:var(â€“bl);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.load-wrap{display:flex;flex-direction:column;align-items:center;gap:11px;padding:44px}
.load-txt{font-size:12px;color:var(â€“t3);font-family:var(â€“mono);letter-spacing:1px}

/* MODALS */
.modal-backdrop{position:fixed;inset:0;background:rgba(7,11,20,.82);backdrop-filter:blur(6px);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.modal-backdrop.open{display:flex;animation:fadein .2s ease}
@keyframes fadein{from{opacity:0}to{opacity:1}}
.modal{background:var(â€“card);border:1px solid var(â€“bdr2);border-radius:16px;width:500px;max-width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.7);animation:slideUp .25s cubic-bezier(.4,0,.2,1)}
@keyframes slideUp{from{opacity:0;transform:translateY(14px) scale(.98)}to{opacity:1;transform:none}}
.modal-hd{padding:18px 20px 14px;border-bottom:1px solid var(â€“bdr);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:15px;font-weight:700;color:var(â€“t1);letter-spacing:-.2px}
.modal-x{width:26px;height:26px;background:var(â€“elev);border:1px solid var(â€“bdr);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;color:var(â€“t3);cursor:pointer;transition:all .15s}
.modal-x:hover{background:var(â€“rg);border-color:var(â€“rb);color:var(â€“red)}
.modal-bd{padding:18px 20px}
.modal-ft{padding:12px 20px;border-top:1px solid var(â€“bdr);display:flex;gap:8px;justify-content:flex-end}

/* TOASTS */
#toasts{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.toast{background:var(â€“elev);border:1px solid var(â€“bdr2);border-radius:9px;padding:10px 15px;display:flex;align-items:center;gap:8px;font-size:13px;color:var(â€“t1);box-shadow:0 8px 30px rgba(0,0,0,.5);pointer-events:all;max-width:300px;animation:toastIn .3s ease}
.toast.success{border-left:3px solid var(â€“green)}
.toast.error{border-left:3px solid var(â€“red)}
.toast.info{border-left:3px solid var(â€“bl)}
@keyframes toastIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}
</style>

</head>
<body>

<!-- â”€â”€ TOP NAV â”€â”€ -->

<nav id="topnav">
  <div class="nav-brand">
    <div class="nav-logo">ğŸ </div>
    <div>
      <div class="nav-title">Complete Home</div>
      <div class="nav-sub">Monterey County</div>
    </div>
  </div>
  <div class="nav-links">
    <button class="nav-a active" onclick="scrollSec('sec-dash')">â¬› Dashboard</button>
    <button class="nav-a" onclick="scrollSec('sec-map')">ğŸ“ Live Map</button>
    <button class="nav-a" onclick="scrollSec('sec-calendar')">ğŸ“… Calendar</button>
    <button class="nav-a" onclick="scrollSec('sec-areas')">ğŸ—º Territories</button>
    <button class="nav-a" onclick="scrollSec('sec-sales')">ğŸ’° Sales</button>
    <button class="nav-a" onclick="scrollSec('sec-lb')">ğŸ† Leaderboard</button>
    <button class="nav-a" onclick="scrollSec('sec-team')">ğŸ‘¥ Team</button>
    <button class="nav-a" onclick="scrollSec('sec-weather')">ğŸŒ¤ Weather</button>
    <button class="nav-a" onclick="scrollSec('sec-crime')">ğŸš¨ Crime</button>
    <button class="nav-a" onclick="scrollSec('sec-status')">âš¡ Status</button>
  </div>
  <div class="nav-right">
    <div class="nav-chip">
      <span id="top-wx-icon">ğŸŒ¤</span>
      <span id="top-wx-temp" class="nav-chip-val">--Â°F</span>
      <span id="top-wx-cond" class="nav-chip-lbl"></span>
    </div>
    <div class="nav-chip">
      <span class="ndot" id="net-dot"></span>
      <span class="nav-chip-val" id="net-lbl">Online</span>
    </div>
  </div>
</nav>

<div id="page">

<!-- â”€â”€ DASHBOARD â”€â”€ -->

<section class="sec" id="sec-dash">
  <div class="sec-tag">Overview</div>
  <div class="sec-hd">
    <div><h2>Good morning, Darrell ğŸ‘‹</h2><p>Complete Home field operations â€” Monterey County, CA</p></div>
    <div class="sec-actions">
      <button class="btn btn-primary btn-sm" onclick="scrollSec('sec-map')">ğŸ“ Open Map</button>
      <button class="btn btn-success btn-sm" onclick="openSaleModal()">+ Log Sale</button>
    </div>
  </div>
  <div class="kpi-row k4">
    <div class="kpi blue"><div class="kpi-lbl">Total Pins</div><div class="kpi-val" id="db-pins">0</div><div class="kpi-sub">Doors worked</div></div>
    <div class="kpi green"><div class="kpi-lbl">Revenue</div><div class="kpi-val" id="db-rev">$0</div><div class="kpi-sub">Logged sales</div></div>
    <div class="kpi amber"><div class="kpi-lbl">Appointments</div><div class="kpi-val" id="db-appts">0</div><div class="kpi-sub">Scheduled</div></div>
    <div class="kpi violet"><div class="kpi-lbl">Close Rate</div><div class="kpi-val" id="db-rate">0%</div><div class="kpi-sub">Sold Ã· pins</div></div>
  </div>
  <div class="g2">
    <div class="card">
      <div class="card-hd"><h3>Recent Activity</h3><span class="meta" style="display:flex;align-items:center;gap:5px"><span class="dot g"></span>Live</span></div>
      <div class="card-body" id="db-activity"></div>
    </div>
    <div class="card">
      <div class="card-hd"><h3>Today's Appointments</h3></div>
      <div id="db-today"></div>
    </div>
  </div>
</section>

<!-- â”€â”€ MAP (HERO â€” full viewport height) â”€â”€ -->

<section id="sec-map">
  <div class="map-topbar">
    <div class="map-topbar-left">
      <h2>ğŸ“ Live Map â€” Monterey County</h2>
      <span class="badge b-blue" id="map-ct">0 pins</span>
    </div>
    <div class="map-topbar-right">
      <button class="btn btn-ghost btn-sm" onclick="setMapTool('pin',document.getElementById('tool-pin'))">ğŸ“ Pin Mode</button>
      <button class="btn btn-ghost btn-sm" onclick="setMapTool('lasso',document.getElementById('tool-lasso'))">âœï¸ Lasso</button>
      <button class="btn btn-ghost btn-sm" style="color:var(--red)" onclick="clearPins()">ğŸ—‘ Clear All</button>
    </div>
  </div>
  <div class="map-body">
    <div class="map-panel">
      <div class="map-tools-row">
        <button class="map-tool active" id="tool-pin" onclick="setMapTool('pin',this)">ğŸ“ Pin</button>
        <button class="map-tool" id="tool-lasso" onclick="setMapTool('lasso',this)">âœï¸ Lasso</button>
        <button class="map-tool danger" onclick="clearPins()">ğŸ—‘ Clear</button>
      </div>
      <div class="map-stats">
        <div class="ms"><div class="ms-v" id="ms-total">0</div><div class="ms-l">Total</div></div>
        <div class="ms"><div class="ms-v" style="color:var(--green)" id="ms-sold">0</div><div class="ms-l">Sold</div></div>
        <div class="ms"><div class="ms-v" style="color:var(--violet)" id="ms-appt">0</div><div class="ms-l">Appts</div></div>
        <div class="ms"><div class="ms-v" style="color:var(--t3)" id="ms-nh">0</div><div class="ms-l">N/H</div></div>
      </div>
      <div class="pin-list" id="pin-list">
        <div class="empty" style="padding:28px 10px">
          <div class="empty-icon" style="font-size:20px">ğŸ“</div>
          <div class="empty-title" style="font-size:12px">No pins yet</div>
          <div class="empty-sub" style="font-size:11px">Click the map to drop a pin, or use Lasso to auto-fill a neighborhood.</div>
        </div>
      </div>
    </div>
    <div class="map-canvas">
      <div id="leaflet-map"></div>
      <div class="map-hint" id="lasso-hint">Click to add points â€” Enter to finish Â· Esc to cancel</div>
      <div class="map-loader" id="map-loader">
        <div class="spinner"></div>
        <div class="map-loader-txt" id="map-loader-msg">Querying buildingsâ€¦</div>
      </div>
      <div class="map-legend">
        <h5>Status</h5>
        <div class="leg-r"><div class="leg-d" style="background:#475569"></div>Not Home</div>
        <div class="leg-r"><div class="leg-d" style="background:#3b82f6"></div>New Lead</div>
        <div class="leg-r"><div class="leg-d" style="background:#f59e0b"></div>Contacted</div>
        <div class="leg-r"><div class="leg-d" style="background:#8b5cf6"></div>Appointment</div>
        <div class="leg-r"><div class="leg-d" style="background:#10b981"></div>Sold</div>
        <div class="leg-r"><div class="leg-d" style="background:#ef4444"></div>Not Interested</div>
      </div>
    </div>
  </div>
</section>

<!-- â”€â”€ CALENDAR â”€â”€ -->

<section class="sec" id="sec-calendar">
  <div class="sec-tag">Field Operations</div>
  <div class="sec-hd">
    <div><h2>ğŸ“… Appointment Calendar</h2><p>Double-click any day to schedule an appointment</p></div>
    <div class="sec-actions">
      <div class="cal-nav">
        <button class="cal-arr" onclick="calNav(-1)">â€¹</button>
        <div class="cal-mlbl" id="cal-lbl">FEB 2026</div>
        <button class="cal-arr" onclick="calNav(1)">â€º</button>
      </div>
      <button class="btn btn-primary btn-sm" onclick="openApptModal(null)">+ Appointment</button>
    </div>
  </div>
  <div class="cal-shell">
    <div>
      <div class="cal-grid-hd" id="cal-hd"></div>
      <div class="cal-grid" id="cal-grid"></div>
    </div>
    <div class="card" style="max-height:560px;overflow-y:auto">
      <div class="card-hd"><h3>Upcoming</h3></div>
      <div id="appt-list"></div>
    </div>
  </div>
</section>

<!-- â”€â”€ TERRITORIES â”€â”€ -->

<section class="sec" id="sec-areas">
  <div class="sec-tag">Field Operations</div>
  <div class="sec-hd">
    <div><h2>ğŸ—º Territory Areas</h2><p>Monterey County canvassing zones</p></div>
    <div class="sec-actions"><button class="btn btn-primary btn-sm" onclick="openAreaModal()">+ Add Territory</button></div>
  </div>
  <div class="g3" id="areas-grid">
    <div class="empty" style="grid-column:1/-1">
      <div class="empty-icon">ğŸ—º</div>
      <div class="empty-title">No territories yet</div>
      <div class="empty-sub">Add territories to organize your canvassing zones across Monterey County.</div>
    </div>
  </div>
</section>

<!-- â”€â”€ SALES â”€â”€ -->

<section class="sec" id="sec-sales">
  <div class="sec-tag">Performance</div>
  <div class="sec-hd">
    <div><h2>ğŸ’° Sales Log</h2><p>Every closed deal â€” Monterey County field operations</p></div>
    <div class="sec-actions"><button class="btn btn-success btn-sm" onclick="openSaleModal()">+ Log Sale</button></div>
  </div>
  <div class="g2">
    <div class="card">
      <div class="card-hd"><h3>All Transactions</h3><span class="meta" id="sales-ct">0</span></div>
      <div>
        <div class="empty" id="sales-empty"><div class="empty-icon">ğŸ’°</div><div class="empty-title">No sales yet</div><div class="empty-sub">Log your first sale to start tracking revenue.</div></div>
        <table class="tbl" id="sales-tbl" style="display:none">
          <thead><tr><th>Date</th><th>Customer</th><th>Rep</th><th>Product</th><th>Amount</th></tr></thead>
          <tbody id="sales-body"></tbody>
        </table>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:13px">
      <div class="kpi green"><div class="kpi-lbl">Total Revenue</div><div class="kpi-val" id="sales-rev">$0</div><div class="kpi-sub" id="sales-sub">0 transactions</div></div>
      <div class="card"><div class="card-hd"><h3>Revenue by Rep</h3></div><div class="card-body" id="rep-bars"><div class="empty" style="padding:18px"><div class="empty-sub">Log sales to see data</div></div></div></div>
    </div>
  </div>
</section>

<!-- â”€â”€ LEADERBOARD â”€â”€ -->

<section class="sec" id="sec-lb">
  <div class="sec-tag">Performance</div>
  <div class="sec-hd">
    <div><h2>ğŸ† Leaderboard</h2><p>Live rankings from sales log</p></div>
    <div class="sec-actions">
      <button class="btn btn-primary btn-sm lb-btn" onclick="setLBPeriod('all',this)">All Time</button>
      <button class="btn btn-ghost btn-sm lb-btn" onclick="setLBPeriod('month',this)">This Month</button>
      <button class="btn btn-ghost btn-sm lb-btn" onclick="setLBPeriod('week',this)">This Week</button>
    </div>
  </div>
  <div class="podium" id="lb-podium" style="display:none"></div>
  <div class="card">
    <div class="card-hd"><h3>Full Rankings</h3></div>
    <div class="empty" id="lb-empty"><div class="empty-icon">ğŸ†</div><div class="empty-title">No rankings yet</div><div class="empty-sub">Log sales to see the leaderboard.</div></div>
    <table class="tbl" id="lb-tbl" style="display:none">
      <thead><tr><th>Rank</th><th>Rep</th><th>Territory</th><th>Revenue</th><th>Closes</th><th>Doors</th><th>Rate</th></tr></thead>
      <tbody id="lb-body"></tbody>
    </table>
  </div>
</section>

<!-- â”€â”€ TEAM â”€â”€ -->

<section class="sec" id="sec-team">
  <div class="sec-tag">Performance</div>
  <div class="sec-hd">
    <div><h2>ğŸ‘¥ Team</h2><p>Complete Home â€” Monterey County field representatives</p></div>
    <div class="sec-actions"><button class="btn btn-primary btn-sm" onclick="openRepModal()">+ Add Rep</button></div>
  </div>
  <div class="g4" id="team-grid"></div>
</section>

<!-- â”€â”€ WEATHER â”€â”€ -->

<section class="sec" id="sec-weather">
  <div class="sec-tag">Intelligence</div>
  <div class="sec-hd">
    <div><h2>ğŸŒ¤ Live Weather</h2><p>Salinas / Monterey County, CA â€” wttr.in live data</p></div>
    <div class="sec-actions"><button class="btn btn-ghost btn-sm" onclick="loadWeather(true)">â†» Refresh</button></div>
  </div>
  <div id="wx-alert"></div>
  <div id="wx-body"><div class="load-wrap"><div class="spinner"></div><div class="load-txt">Loading weatherâ€¦</div></div></div>
</section>

<!-- â”€â”€ CRIME â”€â”€ -->

<section class="sec" id="sec-crime">
  <div class="sec-tag">Intelligence</div>
  <div class="sec-hd">
    <div><h2>ğŸš¨ Crime Map</h2><p>Recent incidents â€” Monterey County, CA</p></div>
    <div class="sec-actions"><button class="btn btn-ghost btn-sm" onclick="loadCrime(true)">â†» Refresh</button></div>
  </div>
  <div class="crime-bar" id="crime-bar">ğŸ“¡ Initializing crime data feedâ€¦</div>
  <div id="crime-map-wrap"></div>
  <div class="crime-filters" id="crime-filters" style="display:none">
    <button class="cf-btn active" onclick="filterCrime('all',this)">All Types</button>
    <button class="cf-btn" onclick="filterCrime('theft',this)">Theft</button>
    <button class="cf-btn" onclick="filterCrime('burglary',this)">Burglary</button>
    <button class="cf-btn" onclick="filterCrime('assault',this)">Assault</button>
    <button class="cf-btn" onclick="filterCrime('vandalism',this)">Vandalism</button>
    <button class="cf-btn" onclick="filterCrime('other',this)">Other</button>
  </div>
  <div class="card" id="crime-log" style="display:none">
    <div class="card-hd"><h3>Incident Log</h3><span class="meta" id="crime-ct"></span></div>
    <div id="crime-rows"></div>
  </div>
</section>

<!-- â”€â”€ SERVICE STATUS â”€â”€ -->

<section class="sec" id="sec-status">
  <div class="sec-tag">System</div>
  <div class="sec-hd">
    <div><h2>âš¡ Service Status</h2><p>Connectivity checks for all platform dependencies</p></div>
    <div class="sec-actions"><button class="btn btn-ghost btn-sm" id="check-btn" onclick="runChecks()">â†» Run Checks</button></div>
  </div>
  <div class="ov-banner" id="ov-banner">
    <div class="ov-icon">ğŸ”„</div>
    <div><div class="ov-title">Initializingâ€¦</div><div class="ov-sub" id="ov-sub">Last checked: â€”</div></div>
  </div>
  <div class="svc-grid" id="svc-grid"></div>
  <div class="card"><div class="card-hd"><h3>Check History</h3><span class="meta" id="log-ct"></span></div><div id="status-log"></div></div>
</section>

</div><!-- /page -->

<!-- â•â• MODALS â•â• -->

<div class="modal-backdrop" id="modal-pin">
  <div class="modal">
    <div class="modal-hd"><div class="modal-title">ğŸ“ Lead Details</div><button class="modal-x" onclick="closeModal('modal-pin')">âœ•</button></div>
    <div class="modal-bd">
      <div class="fr"><div class="fg"><label class="fl">First Name</label><input class="fi" id="pin-fname" placeholder="John"></div><div class="fg"><label class="fl">Last Name</label><input class="fi" id="pin-lname" placeholder="Doe"></div></div>
      <div class="fg"><label class="fl">Address</label><input class="fi" id="pin-addr" readonly style="color:var(--t3)"></div>
      <div class="fr"><div class="fg"><label class="fl">Phone</label><input class="fi" id="pin-phone" placeholder="(831) 555-0100"></div><div class="fg"><label class="fl">Status</label><select class="fs" id="pin-status"><option value="nh">Not Home</option><option value="new">New Lead</option><option value="contact">Contacted</option><option value="appt">Appointment Set</option><option value="sold">Sold âœ“</option><option value="no">Not Interested</option></select></div></div>
      <div class="fr"><div class="fg"><label class="fl">Assigned Rep</label><select class="fs" id="pin-rep"></select></div><div class="fg"><label class="fl">Territory</label><select class="fs" id="pin-area"></select></div></div>
      <div class="fg"><label class="fl">Notes</label><textarea class="ft" id="pin-notes" placeholder="Customer notes, objections, follow-up detailsâ€¦"></textarea></div>
    </div>
    <div class="modal-ft"><button class="btn btn-ghost btn-sm" onclick="closeModal('modal-pin')">Cancel</button><button class="btn btn-danger btn-sm" id="pin-del" onclick="deletePin()" style="display:none">Delete</button><button class="btn btn-primary btn-sm" onclick="savePin()">Save Lead</button></div>
  </div>
</div>

<div class="modal-backdrop" id="modal-appt">
  <div class="modal">
    <div class="modal-hd"><div class="modal-title" id="appt-modal-title">ğŸ“… New Appointment</div><button class="modal-x" onclick="closeModal('modal-appt')">âœ•</button></div>
    <div class="modal-bd">
      <div class="fr"><div class="fg"><label class="fl">Customer Name</label><input class="fi" id="appt-cust" placeholder="John Doe"></div><div class="fg"><label class="fl">Phone</label><input class="fi" id="appt-phone" placeholder="(831) 555-0100"></div></div>
      <div class="fg"><label class="fl">Address</label><input class="fi" id="appt-addr" placeholder="Customer address in Monterey County"></div>
      <div class="fr"><div class="fg"><label class="fl">Date</label><input class="fi" type="date" id="appt-date"></div><div class="fg"><label class="fl">Time</label><input class="fi" type="time" id="appt-time"></div></div>
      <div class="fr"><div class="fg"><label class="fl">Type</label><select class="fs" id="appt-type"><option value="demo">Product Demo</option><option value="followup">Follow-up</option><option value="close">Close / Sign</option><option value="visit">Initial Visit</option></select></div><div class="fg"><label class="fl">Assigned Rep</label><select class="fs" id="appt-rep"></select></div></div>
      <div class="fg"><label class="fl">Notes</label><textarea class="ft" id="appt-notes" placeholder="Additional notesâ€¦"></textarea></div>
    </div>
    <div class="modal-ft"><button class="btn btn-ghost btn-sm" onclick="closeModal('modal-appt')">Cancel</button><button class="btn btn-danger btn-sm" id="appt-del" onclick="deleteAppt()" style="display:none">Delete</button><button class="btn btn-primary btn-sm" onclick="saveAppt()">Save</button></div>
  </div>
</div>

<div class="modal-backdrop" id="modal-sale">
  <div class="modal">
    <div class="modal-hd"><div class="modal-title">ğŸ’° Log New Sale</div><button class="modal-x" onclick="closeModal('modal-sale')">âœ•</button></div>
    <div class="modal-bd">
      <div class="fr"><div class="fg"><label class="fl">Customer Name</label><input class="fi" id="sale-cust" placeholder="Full name"></div><div class="fg"><label class="fl">Sale Date</label><input class="fi" type="date" id="sale-date"></div></div>
      <div class="fg"><label class="fl">Address</label><input class="fi" id="sale-addr" placeholder="Customer address"></div>
      <div class="fr"><div class="fg"><label class="fl">Product / Package</label><select class="fs" id="sale-product"><option>Solar Basic (5kW)</option><option>Solar Plus (8kW)</option><option>Solar Premium (12kW)</option><option>Home Security Basic</option><option>Home Security Premium</option><option>Internet Package A</option><option>Internet Package B</option><option>Custom Package</option></select></div><div class="fg"><label class="fl">Amount ($)</label><input class="fi" type="number" id="sale-amount" placeholder="5000" min="0"></div></div>
      <div class="fr"><div class="fg"><label class="fl">Sales Rep</label><select class="fs" id="sale-rep"></select></div><div class="fg"><label class="fl">Territory</label><select class="fs" id="sale-area"></select></div></div>
    </div>
    <div class="modal-ft"><button class="btn btn-ghost btn-sm" onclick="closeModal('modal-sale')">Cancel</button><button class="btn btn-success btn-sm" onclick="saveSale()">Log Sale</button></div>
  </div>
</div>

<div class="modal-backdrop" id="modal-area">
  <div class="modal">
    <div class="modal-hd"><div class="modal-title">ğŸ—º Add Territory</div><button class="modal-x" onclick="closeModal('modal-area')">âœ•</button></div>
    <div class="modal-bd">
      <div class="fr"><div class="fg"><label class="fl">Territory Name</label><input class="fi" id="area-name" placeholder="e.g. North Salinas"></div><div class="fg"><label class="fl">ZIP Code</label><input class="fi" id="area-zip" placeholder="93901"></div></div>
      <div class="fg"><label class="fl">Assigned Rep</label><select class="fs" id="area-rep"></select></div>
      <div class="fg"><label class="fl">Notes</label><textarea class="ft" id="area-notes" placeholder="Neighborhood type, density, notesâ€¦"></textarea></div>
    </div>
    <div class="modal-ft"><button class="btn btn-ghost btn-sm" onclick="closeModal('modal-area')">Cancel</button><button class="btn btn-primary btn-sm" onclick="saveArea()">Create Territory</button></div>
  </div>
</div>

<div class="modal-backdrop" id="modal-rep">
  <div class="modal">
    <div class="modal-hd"><div class="modal-title">ğŸ‘¤ Add Team Member</div><button class="modal-x" onclick="closeModal('modal-rep')">âœ•</button></div>
    <div class="modal-bd">
      <div class="fr"><div class="fg"><label class="fl">First Name</label><input class="fi" id="rep-fname" placeholder="First"></div><div class="fg"><label class="fl">Last Name</label><input class="fi" id="rep-lname" placeholder="Last"></div></div>
      <div class="fr"><div class="fg"><label class="fl">Role</label><select class="fs" id="rep-role"><option value="rep">Sales Rep</option><option value="manager">Manager</option></select></div><div class="fg"><label class="fl">Phone</label><input class="fi" id="rep-phone" placeholder="(831) 555-0100"></div></div>
      <div class="fg"><label class="fl">Territory</label><select class="fs" id="rep-area"></select></div>
    </div>
    <div class="modal-ft"><button class="btn btn-ghost btn-sm" onclick="closeModal('modal-rep')">Cancel</button><button class="btn btn-primary btn-sm" onclick="saveRep()">Add Member</button></div>
  </div>
</div>

<div id="toasts"></div>

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSISTENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STORE_KEY='completehome_v1';
function saveAll(){
  try{localStorage.setItem(STORE_KEY,JSON.stringify({pins:DB.pins,appts:DB.appts,sales:DB.sales,areas:DB.areas,reps:DB.reps,ids:IDs,actLog}));}
  catch(e){console.warn('save fail',e);}
}
function loadAll(){
  try{
    const raw=localStorage.getItem(STORE_KEY);
    if(!raw)return;
    const s=JSON.parse(raw);
    if(s.pins)DB.pins=s.pins;if(s.appts)DB.appts=s.appts;
    if(s.sales)DB.sales=s.sales;if(s.areas)DB.areas=s.areas;
    if(s.reps)DB.reps=s.reps;if(s.ids)Object.assign(IDs,s.ids);
    if(s.actLog)actLog=s.actLog;
  }catch(e){console.warn('load fail',e);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB={
  pins:[],appts:[],sales:[],areas:[],
  reps:[
    {id:1,fname:'Darrell',lname:'',role:'CEO',phone:'',areaId:'',color:'#2563eb'},
    {id:2,fname:'King',lname:'Cannon',role:'manager',phone:'',areaId:'',color:'#8b5cf6'},
    {id:3,fname:'Shafik',lname:'Elafrangi',role:'manager',phone:'',areaId:'',color:'#f59e0b'},
    {id:4,fname:'Sly',lname:'Walker',role:'manager',phone:'',areaId:'',color:'#06b6d4'}
  ]
};
const IDs={pin:1,appt:1,sale:1,area:1,rep:5};
const AREA_COLORS=['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#ec4899'];
const PIN_COLORS={nh:'#475569',new:'#3b82f6',contact:'#f59e0b',appt:'#8b5cf6',sold:'#10b981',no:'#ef4444'};
let actLog=[];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $=id=>document.getElementById(id);
const iso=()=>new Date().toISOString().slice(0,10);
const rName=id=>{const r=DB.reps.find(x=>x.id==id);return r?`${r.fname} ${r.lname}`.trim():'â€”';};
const rObj=id=>DB.reps.find(x=>x.id==id);
const fmtAmt=n=>'$'+(+n||0).toLocaleString();
const fmtT=t=>{if(!t)return'';const[h,m]=t.split(':');const hr=+h;return`${hr>12?hr-12:hr||12}:${m} ${hr>=12?'PM':'AM'}`;};
const inits=r=>r?(r.fname[0]||'')+(r.lname[0]||''):'?';
const ago=ts=>{const s=Math.floor((Date.now()-ts)/1000);if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';};

function toast(msg,type='info'){
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.innerHTML=`<span>${{success:'âœ…',error:'âŒ',info:'â„¹ï¸'}[type]}</span><span>${msg}</span>`;
  $('toasts').appendChild(el);
  setTimeout(()=>{el.style.opacity='0';el.style.transform='translateX(14px)';el.style.transition='all .3s';setTimeout(()=>el.remove(),300);},3500);
}
function openModal(id){$(id).classList.add('open');}
function closeModal(id){$(id).classList.remove('open');}
document.querySelectorAll('.modal-backdrop').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));

function populateRepSelect(id){
  const el=$(id);if(!el)return;const prev=el.value;
  el.innerHTML='<option value="">Select repâ€¦</option>'+DB.reps.map(r=>`<option value="${r.id}">${`${r.fname} ${r.lname}`.trim()} (${r.role})</option>`).join('');
  el.value=prev;
}
function populateAreaSelect(id){
  const el=$(id);if(!el)return;const prev=el.value;
  el.innerHTML='<option value="">No territory</option>'+DB.areas.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  el.value=prev;
}
function refreshSelects(){
  ['pin-rep','appt-rep','sale-rep','area-rep','rep-area'].forEach(populateRepSelect);
  ['pin-area','sale-area'].forEach(populateAreaSelect);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCROLL NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function scrollSec(id){
  const el=$(id);if(!el)return;
  const y=el.getBoundingClientRect().top+window.scrollY-parseInt(getComputedStyle(document.documentElement).getPropertyValue('--nav-h'))-4;
  window.scrollTo({top:y,behavior:'smooth'});
}
function setupScrollSpy(){
  const sections=document.querySelectorAll('section[id]');
  const navBtns=document.querySelectorAll('.nav-a');
  const ids=[...sections].map(s=>s.id);
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        navBtns.forEach(b=>b.classList.remove('active'));
        const fn=`scrollSec('${e.target.id}')`;
        const btn=[...navBtns].find(b=>b.getAttribute('onclick')===fn);
        if(btn)btn.classList.add('active');
      }
    });
  },{threshold:0.2,rootMargin:`-${56}px 0px -50% 0px`});
  sections.forEach(s=>obs.observe(s));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateDash(){
  const pins=DB.pins.length;
  const sold=DB.pins.filter(p=>p.status==='sold').length;
  const rev=DB.sales.reduce((s,x)=>s+(+x.amount||0),0);
  const appts=DB.appts.length;
  $('db-pins').textContent=pins.toLocaleString();
  $('db-rev').textContent=fmtAmt(rev);
  $('db-appts').textContent=appts;
  $('db-rate').textContent=pins>0?(sold/pins*100).toFixed(1)+'%':'0%';
  const ac=$('db-activity');
  if(!actLog.length){
    ac.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">No activity yet</div><div class="empty-sub">Pins, sales, and appointments appear here.</div></div>';
  }else{
    ac.innerHTML=actLog.slice(0,8).map(a=>`<div class="act-item"><div class="act-icon" style="background:${a.bg}">${a.icon}</div><div style="flex:1;min-width:0"><div class="act-title">${a.title}</div><div class="act-sub">${a.sub}</div></div><div class="act-time">${ago(a.ts)}</div></div>`).join('');
  }
  const today=iso();
  const todayA=DB.appts.filter(a=>a.date===today).sort((a,b)=>a.time.localeCompare(b.time));
  $('db-today').innerHTML=!todayA.length
    ?'<div class="empty" style="padding:28px"><div class="empty-icon">ğŸ“…</div><div class="empty-title">No appointments today</div></div>'
    :todayA.map(a=>`<div class="appt-item"><div class="appt-time">${fmtT(a.time)}</div><div class="appt-name">${a.cust}</div><div class="appt-det">${a.addr}</div><div class="appt-det">${rName(a.rep)}</div></div>`).join('');
}
function logAct(icon,title,sub,bg){
  actLog.unshift({icon,title,sub,bg,ts:Date.now()});
  if(actLog.length>40)actLog.pop();
  saveAll();updateDash();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAP  (centered on Monterey County)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Monterey County center: 36.6002, -121.8947  zoom 11
let lmap=null,mapTool='pin',mapMkrs={},activePinId=null;
let lassoPoints=[],lassoLG=null,mapInitialized=false;

function mkIcon(status){
  const c=PIN_COLORS[status]||'#475569';
  return L.divIcon({
    html:`<div style="width:13px;height:13px;border-radius:50%;background:${c};border:2px solid rgba(255,255,255,.3);box-shadow:0 2px 6px rgba(0,0,0,.5),0 0 8px ${c}66"></div>`,
    className:'',iconSize:[13,13],iconAnchor:[6,6]
  });
}
function initMap(){
  if(mapInitialized){if(lmap)lmap.invalidateSize();return;}
  mapInitialized=true;
  lmap=L.map('leaflet-map',{center:[36.6002,-121.8947],zoom:11});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap',maxZoom:20}).addTo(lmap);
  lassoLG=L.layerGroup().addTo(lmap);
  lmap.on('click',onMapClick);
  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'&&mapTool==='lasso')cancelLasso();
    if(e.key==='Enter'&&mapTool==='lasso'&&lassoPoints.length>=3)finishLasso();
  });
  DB.pins.forEach(pin=>placeMarker(pin));
  updateMapUI();
}
function setMapTool(t,btn){
  mapTool=t;
  document.querySelectorAll('.map-tool').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  if(lmap)lmap.getContainer().style.cursor=t==='lasso'?'crosshair':'';
  if(t==='lasso'){
    $('lasso-hint').style.display='block';
    $('lasso-hint').textContent='Click to add points â€” Enter to finish Â· Esc to cancel';
  }else{
    lassoPoints=[];
    if(lassoLG)lassoLG.clearLayers();
    $('lasso-hint').style.display='none';
  }
}
function onMapClick(e){
  if(mapTool==='pin')dropPin(e.latlng);
  else if(mapTool==='lasso')addLassoPoint(e.latlng);
}
function dropPin(ll){
  const pin={id:IDs.pin++,lat:ll.lat,lng:ll.lng,addr:`${ll.lat.toFixed(5)}, ${ll.lng.toFixed(5)}`,fname:'',lname:'',phone:'',status:'new',rep:'',areaId:'',notes:''};
  DB.pins.push(pin);placeMarker(pin);saveAll();updateMapUI();
  logAct('ğŸ“','Pin dropped',pin.addr,'var(--bg2)');
  openPinModal(pin.id);
}
function placeMarker(pin){
  const m=L.marker([pin.lat,pin.lng],{icon:mkIcon(pin.status),draggable:true}).addTo(lmap);
  m.on('click',()=>openPinModal(pin.id));
  m.on('dragend',e=>{const ll=e.target.getLatLng();pin.lat=ll.lat;pin.lng=ll.lng;saveAll();});
  mapMkrs[pin.id]=m;
}
function updateMapUI(){
  const total=DB.pins.length;
  const sold=DB.pins.filter(p=>p.status==='sold').length;
  const appt=DB.pins.filter(p=>p.status==='appt').length;
  const nh=DB.pins.filter(p=>p.status==='nh').length;
  $('ms-total').textContent=total;$('ms-sold').textContent=sold;$('ms-appt').textContent=appt;$('ms-nh').textContent=nh;
  $('map-ct').textContent=total+' pin'+(total!==1?'s':'');
  const pl=$('pin-list');
  if(!DB.pins.length){
    pl.innerHTML='<div class="empty" style="padding:28px 10px"><div class="empty-icon" style="font-size:20px">ğŸ“</div><div class="empty-title" style="font-size:12px">No pins yet</div><div class="empty-sub" style="font-size:11px">Click the map to drop a pin, or use Lasso to auto-fill a neighborhood.</div></div>';
    return;
  }
  const bc={nh:'b-gray',new:'b-blue',contact:'b-amber',appt:'b-violet',sold:'b-green',no:'b-red'};
  pl.innerHTML=[...DB.pins].reverse().map(p=>{
    const name=(p.fname||p.lname)?`${p.fname} ${p.lname}`.trim():'Unnamed';
    return `<div class="pin-row" onclick="openPinModal(${p.id})"><div class="pin-dot" style="background:${PIN_COLORS[p.status]||'#475569'}"></div><div style="flex:1;min-width:0"><div class="pin-name">${name}</div><div class="pin-addr">${p.addr}</div></div><span class="badge ${bc[p.status]||'b-gray'}" style="font-size:8px;padding:2px 6px">${p.status==='nh'?'N/H':p.status}</span></div>`;
  }).join('');
}

/* Lasso */
function addLassoPoint(ll){
  lassoPoints.push(ll);lassoLG.clearLayers();
  if(lassoPoints.length===1){
    L.circleMarker(ll,{radius:6,color:'#3b82f6',fillColor:'#3b82f6',fillOpacity:1,weight:2}).addTo(lassoLG);
    $('lasso-hint').textContent='First point set â€” keep clicking to draw your area';
  }else{
    L.polygon(lassoPoints,{color:'#3b82f6',fillColor:'#3b82f6',fillOpacity:.07,weight:2,dashArray:'6,4'}).addTo(lassoLG);
    lassoPoints.forEach((pt,i)=>L.circleMarker(pt,{radius:i===0?6:3,color:'#3b82f6',fillColor:i===0?'#3b82f6':'#f1f5f9',fillOpacity:1,weight:2}).addTo(lassoLG));
    $('lasso-hint').textContent=`${lassoPoints.length} points â€” Enter to generate pins Â· Esc to cancel`;
  }
}
function cancelLasso(){
  lassoPoints=[];if(lassoLG)lassoLG.clearLayers();
  $('lasso-hint').style.display='none';mapTool='pin';
  document.querySelectorAll('.map-tool').forEach(b=>b.classList.remove('active'));
  const pb=$('tool-pin');if(pb)pb.classList.add('active');
  if(lmap)lmap.getContainer().style.cursor='';
}
async function finishLasso(){
  if(lassoPoints.length<3){toast('Draw at least 3 points first','error');return;}
  $('lasso-hint').style.display='none';
  const loader=$('map-loader');loader.classList.add('show');
  $('map-loader-msg').textContent='Querying OpenStreetMap for buildingsâ€¦';
  const lats=lassoPoints.map(p=>p.lat),lngs=lassoPoints.map(p=>p.lng);
  const south=Math.min(...lats)-.001,north=Math.max(...lats)+.001;
  const west=Math.min(...lngs)-.001,east=Math.max(...lngs)+.001;
  const query=`[out:json][timeout:25];(node["addr:housenumber"](${south},${west},${north},${east});way["building"](${south},${west},${north},${east}););out center;`;
  let added=0;
  try{
    const res=await fetch('https://overpass-api.de/api/interpreter?data='+encodeURIComponent(query));
    if(!res.ok)throw new Error('Overpass '+res.status);
    const data=await res.json();
    $('map-loader-msg').textContent=`Found ${data.elements.length} buildings â€” placing pinsâ€¦`;
    for(const el of data.elements){
      const lat=el.type==='node'?el.lat:el.center?.lat;
      const lng=el.type==='node'?el.lon:el.center?.lon;
      if(!lat||!lng||!ptInPoly({lat,lng},lassoPoints))continue;
      const hn=el.tags?.['addr:housenumber']||'',st=el.tags?.['addr:street']||'';
      const addr=hn&&st?`${hn} ${st}`:`${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      const pin={id:IDs.pin++,lat,lng,addr,fname:'',lname:'',phone:'',status:'nh',rep:'',areaId:'',notes:''};
      DB.pins.push(pin);placeMarker(pin);added++;
    }
    if(!added){
      $('map-loader-msg').textContent='No OSM data â€” using grid estimateâ€¦';
      await new Promise(r=>setTimeout(r,600));
      for(const g of gridInPoly(lassoPoints)){
        const pin={id:IDs.pin++,...g,fname:'',lname:'',phone:'',status:'nh',rep:'',areaId:'',notes:''};
        DB.pins.push(pin);placeMarker(pin);added++;
      }
    }
    saveAll();
    toast(`âœ“ ${added} pins generated from lasso area`,'success');
    logAct('âœï¸','Lasso area scanned',`${added} house pins created`,'rgba(16,185,129,.15)');
  }catch(err){toast('Could not fetch building data â€” check connection','error');}
  finally{loader.classList.remove('show');cancelLasso();updateMapUI();updateDash();}
}
function ptInPoly(pt,poly){
  let inside=false;
  for(let i=0,j=poly.length-1;i<poly.length;j=i++){
    const xi=poly[i].lat,yi=poly[i].lng,xj=poly[j].lat,yj=poly[j].lng;
    if(((yi>pt.lng)!==(yj>pt.lng))&&(pt.lat<(xj-xi)*(pt.lng-yi)/(yj-yi)+xi))inside=!inside;
  }
  return inside;
}
function gridInPoly(poly){
  const lats=poly.map(p=>p.lat),lngs=poly.map(p=>p.lng);
  const s=Math.min(...lats),n=Math.max(...lats),w=Math.min(...lngs),e=Math.max(...lngs);
  const step=.00045,pts=[];
  for(let lat=s;lat<=n;lat+=step)for(let lng=w;lng<=e;lng+=step)
    if(ptInPoly({lat,lng},poly))pts.push({lat,lng,addr:`${lat.toFixed(5)}, ${lng.toFixed(5)}`});
  return pts.slice(0,200);
}
function clearPins(){
  if(!DB.pins.length)return;
  if(!confirm(`Remove all ${DB.pins.length} pins?`))return;
  Object.values(mapMkrs).forEach(m=>lmap.removeLayer(m));
  mapMkrs={};DB.pins=[];saveAll();updateMapUI();updateDash();
  toast('All pins cleared','info');
}

/* Pin modal */
function openPinModal(id){
  const pin=DB.pins.find(p=>p.id===id);if(!pin)return;
  activePinId=id;refreshSelects();
  $('pin-fname').value=pin.fname||'';$('pin-lname').value=pin.lname||'';
  $('pin-addr').value=pin.addr||'';$('pin-phone').value=pin.phone||'';
  $('pin-status').value=pin.status||'nh';$('pin-rep').value=pin.rep||'';
  $('pin-area').value=pin.areaId||'';$('pin-notes').value=pin.notes||'';
  $('pin-del').style.display='inline-flex';
  openModal('modal-pin');
}
function savePin(){
  const pin=DB.pins.find(p=>p.id===activePinId);if(!pin)return;
  pin.fname=$('pin-fname').value.trim();pin.lname=$('pin-lname').value.trim();
  pin.phone=$('pin-phone').value.trim();pin.status=$('pin-status').value;
  pin.rep=$('pin-rep').value;pin.areaId=$('pin-area').value;
  pin.notes=$('pin-notes').value.trim();
  if(mapMkrs[pin.id])mapMkrs[pin.id].setIcon(mkIcon(pin.status));
  saveAll();updateMapUI();updateDash();
  toast('Lead saved','success');closeModal('modal-pin');
}
function deletePin(){
  if(!confirm('Delete this pin permanently?'))return;
  if(mapMkrs[activePinId]){lmap.removeLayer(mapMkrs[activePinId]);delete mapMkrs[activePinId];}
  DB.pins=DB.pins.filter(p=>p.id!==activePinId);
  activePinId=null;saveAll();updateMapUI();updateDash();
  closeModal('modal-pin');toast('Pin deleted','info');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let calDate=new Date(),editApptId=null;
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
function renderCal(){
  const y=calDate.getFullYear(),m=calDate.getMonth();
  $('cal-lbl').textContent=`${MONTHS[m].slice(0,3).toUpperCase()} ${y}`;
  $('cal-hd').innerHTML=DAYS.map(d=>`<div class="cal-dh">${d}</div>`).join('');
  const firstDay=new Date(y,m,1).getDay(),dim=new Date(y,m+1,0).getDate();
  const prevDim=new Date(y,m,0).getDate(),today=new Date();
  const cells=[];
  for(let i=firstDay-1;i>=0;i--)cells.push({d:prevDim-i,other:true});
  for(let i=1;i<=dim;i++)cells.push({d:i,other:false});
  while(cells.length%7!==0)cells.push({d:cells.length-firstDay-dim+1,other:true});
  $('cal-grid').innerHTML=cells.map(c=>{
    const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(c.d).padStart(2,'0')}`;
    const da=c.other?[]:DB.appts.filter(a=>a.date===ds);
    const isToday=!c.other&&today.getDate()===c.d&&today.getMonth()===m&&today.getFullYear()===y;
    const cls='cal-cell'+(c.other?' other':'')+(isToday?' today':'');
    const dbl=c.other?'':`ondblclick="openApptModal('${ds}')"`;
    return `<div class="${cls}" ${dbl}><div class="cal-dn">${c.d}</div>${da.slice(0,3).map(a=>`<span class="cal-pill ap-${a.type}">${fmtT(a.time)} ${a.cust}</span>`).join('')}${da.length>3?`<span style="font-size:9px;color:var(--t3);font-family:var(--mono)">+${da.length-3} more</span>`:''}</div>`;
  }).join('');
  const now=new Date();
  const up=DB.appts.filter(a=>new Date(a.date+'T'+a.time)>=now).sort((a,b)=>new Date(a.date+'T'+a.time)-new Date(b.date+'T'+b.time)).slice(0,10);
  $('appt-list').innerHTML=!up.length
    ?'<div class="empty" style="padding:28px"><div class="empty-icon" style="font-size:22px">ğŸ“…</div><div class="empty-title" style="font-size:12px">No upcoming appointments</div></div>'
    :up.map(a=>`<div class="appt-item" onclick="openApptModal(null,${a.id})"><div class="appt-time">${a.date} Â· ${fmtT(a.time)}</div><div class="appt-name">${a.cust}</div><div class="appt-det">${a.addr}</div><div class="appt-det">${rName(a.rep)}</div></div>`).join('');
}
function calNav(d){calDate.setMonth(calDate.getMonth()+d);renderCal();}
function openApptModal(date,editId=null){
  refreshSelects();editApptId=editId;
  $('appt-modal-title').textContent=editId?'ğŸ“… Edit Appointment':'ğŸ“… New Appointment';
  $('appt-del').style.display=editId?'inline-flex':'none';
  if(editId){
    const a=DB.appts.find(x=>x.id===editId);if(!a)return;
    $('appt-cust').value=a.cust;$('appt-phone').value=a.phone;$('appt-addr').value=a.addr;
    $('appt-date').value=a.date;$('appt-time').value=a.time;$('appt-type').value=a.type;
    $('appt-rep').value=a.rep;$('appt-notes').value=a.notes;
  }else{
    $('appt-cust').value='';$('appt-phone').value='';$('appt-addr').value='';
    $('appt-date').value=date||iso();$('appt-time').value='10:00';
    $('appt-type').value='demo';$('appt-rep').value='';$('appt-notes').value='';
  }
  openModal('modal-appt');
}
function saveAppt(){
  const cust=$('appt-cust').value.trim(),date=$('appt-date').value;
  if(!cust||!date){toast('Name and date required','error');return;}
  const obj={cust,phone:$('appt-phone').value,addr:$('appt-addr').value,date,time:$('appt-time').value,type:$('appt-type').value,rep:$('appt-rep').value,notes:$('appt-notes').value};
  if(editApptId){
    Object.assign(DB.appts.find(a=>a.id===editApptId),obj);
    toast('Appointment updated','success');
  }else{
    DB.appts.push({id:IDs.appt++,...obj});
    logAct('ğŸ“…',`Appt: ${cust}`,`${date} ${fmtT(obj.time)}`,'rgba(139,92,246,.15)');
    toast('Appointment scheduled','success');
  }
  saveAll();renderCal();updateDash();closeModal('modal-appt');
}
function deleteAppt(){
  if(!confirm('Delete this appointment?'))return;
  DB.appts=DB.appts.filter(a=>a.id!==editApptId);
  editApptId=null;saveAll();renderCal();updateDash();
  closeModal('modal-appt');toast('Appointment deleted','info');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SALES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSales(){
  const total=DB.sales.reduce((s,x)=>s+(+x.amount||0),0);
  $('sales-rev').textContent=fmtAmt(total);
  $('sales-sub').textContent=DB.sales.length+' transaction'+(DB.sales.length!==1?'s':'')+' logged';
  $('sales-ct').textContent=DB.sales.length+' transactions';
  const empty=$('sales-empty'),tbl=$('sales-tbl');
  if(!DB.sales.length){empty.style.display='flex';tbl.style.display='none';}
  else{
    empty.style.display='none';tbl.style.display='table';
    $('sales-body').innerHTML=[...DB.sales].reverse().map(s=>`<tr><td class="mono">${s.date}</td><td class="pri">${s.cust}</td><td>${rName(s.rep)}</td><td>${s.product}</td><td class="money">${fmtAmt(s.amount)}</td></tr>`).join('');
  }
  const rt={};
  DB.sales.forEach(s=>{if(!s.rep)return;if(!rt[s.rep])rt[s.rep]=0;rt[s.rep]+=(+s.amount||0);});
  const sorted=Object.entries(rt).sort((a,b)=>b[1]-a[1]);
  const maxAmt=sorted[0]?sorted[0][1]:1;
  const barCols=['#2563eb','#10b981','#f59e0b','#8b5cf6','#06b6d4','#ef4444'];
  $('rep-bars').innerHTML=!sorted.length
    ?'<div class="empty" style="padding:18px"><div class="empty-sub">Log sales to see data</div></div>'
    :sorted.map(([rid,amt],i)=>`<div class="rep-bar-wrap"><div class="rep-bar-name">${rName(rid).split(' ')[0]}</div><div class="rep-bar-track"><div class="rep-bar-fill" style="width:${Math.round(amt/maxAmt*100)}%;background:${barCols[i%6]}"><span>${fmtAmt(amt)}</span></div></div></div>`).join('');
}
function openSaleModal(){
  refreshSelects();
  $('sale-cust').value='';$('sale-date').value=iso();$('sale-addr').value='';
  $('sale-amount').value='';$('sale-rep').value='';$('sale-area').value='';
  openModal('modal-sale');
}
function saveSale(){
  const cust=$('sale-cust').value.trim(),amt=parseFloat($('sale-amount').value)||0;
  if(!cust||amt<=0){toast('Customer name and valid amount required','error');return;}
  const s={id:IDs.sale++,cust,date:$('sale-date').value,addr:$('sale-addr').value,product:$('sale-product').value,amount:amt,rep:$('sale-rep').value,areaId:$('sale-area').value};
  DB.sales.push(s);
  logAct('ğŸ’°',`Sale closed: ${cust}`,fmtAmt(amt),'rgba(16,185,129,.15)');
  saveAll();renderSales();renderLeaderboard();updateDash();
  closeModal('modal-sale');toast('Sale logged â€” '+fmtAmt(amt),'success');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEADERBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lbPeriod='all';
function setLBPeriod(p,btn){
  lbPeriod=p;
  document.querySelectorAll('.lb-btn').forEach(b=>{b.classList.remove('btn-primary');b.classList.add('btn-ghost');});
  btn.classList.remove('btn-ghost');btn.classList.add('btn-primary');
  renderLeaderboard();
}
function renderLeaderboard(){
  const now=new Date(),wk=new Date(now-7*86400000),mo=new Date(now.getFullYear(),now.getMonth(),1);
  const filt=DB.sales.filter(s=>{
    if(lbPeriod==='week')return new Date(s.date)>=wk;
    if(lbPeriod==='month')return new Date(s.date)>=mo;
    return true;
  });
  const rd={};
  filt.forEach(s=>{const k=s.rep||'none';if(!rd[k])rd[k]={rid:s.rep,amt:0,closes:0};rd[k].amt+=(+s.amount||0);rd[k].closes++;});
  const sorted=Object.values(rd).sort((a,b)=>b.amt-a.amt);
  const maxAmt=sorted[0]?.amt||1;
  $('lb-empty').style.display=sorted.length?'none':'flex';
  $('lb-tbl').style.display=sorted.length?'table':'none';
  const podium=$('lb-podium');
  if(sorted.length>=1){
    podium.style.display='grid';
    podium.innerHTML=sorted.slice(0,3).map((d,i)=>{
      const rep=rObj(d.rid),color=rep?.color||'#2563eb';
      const doors=DB.pins.filter(p=>p.rep==d.rid).length;
      const medals=['gold','silver','bronze'],icons=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
      return `<div class="pod-card ${medals[i]}"><div class="pod-medal">${icons[i]}</div><div class="pod-av" style="background:${color}22;color:${color};border-color:${color}44">${rep?inits(rep):'?'}</div><div class="pod-name">${rep?`${rep.fname} ${rep.lname}`.trim():'Unknown'}</div><div class="pod-area">${rep?.areaId?DB.areas.find(a=>a.id==rep.areaId)?.name||'â€”':'â€”'}</div><div class="pod-amt">${fmtAmt(d.amt)}</div><div class="pod-meta">${d.closes} close${d.closes!==1?'s':''} Â· ${doors} doors</div></div>`;
    }).join('');
  }else{podium.style.display='none';}
  const rankCls=['b-amber','b-gray','b-violet'];
  $('lb-body').innerHTML=sorted.map((d,i)=>{
    const rep=rObj(d.rid),color=rep?.color||'#475569';
    const doors=DB.pins.filter(p=>p.rep==d.rid).length;
    const rate=doors>0?(d.closes/doors*100).toFixed(1)+'%':'â€”';
    return `<tr><td><span class="badge ${rankCls[i]||'b-gray'}" style="font-size:11px;font-weight:800">${i+1}</span></td><td><div style="display:flex;align-items:center;gap:8px"><div style="width:30px;height:30px;border-radius:8px;background:${color}22;color:${color};border:1px solid ${color}44;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0">${rep?inits(rep):'?'}</div><span class="pri">${rep?`${rep.fname} ${rep.lname}`.trim():'Unknown'}</span></div></td><td class="mono">${rep?.areaId?DB.areas.find(a=>a.id==rep.areaId)?.name||'â€”':'â€”'}</td><td><div style="font-size:15px;font-weight:800;color:var(--green)">${fmtAmt(d.amt)}</div><div style="height:2px;background:var(--elev);border-radius:2px;margin-top:3px;width:80px"><div style="height:100%;width:${Math.round(d.amt/maxAmt*100)}%;background:${color};border-radius:2px"></div></div></td><td style="font-size:14px;font-weight:700;color:var(--bl);font-family:var(--mono)">${d.closes}</td><td class="mono">${doors}</td><td class="mono">${rate}</td></tr>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AREAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAreas(){
  const g=$('areas-grid');
  if(!DB.areas.length){
    g.innerHTML='<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ—º</div><div class="empty-title">No territories yet</div><div class="empty-sub">Add territories to organize canvassing across Monterey County.</div></div>';
    return;
  }
  g.innerHTML=DB.areas.map(a=>{
    const rep=rObj(a.repId);
    const pins=DB.pins.filter(p=>p.areaId==a.id).length;
    const sold=DB.pins.filter(p=>p.areaId==a.id&&p.status==='sold').length;
    const rate=pins>0?(sold/pins*100).toFixed(1):0;
    return `<div class="area-card"><div class="area-stripe" style="background:${a.color}"></div><div class="area-name">${a.name}</div><div class="area-meta">ZIP: ${a.zip||'â€”'} Â· ${rep?`${rep.fname} ${rep.lname}`.trim():'Unassigned'}</div><div class="area-stats"><div><div class="area-sv" style="color:${a.color}">${pins}</div><div class="area-sl">Doors</div></div><div><div class="area-sv" style="color:var(--green)">${sold}</div><div class="area-sl">Sold</div></div><div><div class="area-sv" style="color:var(--t3)">${rate}%</div><div class="area-sl">Rate</div></div></div><div class="area-prog"><div class="area-prog-fill" style="width:${Math.min(100,+rate*4)}%;background:${a.color}"></div></div>${a.notes?`<div class="area-note">${a.notes}</div>`:''}</div>`;
  }).join('');
}
function openAreaModal(){refreshSelects();$('area-name').value='';$('area-zip').value='';$('area-rep').value='';$('area-notes').value='';openModal('modal-area');}
function saveArea(){
  if(!$('area-name').value.trim()){toast('Area name required','error');return;}
  const a={id:IDs.area++,name:$('area-name').value.trim(),zip:$('area-zip').value.trim(),repId:$('area-rep').value,notes:$('area-notes').value.trim(),color:AREA_COLORS[DB.areas.length%AREA_COLORS.length]};
  DB.areas.push(a);saveAll();refreshSelects();renderAreas();
  closeModal('modal-area');toast('Territory created','success');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTeam(){
  $('team-grid').innerHTML=DB.reps.map(r=>{
    const rev=DB.sales.filter(s=>s.rep==r.id).reduce((t,s)=>t+(+s.amount||0),0);
    const leads=DB.pins.filter(p=>p.rep==r.id).length;
    const appts=DB.appts.filter(a=>a.rep==r.id).length;
    const areaName=r.areaId?DB.areas.find(a=>a.id==r.areaId)?.name:'â€”';
    return `<div class="team-card"><div class="team-top"><div class="team-av" style="background:${r.color}1a;color:${r.color};border-color:${r.color}33">${inits(r)}</div><div><div class="team-name">${`${r.fname} ${r.lname}`.trim()}</div><div class="team-role">${r.role}</div><div class="team-area-lbl">${areaName||'No territory'}</div></div></div><div class="team-metrics"><div><div class="tm-val" style="color:var(--green)">${rev>0?fmtAmt(rev):'$0'}</div><div class="tm-lbl">Revenue</div></div><div><div class="tm-val" style="color:var(--bl)">${leads}</div><div class="tm-lbl">Leads</div></div><div><div class="tm-val" style="color:var(--violet)">${appts}</div><div class="tm-lbl">Appts</div></div></div></div>`;
  }).join('');
}
function openRepModal(){refreshSelects();$('rep-fname').value='';$('rep-lname').value='';$('rep-role').value='rep';$('rep-phone').value='';$('rep-area').value='';openModal('modal-rep');}
function saveRep(){
  if(!$('rep-fname').value.trim()||!$('rep-lname').value.trim()){toast('First and last name required','error');return;}
  const r={id:IDs.rep++,fname:$('rep-fname').value.trim(),lname:$('rep-lname').value.trim(),role:$('rep-role').value,phone:$('rep-phone').value.trim(),areaId:$('rep-area').value,color:AREA_COLORS[DB.reps.length%AREA_COLORS.length]};
  DB.reps.push(r);saveAll();refreshSelects();renderTeam();
  closeModal('modal-rep');toast(`${r.fname} ${r.lname} added to team`,'success');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEATHER  (Monterey County / Salinas)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let wxLoaded=false;
const WX_ICONS={113:'â˜€ï¸',116:'â›…',119:'â˜ï¸',122:'ğŸŒ«',143:'ğŸŒ«',176:'ğŸŒ¦',179:'ğŸŒ¨',182:'ğŸŒ§',185:'ğŸŒ§',200:'â›ˆ',263:'ğŸŒ¦',266:'ğŸŒ§',281:'ğŸŒ§',284:'ğŸŒ§',293:'ğŸŒ¦',296:'ğŸŒ§',299:'ğŸŒ§',302:'ğŸŒ§',305:'ğŸŒ§',308:'ğŸŒ§',317:'ğŸŒ§',320:'ğŸŒ¨',323:'ğŸŒ¨',326:'ğŸŒ¨',329:'â„ï¸',332:'â„ï¸',335:'â„ï¸',338:'â„ï¸',353:'ğŸŒ¦',356:'ğŸŒ§',359:'ğŸŒ§',362:'ğŸŒ¨',365:'ğŸŒ¨',368:'ğŸŒ¨',386:'â›ˆ',389:'â›ˆ',392:'â›ˆ',395:'â„ï¸'};
const wxIcon=c=>WX_ICONS[+c]||'ğŸŒ¡';
async function loadWeather(force=false){
  if(wxLoaded&&!force)return;
  $('wx-body').innerHTML='<div class="load-wrap"><div class="spinner"></div><div class="load-txt">Fetching live weatherâ€¦</div></div>';
  $('wx-alert').innerHTML='';
  try{
    const res=await fetch('https://wttr.in/Salinas,CA?format=j1');
    if(!res.ok)throw new Error('HTTP '+res.status);
    const d=await res.json();wxLoaded=true;
    const cur=d.current_condition[0];
    const icon=wxIcon(cur.weatherCode),temp=cur.temp_F,feels=cur.FeelsLikeF,desc=cur.weatherDesc[0].value;
    const hum=cur.humidity,wind=`${cur.windspeedMiles} mph ${cur.winddir16Point}`;
    const vis=cur.visibility+' mi',uv=cur.uvIndex,cloud=cur.cloudcover+'%';
    $('top-wx-icon').textContent=icon;$('top-wx-temp').textContent=temp+'Â°F';$('top-wx-cond').textContent=desc;
    const fc=d.weather.slice(0,7);
    const DS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const isRain=desc.toLowerCase().includes('rain')||desc.toLowerCase().includes('drizzle');
    const wNum=+cur.windspeedMiles,uvNum=+uv,tNum=+temp;
    const grade=!isRain&&tNum>52&&tNum<92?'Excellent':!isRain&&tNum>42?'Good':isRain?'Poor':'Fair';
    const gc=grade==='Excellent'?'good':grade==='Good'?'ok':'bad';
    if(isRain||wNum>20||tNum<42){
      $('wx-alert').innerHTML=`<div class="wx-alert"><div style="font-size:16px;flex-shrink:0">âš ï¸</div><div style="font-size:12px;color:var(--amber);line-height:1.6"><strong>Field Advisory â€” </strong>${isRain?'Rain detected. Consider rescheduling canvassing. ':''}${wNum>20?'High winds. ':''}${tNum<42?'Cold temps below 42Â°F.':''}</div></div>`;
    }
    $('wx-body').innerHTML=`<div class="wx-hero"><div class="wx-main"><div class="wx-big-icon">${icon}</div><div><div class="wx-temp">${temp}Â°F</div><div class="wx-feels">Feels like ${feels}Â°F</div><div class="wx-cond">${desc}</div><div class="wx-loc">ğŸ“ Salinas / Monterey County, CA</div></div></div><div class="wx-details"><div class="wx-row"><span class="wx-row-lbl">Humidity</span><span class="wx-row-val">${hum}%</span></div><div class="wx-row"><span class="wx-row-lbl">Wind</span><span class="wx-row-val">${wind}</span></div><div class="wx-row"><span class="wx-row-lbl">Visibility</span><span class="wx-row-val">${vis}</span></div><div class="wx-row"><span class="wx-row-lbl">UV Index</span><span class="wx-row-val" style="color:${uvNum<=2?'var(--green)':uvNum<=5?'var(--amber)':'var(--red)'}">${uv}</span></div><div class="wx-row"><span class="wx-row-lbl">Cloud Cover</span><span class="wx-row-val">${cloud}</span></div><div class="wx-row"><span class="wx-row-lbl">Precipitation</span><span class="wx-row-val">${cur.precipMM} mm</span></div></div></div><div style="font-size:10px;font-family:var(--mono);letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:10px">7-Day Forecast</div><div class="fc-row">${fc.map(day=>{const dd=new Date(day.date);return`<div class="fc-day"><div class="fc-lbl">${DS[dd.getDay()]}</div><div class="fc-ico">${wxIcon(day.hourly[4]?.weatherCode||113)}</div><div class="fc-hi">${day.maxtempF}Â°</div><div class="fc-lo">${day.mintempF}Â°</div></div>`;}).join('')}</div><div class="wx-impact"><h4>Field Canvassing Impact â€” Monterey County</h4><div class="impact-grid"><div class="imp"><div class="imp-ico">ğŸš¶</div><div class="imp-lbl">Canvassing</div><div class="imp-val imp-${gc}">${grade}</div></div><div class="imp"><div class="imp-ico">ğŸŒ§</div><div class="imp-lbl">Rain Risk</div><div class="imp-val imp-${isRain?'bad':'good'}">${isRain?'Active':'None'}</div></div><div class="imp"><div class="imp-ico">ğŸ’¨</div><div class="imp-lbl">Wind</div><div class="imp-val imp-${wNum<10?'good':wNum<20?'ok':'bad'}">${wNum<10?'Calm':wNum<20?'Breezy':'Windy'}</div></div><div class="imp"><div class="imp-ico">â˜€ï¸</div><div class="imp-lbl">UV Risk</div><div class="imp-val imp-${uvNum<=2?'good':uvNum<=5?'ok':'bad'}">${uvNum<=2?'Low':uvNum<=5?'Moderate':'High'}</div></div></div></div>`;
  }catch(err){
    $('wx-body').innerHTML=`<div style="background:var(--rg);border:1px solid var(--rb);border-radius:9px;padding:16px;color:var(--red);font-size:13px">âš  Could not load weather: ${err.message}</div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CRIME MAP  (Monterey County)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let crimeMap=null,crimeLoaded=false,crimeData=[],crimeMkrs=[];
const CRIME_COL={theft:'#f59e0b',burglary:'#ef4444',assault:'#ef4444',vandalism:'#8b5cf6',arrest:'#06b6d4',other:'#94a3b8'};
const cColor=t=>{const k=Object.keys(CRIME_COL).find(c=>t.toLowerCase().includes(c));return CRIME_COL[k||'other'];};
async function loadCrime(force=false){
  if(crimeLoaded&&!force)return;
  $('crime-bar').className='crime-bar';
  $('crime-bar').textContent='ğŸ“¡ Loading crime dataâ€¦';
  if(!crimeMap){
    crimeMap=L.map('crime-map-wrap',{center:[36.6002,-121.8947],zoom:11});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap',maxZoom:19}).addTo(crimeMap);
  }
  crimeMkrs.forEach(m=>crimeMap.removeLayer(m));crimeMkrs=[];
  try{
    const res=await fetch('https://api.spotcrime.com/crimes.json?lat=36.6002&lon=-121.8947&r=0.04&key=spotcrime');
    if(!res.ok)throw new Error('HTTP '+res.status);
    const data=await res.json();
    crimeData=data.crimes||[];
    if(!crimeData.length)throw new Error('No incidents returned');
    crimeLoaded=true;
    renderCrimeMarkers('all');
    $('crime-bar').className='crime-bar ok';
    $('crime-bar').textContent=`âœ… ${crimeData.length} recent incidents loaded â€” Monterey County`;
    $('crime-filters').style.display='flex';
    $('crime-log').style.display='block';
    setTimeout(()=>crimeMap.invalidateSize(),200);
  }catch(err){
    $('crime-bar').className='crime-bar err';
    $('crime-bar').innerHTML=`âš ï¸ Crime data unavailable: ${err.message}<br><span style="font-size:11px;opacity:.75">SpotCrime may not cover all Monterey County zip codes. Map is still interactive.</span>`;
    setTimeout(()=>crimeMap.invalidateSize(),200);
  }
}
function renderCrimeMarkers(type){
  crimeMkrs.forEach(m=>crimeMap.removeLayer(m));crimeMkrs=[];
  const filtered=type==='all'?crimeData:crimeData.filter(c=>(c.type||'').toLowerCase().includes(type));
  filtered.forEach(c=>{
    if(!c.lat||!c.lon)return;
    const col=cColor(c.type||'');
    const m=L.circleMarker([c.lat,c.lon],{radius:7,color:col,fillColor:col,fillOpacity:.7,weight:2}).addTo(crimeMap);
    m.bindPopup(`<div style="font-family:'Outfit',sans-serif;min-width:160px"><b style="color:${col}">${c.type||'Unknown'}</b><br><span style="font-size:11px;color:#64748b">${c.address||''}</span><br><span style="font-size:10px;color:#94a3b8">${c.date||''}</span></div>`);
    crimeMkrs.push(m);
  });
  $('crime-ct').textContent=filtered.length+' incidents';
  $('crime-rows').innerHTML=filtered.slice(0,25).map(c=>{
    const col=cColor(c.type||'');
    return `<div class="log-row"><span class="log-time">${c.date||'â€”'}</span><span class="log-msg">${c.address||'Unknown'}</span><span class="badge" style="background:${col}22;color:${col};border:1px solid ${col}44;font-size:9px">${c.type||'Unknown'}</span></div>`;
  }).join('');
}
function filterCrime(type,btn){
  document.querySelectorAll('.cf-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');renderCrimeMarkers(type);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SERVICE STATUS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SERVICES=[
  {id:'internet',name:'Internet',desc:'General connectivity',url:'https://www.google.com'},
  {id:'maps',name:'Map Tiles',desc:'OpenStreetMap',url:'https://tile.openstreetmap.org/0/0/0.png'},
  {id:'weather',name:'Weather API',desc:'wttr.in',url:'https://wttr.in/test?format=j1'},
  {id:'spotcrime',name:'Crime API',desc:'SpotCrime',url:'https://api.spotcrime.com'},
  {id:'overpass',name:'Overpass API',desc:'Building data',url:'https://overpass-api.de'},
  {id:'fonts',name:'CDN / Fonts',desc:'Google Fonts',url:'https://fonts.googleapis.com'},
];
let svcState={},svcLog=[];
async function checkOne(svc){
  const t=Date.now();
  try{await fetch(svc.url,{mode:'no-cors',cache:'no-store',signal:AbortSignal.timeout(6000)});return{ok:true,ms:Date.now()-t};}
  catch{return{ok:false,ms:null};}
}
async function runChecks(){
  renderSvcCards(true);
  const btn=$('check-btn');btn.disabled=true;btn.textContent='Checkingâ€¦';
  const results=await Promise.all(SERVICES.map(async s=>{const r=await checkOne(s);svcState[s.id]=r;return{...s,...r};}));
  const allOk=results.every(r=>r.ok);
  const banner=$('ov-banner'),netDot=$('net-dot'),netLbl=$('net-lbl');
  if(allOk){
    banner.className='ov-banner all-ok';
    banner.innerHTML=`<div class="ov-icon">âœ…</div><div><div class="ov-title">All Systems Operational</div><div class="ov-sub">Last checked: ${new Date().toLocaleTimeString()}</div></div>`;
    netDot.className='ndot';netLbl.textContent='Online';
  }else{
    banner.className='ov-banner issues';
    const dc=results.filter(r=>!r.ok).length;
    banner.innerHTML=`<div class="ov-icon">âš ï¸</div><div><div class="ov-title">${dc} Service${dc>1?'s':''} Unreachable</div><div class="ov-sub">Last checked: ${new Date().toLocaleTimeString()}</div></div>`;
    netDot.className='ndot warn';netLbl.textContent='Issues';
  }
  svcLog.unshift({ts:new Date().toLocaleTimeString(),ok:results.filter(r=>r.ok).length,total:results.length,msg:allOk?'All checks passed':results.filter(r=>!r.ok).map(r=>r.name).join(', ')+' unreachable'});
  if(svcLog.length>20)svcLog.pop();
  $('log-ct').textContent=svcLog.length+' check runs';
  $('status-log').innerHTML=svcLog.map(l=>`<div class="log-row"><span class="log-time">${l.ts}</span><span class="log-msg">${l.msg}</span><span class="log-score" style="color:${l.ok===l.total?'var(--green)':'var(--amber)'}">${l.ok}/${l.total}</span></div>`).join('');
  renderSvcCards(false);btn.disabled=false;btn.textContent='â†» Run Checks';
}
function renderSvcCards(checking){
  $('svc-grid').innerHTML=SERVICES.map(s=>{
    const st=svcState[s.id],status=checking?'chk':st?(st.ok?'ok':'down'):'chk';
    const colors={ok:'var(--green)',down:'var(--red)',chk:'var(--amber)'};
    const labels={ok:'ONLINE',down:'UNREACHABLE',chk:'CHECKING'};
    const bars=Array.from({length:22},()=>`<div class="svc-bar" style="height:${8+Math.random()*30}px;background:${status==='ok'?'var(--bl)':status==='down'?'var(--red)':'var(--amber)'}33"></div>`).join('');
    return `<div class="svc-card" style="${status!=='ok'?'border-color:'+colors[status]+'44':''}"><div class="svc-top"><div><div class="svc-name">${s.name}</div><div class="svc-desc">${s.desc}</div></div><div class="dot ${status==='ok'?'g':status==='down'?'r':'a'}" style="margin-top:4px"></div></div><div class="svc-spark">${bars}</div><div class="svc-bot"><span class="${status}">${labels[status]}</span><span>${st?.ok?st.ms+'ms':'â€”'}</span></div></div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAZY LOAD â€” init map/weather/crime/status
   when section scrolls into viewport
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setupLazyLoad(){
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(!e.isIntersecting)return;
      const id=e.target.id;
      if(id==='sec-map'&&!mapInitialized)initMap();
      if(id==='sec-weather'&&!wxLoaded)loadWeather(false);
      if(id==='sec-crime'&&!crimeLoaded)loadCrime(false);
      if(id==='sec-status')runChecks();
    });
  },{threshold:0.05});
  ['sec-map','sec-weather','sec-crime','sec-status'].forEach(id=>{const el=$(id);if(el)obs.observe(el);});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded',()=>{
  loadAll();
  updateDash();renderCal();renderSales();renderLeaderboard();
  renderAreas();renderTeam();renderSvcCards(false);refreshSelects();
  document.querySelectorAll('input[type=date]').forEach(el=>{if(!el.value)el.value=iso();});
  setupScrollSpy();
  setupLazyLoad();
  // Topbar weather widget
  setTimeout(()=>{
    fetch('https://wttr.in/Salinas,CA?format=j1')
      .then(r=>r.json())
      .then(d=>{
        const cur=d.current_condition[0];
        $('top-wx-icon').textContent=wxIcon(cur.weatherCode);
        $('top-wx-temp').textContent=cur.temp_F+'Â°F';
        $('top-wx-cond').textContent=cur.weatherDesc[0].value;
      }).catch(()=>{});
  },800);
  setInterval(updateDash,60000);
  // Restore notice
  const saved=localStorage.getItem(STORE_KEY);
  if(saved){
    try{
      const p=JSON.parse(saved);
      const total=(p.pins||[]).length+(p.appts||[]).length+(p.sales||[]).length;
      if(total>0)toast(`Session restored â€” ${total} record${total!==1?'s':''} loaded`,'success');
    }catch(e){}
  }
});
</script>

</body>
</html>
