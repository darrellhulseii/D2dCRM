<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Complete Home â€” Monterey County</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<!-- Gun.js: free real-time sync â€” no server or account needed -->
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<style>
:root{
  --bg:#070b14;--surf:#0d1220;--card:#111827;--card2:#161f30;--elev:#1a2235;--inp:#0d1220;
  --blue:#2563eb;--bl:#3b82f6;--bg2:rgba(37,99,235,.13);--bb:rgba(59,130,246,.4);
  --green:#10b981;--gg:rgba(16,185,129,.12);--gb:rgba(16,185,129,.35);
  --amber:#f59e0b;--ag:rgba(245,158,11,.12);--ab:rgba(245,158,11,.35);
  --red:#ef4444;--rg:rgba(239,68,68,.12);--rb:rgba(239,68,68,.35);
  --violet:#8b5cf6;--vg:rgba(139,92,246,.12);--vb:rgba(139,92,246,.35);
  --cyan:#06b6d4;--cg:rgba(6,182,212,.12);
  --t1:#f1f5f9;--t2:#94a3b8;--t3:#475569;
  --bdr:rgba(255,255,255,.07);--bdr2:rgba(255,255,255,.13);
  --nh:54px;
  --font:'Outfit',sans-serif;--mono:'DM Mono',monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--t1);font-family:var(--font);font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased}
button{font-family:var(--font);cursor:pointer}
input,select,textarea{font-family:var(--font)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--elev);border-radius:3px}

/* â”€â”€ NAV â”€â”€ */
#nav{position:sticky;top:0;z-index:300;height:var(â€“nh);background:rgba(7,11,20,.93);
border-bottom:1px solid var(â€“bdr2);backdrop-filter:blur(20px);
display:flex;align-items:center;padding:0 20px;gap:0}
.n-brand{display:flex;align-items:center;gap:9px;margin-right:22px;flex-shrink:0}
.n-logo{width:28px;height:28px;background:var(â€“blue);border-radius:7px;display:flex;
align-items:center;justify-content:center;font-size:14px;box-shadow:0 0 16px rgba(37,99,235,.55)}
.n-title{font-size:13px;font-weight:800;letter-spacing:-.3px}
.n-sub{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);letter-spacing:1.5px;text-transform:uppercase}
.n-links{display:flex;gap:1px;flex:1;overflow-x:auto;scrollbar-width:none}
.n-links::-webkit-scrollbar{display:none}
.nb{padding:6px 12px;border-radius:7px;font-size:12px;font-weight:600;color:var(â€“t3);
border:none;background:none;cursor:pointer;transition:all .15s;white-space:nowrap}
.nb:hover{color:var(â€“t1);background:rgba(255,255,255,.06)}
.nb.on{color:var(â€“bl);background:var(â€“bg2)}
.n-right{display:flex;align-items:center;gap:7px;flex-shrink:0;margin-left:12px}
.wx-chip{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.04);
border:1px solid var(â€“bdr);border-radius:7px;padding:5px 11px;
font-size:12px;font-weight:600;cursor:pointer;transition:border-color .15s}
.wx-chip:hover{border-color:var(â€“bb)}
.net-pill{display:flex;align-items:center;gap:5px;padding:5px 10px;
background:rgba(255,255,255,.04);border:1px solid var(â€“bdr);border-radius:7px}
.ndot{width:7px;height:7px;border-radius:50%;background:var(â€“green);
box-shadow:0 0 6px var(â€“green);animation:pg 2.5s infinite;flex-shrink:0}
.ndot.warn{background:var(â€“amber);box-shadow:0 0 6px var(â€“amber)}
@keyframes pg{0%,100%{opacity:1}50%{opacity:.35}}

/* â”€â”€ PAGE â”€â”€ */
#page{max-width:1600px;margin:0 auto}
.sec{padding:30px 28px;border-bottom:1px solid var(â€“bdr)}
.sec:last-child{border-bottom:none;padding-bottom:80px}
.sec-tag{font-size:9px;font-family:var(â€“mono);letter-spacing:2px;text-transform:uppercase;
color:var(â€“t3);display:flex;align-items:center;gap:6px;margin-bottom:4px}
.sec-tag::before{content:â€™â€™;width:12px;height:1px;background:currentColor}
.sec-hd{display:flex;align-items:flex-start;justify-content:space-between;
margin-bottom:18px;gap:12px;flex-wrap:wrap}
.sec-hd h2{font-size:18px;font-weight:800;letter-spacing:-.4px;display:flex;align-items:center;gap:8px}
.sec-hd p{font-size:12px;color:var(â€“t2);margin-top:3px}
.sec-act{display:flex;gap:7px;align-items:center;flex-shrink:0}

/* â”€â”€ MAP HERO â”€â”€ */
#sec-map{padding:0;border-bottom:1px solid var(â€“bdr)}
.map-bar{display:flex;align-items:center;justify-content:space-between;
padding:10px 16px;background:var(â€“surf);border-bottom:1px solid var(â€“bdr);gap:8px;flex-wrap:wrap}
.map-bar-l{display:flex;align-items:center;gap:10px}
.map-bar h2{font-size:14px;font-weight:700;display:flex;align-items:center;gap:6px}
.map-bar-r{display:flex;gap:6px}
.map-body{display:flex;height:calc(100vh - var(â€“nh) - 48px);min-height:500px}
.map-side{width:268px;flex-shrink:0;background:var(â€“surf);
border-right:1px solid var(â€“bdr);display:flex;flex-direction:column;overflow:hidden}
.side-tools{padding:7px 9px;border-bottom:1px solid var(â€“bdr);display:flex;gap:5px}
.mtool{flex:1;background:var(â€“elev);border:1px solid var(â€“bdr2);border-radius:7px;
color:var(â€“t2);padding:7px 4px;font-size:11px;font-weight:600;
cursor:pointer;transition:all .15s;text-align:center}
.mtool:hover,.mtool.on{border-color:var(â€“bb);color:var(â€“bl);background:var(â€“bg2)}
.mtool.del:hover{border-color:var(â€“rb);color:var(â€“red);background:var(â€“rg)}
.map-stats{display:grid;grid-template-columns:repeat(4,1fr);border-bottom:1px solid var(â€“bdr)}
.mst{padding:7px 2px;text-align:center;border-right:1px solid var(â€“bdr)}
.mst:last-child{border-right:none}
.mst-v{font-size:15px;font-weight:800}
.mst-l{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:.8px}
.side-srch{padding:7px 9px;border-bottom:1px solid var(â€“bdr)}
.side-srch input{width:100%;background:var(â€“elev);border:1px solid var(â€“bdr2);
border-radius:7px;color:var(â€“t1);padding:6px 10px;font-size:12px;outline:none}
.side-srch input:focus{border-color:var(â€“bb)}
.pin-list{flex:1;overflow-y:auto}
.prow{display:flex;align-items:center;gap:8px;padding:9px 12px;
border-bottom:1px solid var(â€“bdr);cursor:pointer;transition:background .1s}
.prow:hover,.prow.act{background:var(â€“bg2)}
.pdot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.pname{font-size:12px;font-weight:600;color:var(â€“t1);white-space:nowrap;
overflow:hidden;text-overflow:ellipsis}
.paddr{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);
white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pago{font-size:9px;color:var(â€“t3);white-space:nowrap;margin-left:auto;flex-shrink:0}
.map-canvas{flex:1;position:relative}
#lmap{width:100%;height:100%}
.lasso-hint{position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:500;
background:rgba(37,99,235,.95);color:#fff;padding:8px 18px;border-radius:8px;
font-size:11px;font-family:var(â€“mono);display:none;pointer-events:none;
white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.5)}
.map-ldr{position:absolute;inset:0;z-index:600;background:rgba(7,11,20,.82);
display:none;flex-direction:column;align-items:center;justify-content:center;
gap:12px;backdrop-filter:blur(4px)}
.map-ldr.on{display:flex}
.ldr-txt{font-size:12px;color:var(â€“bl);font-family:var(â€“mono);letter-spacing:1px}
.map-leg{position:absolute;bottom:12px;right:8px;z-index:400;
background:rgba(7,11,20,.95);border:1px solid var(â€“bdr2);border-radius:9px;
padding:10px 13px;backdrop-filter:blur(8px)}
.map-leg h5{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);letter-spacing:1.5px;
text-transform:uppercase;margin-bottom:7px}
.lr{display:flex;align-items:center;gap:7px;margin-bottom:4px;font-size:10px;color:var(â€“t2)}
.ld{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* â”€â”€ LEAD DRAWER â”€â”€ */
#drawer{position:fixed;right:0;top:0;bottom:0;width:400px;z-index:501;
background:var(â€“surf);border-left:1px solid var(â€“bdr2);
display:flex;flex-direction:column;
transform:translateX(100%);transition:transform .26s cubic-bezier(.4,0,.2,1);
box-shadow:-12px 0 50px rgba(0,0,0,.6)}
#drawer.open{transform:translateX(0)}
#dov{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.35);
display:none;backdrop-filter:blur(2px)}
.d-hd{padding:13px 15px;border-bottom:1px solid var(â€“bdr);
display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.d-hd h3{font-size:14px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.d-x{width:27px;height:27px;background:var(â€“elev);border:1px solid var(â€“bdr);
border-radius:7px;display:flex;align-items:center;justify-content:center;
font-size:13px;color:var(â€“t3);cursor:pointer;transition:all .15s;flex-shrink:0}
.d-x:hover{background:var(â€“rg);border-color:var(â€“rb);color:var(â€“red)}
.d-body{flex:1;overflow-y:auto;padding:13px 15px}
.d-foot{padding:11px 15px;border-top:1px solid var(â€“bdr);display:flex;gap:7px;flex-shrink:0}
.d-sect{margin-bottom:16px}
.d-stitle{font-size:9px;font-family:var(â€“mono);letter-spacing:1.8px;text-transform:uppercase;
color:var(â€“t3);margin-bottom:9px;display:flex;align-items:center;gap:6px}
.d-stitle::before{content:â€™â€™;width:10px;height:1px;background:currentColor}
.status-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:8px}
.spill{padding:7px 5px;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;
border:1px solid;transition:all .15s;text-align:center;font-family:var(â€“font)}
.spill:hover{filter:brightness(1.2)}
.spill.active-status{box-shadow:0 0 0 2px rgba(255,255,255,.3)}

/* â”€â”€ TIMELINE â”€â”€ */
.timeline{display:flex;flex-direction:column}
.tl-item{display:flex;gap:10px;position:relative;padding-bottom:13px}
.tl-item:last-child{padding-bottom:0}
.tl-item:not(:last-child)::before{content:â€™â€™;position:absolute;
left:9px;top:18px;bottom:0;width:1px;background:var(â€“bdr2)}
.tl-dot{width:18px;height:18px;border-radius:50%;flex-shrink:0;
display:flex;align-items:center;justify-content:center;
font-size:8px;margin-top:2px;border:1.5px solid}
.tl-body{flex:1;min-width:0}
.tl-act{font-size:12px;font-weight:600;color:var(â€“t1)}
.tl-note{font-size:11px;color:var(â€“t2);margin-top:2px;line-height:1.55;
white-space:pre-wrap;word-break:break-word}
.tl-when{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);margin-top:2px}

/* â”€â”€ CARDS / KPI â”€â”€ */
.card{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;overflow:hidden;transition:border-color .2s}
.card:hover{border-color:var(â€“bdr2)}
.card-hd{padding:12px 16px;border-bottom:1px solid var(â€“bdr);
display:flex;align-items:center;justify-content:space-between}
.card-hd h3{font-size:13px;font-weight:600}
.card-hd .meta{font-size:11px;color:var(â€“t3);font-family:var(â€“mono)}
.card-bd{padding:14px}
.kpis{display:grid;gap:11px;margin-bottom:18px}
.k4{grid-template-columns:repeat(4,1fr)}
@media(max-width:1000px){.k4{grid-template-columns:repeat(2,1fr)}}
.kpi{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;
padding:14px 18px;position:relative;overflow:hidden;transition:all .15s}
.kpi:hover{border-color:var(â€“bdr2);transform:translateY(-1px)}
.kpi::after{content:â€™â€™;position:absolute;bottom:0;left:0;right:0;height:2px;opacity:.9}
.kpi.bl::after{background:linear-gradient(90deg,transparent,var(â€“blue),transparent)}
.kpi.gr::after{background:linear-gradient(90deg,transparent,var(â€“green),transparent)}
.kpi.am::after{background:linear-gradient(90deg,transparent,var(â€“amber),transparent)}
.kpi.vi::after{background:linear-gradient(90deg,transparent,var(â€“violet),transparent)}
.kpi-lbl{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;
color:var(â€“t3);font-family:var(â€“mono);margin-bottom:5px}
.kpi-val{font-size:24px;font-weight:900;letter-spacing:-.8px;line-height:1}
.kpi.bl .kpi-val{color:var(â€“bl)}.kpi.gr .kpi-val{color:var(â€“green)}
.kpi.am .kpi-val{color:var(â€“amber)}.kpi.vi .kpi-val{color:var(â€“violet)}
.kpi-sub{font-size:11px;color:var(â€“t3);margin-top:3px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;
border-radius:8px;font-size:12px;font-weight:600;border:none;
transition:all .15s;cursor:pointer;white-space:nowrap;font-family:var(â€“font)}
.btn-p{background:var(â€“blue);color:#fff}
.btn-p:hover{background:var(â€“bl);box-shadow:0 4px 14px rgba(37,99,235,.4)}
.btn-g{background:var(â€“green);color:#fff}
.btn-g:hover{background:#0ea371;box-shadow:0 4px 14px rgba(16,185,129,.3)}
.btn-r{background:var(â€“red);color:#fff}
.btn-r:hover{box-shadow:0 4px 14px rgba(239,68,68,.3)}
.btn-ghost{background:rgba(255,255,255,.05);color:var(â€“t2);border:1px solid var(â€“bdr2)}
.btn-ghost:hover{color:var(â€“t1);border-color:var(â€“bb);background:var(â€“bg2)}
.btn-sm{padding:5px 11px;font-size:11px}

/* â”€â”€ BADGES â”€â”€ */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;
font-size:10px;font-weight:600;font-family:var(â€“mono);letter-spacing:.5px;
text-transform:uppercase;white-space:nowrap}
.b-bl{background:var(â€“bg2);color:var(â€“bl);border:1px solid var(â€“bb)}
.b-gr{background:var(â€“gg);color:var(â€“green);border:1px solid var(â€“gb)}
.b-am{background:var(â€“ag);color:var(â€“amber);border:1px solid var(â€“ab)}
.b-re{background:var(â€“rg);color:var(â€“red);border:1px solid var(â€“rb)}
.b-vi{background:var(â€“vg);color:var(â€“violet);border:1px solid var(â€“vb)}
.b-gy{background:rgba(71,85,105,.2);color:var(â€“t3);border:1px solid rgba(71,85,105,.3)}

/* â”€â”€ GRIDS / TABLES â”€â”€ */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:11px}
@media(max-width:1100px){.g3,.g4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:700px){.g2,.g3,.g4{grid-template-columns:1fr}}
.tbl{width:100%;border-collapse:collapse}
.tbl th{padding:9px 13px;text-align:left;font-size:10px;font-weight:600;
letter-spacing:1px;text-transform:uppercase;color:var(â€“t3);font-family:var(â€“mono);
border-bottom:1px solid var(â€“bdr);background:var(â€“card);white-space:nowrap}
.tbl td{padding:10px 13px;border-bottom:1px solid var(â€“bdr);font-size:12px;
color:var(â€“t2);background:var(â€“card)}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(â€“card2);cursor:pointer}
.tbl td.pri{color:var(â€“t1);font-weight:600}
.tbl td.money{color:var(â€“green);font-family:var(â€“mono);font-weight:700;font-size:13px}
.tbl td.mono{font-family:var(â€“mono);font-size:11px}

/* â”€â”€ FORMS â”€â”€ */
.fg{margin-bottom:11px}
.fl{display:block;font-size:11px;font-weight:600;color:var(â€“t2);margin-bottom:4px}
.fi,.fs,.ft{width:100%;background:var(â€“inp);border:1px solid var(â€“bdr2);
border-radius:8px;color:var(â€“t1);padding:8px 11px;font-size:13px;
font-family:var(â€“font);outline:none;transition:border-color .15s,box-shadow .15s;appearance:none}
.fi:focus,.fs:focus,.ft:focus{border-color:rgba(59,130,246,.6);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
.fs option{background:var(â€“elev)}
.ft{resize:vertical;min-height:68px}
.fr2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* â”€â”€ LEADS FILTERS â”€â”€ */
.fbar{display:flex;gap:6px;margin-bottom:13px;flex-wrap:wrap;align-items:center}
.fb{background:var(â€“elev);border:1px solid var(â€“bdr2);border-radius:7px;
color:var(â€“t3);padding:5px 11px;font-size:11px;font-weight:600;
cursor:pointer;transition:all .15s;white-space:nowrap}
.fb.on{background:var(â€“bg2);border-color:var(â€“bb);color:var(â€“bl)}
.s-inp{background:var(â€“elev);border:1px solid var(â€“bdr2);border-radius:8px;
color:var(â€“t1);padding:6px 11px;font-size:12px;outline:none;width:200px}
.s-inp:focus{border-color:var(â€“bb)}

/* â”€â”€ CALENDAR â”€â”€ */
.cal-shell{display:grid;grid-template-columns:1fr 250px;gap:14px}
.cal-nav{display:flex;align-items:center;gap:7px}
.cal-arr{background:var(â€“elev);border:1px solid var(â€“bdr2);border-radius:7px;
width:29px;height:29px;display:flex;align-items:center;justify-content:center;
font-size:14px;cursor:pointer;color:var(â€“t2);transition:all .15s}
.cal-arr:hover{border-color:var(â€“bb);color:var(â€“bl)}
.cal-lbl{font-size:12px;font-weight:600;font-family:var(â€“mono);color:var(â€“t1);
min-width:88px;text-align:center}
.cal-hd-row{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:2px}
.cdh{text-align:center;padding:5px 3px;font-size:10px;font-weight:600;
letter-spacing:1px;text-transform:uppercase;color:var(â€“t3);font-family:var(â€“mono)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cc{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:6px;
min-height:68px;padding:5px;cursor:pointer;transition:border-color .15s}
.cc:hover{border-color:var(â€“bb);background:var(â€“card2)}
.cc.today{border-color:var(â€“bl);background:var(â€“bg2)}
.cc.other{background:var(â€“surf);opacity:.3;cursor:default;pointer-events:none}
.cdn{font-size:10px;font-family:var(â€“mono);color:var(â€“t3);margin-bottom:2px}
.cc.today .cdn{color:var(â€“bl);font-weight:700}
.cpill{display:block;border-radius:3px;padding:2px 4px;margin-bottom:2px;
font-size:9px;font-weight:600;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.ap-demo{background:var(â€“vg);color:var(â€“violet);border-left:2px solid var(â€“violet)}
.ap-followup{background:var(â€“ag);color:var(â€“amber);border-left:2px solid var(â€“amber)}
.ap-close{background:var(â€“gg);color:var(â€“green);border-left:2px solid var(â€“green)}
.ap-visit{background:var(â€“bg2);color:var(â€“bl);border-left:2px solid var(â€“bl)}
.appt-item{padding:10px 13px;border-bottom:1px solid var(â€“bdr);cursor:pointer;transition:background .1s}
.appt-item:hover{background:var(â€“elev)}
.at{font-size:10px;color:var(â€“bl);font-family:var(â€“mono);font-weight:600;margin-bottom:2px}
.an{font-size:13px;font-weight:600;color:var(â€“t1)}
.ad{font-size:11px;color:var(â€“t3);margin-top:1px}

/* â”€â”€ LEADERBOARD â”€â”€ */
.podium{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;margin-bottom:14px}
.pod{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;
padding:16px;text-align:center;transition:transform .15s}
.pod:hover{transform:translateY(-2px);border-color:var(â€“bdr2)}
.pod.gold{border-color:rgba(245,158,11,.5);background:linear-gradient(135deg,var(â€“card),rgba(245,158,11,.06))}
.pod.silver{border-color:rgba(148,163,184,.3)}
.pod.bronze{border-color:rgba(180,100,50,.3)}
.pod-med{font-size:22px;margin-bottom:7px}
.pod-av{width:40px;height:40px;border-radius:50%;margin:0 auto 7px;
display:flex;align-items:center;justify-content:center;
font-size:14px;font-weight:800;border:2px solid}
.pod-name{font-size:13px;font-weight:700;color:var(â€“t1)}
.pod-zone{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);margin-top:1px;margin-bottom:8px}
.pod-amt{font-size:19px;font-weight:900;color:var(â€“green)}
.pod-meta{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);margin-top:2px}

/* â”€â”€ TEAM / AREA CARDS â”€â”€ */
.team-card{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;padding:15px;transition:all .15s}
.team-card:hover{border-color:var(â€“bdr2);transform:translateY(-1px)}
.team-top{display:flex;align-items:center;gap:10px;padding-bottom:11px;
margin-bottom:11px;border-bottom:1px solid var(â€“bdr)}
.tav{width:40px;height:40px;border-radius:9px;display:flex;align-items:center;
justify-content:center;font-size:14px;font-weight:800;flex-shrink:0;border:1px solid}
.tm-g{display:grid;grid-template-columns:repeat(3,1fr);gap:4px}
.tmv{font-size:16px;font-weight:800;letter-spacing:-.3px}
.tml{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1px}
.area-card{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;
padding:15px;position:relative;overflow:hidden;transition:all .15s}
.area-card:hover{border-color:var(â€“bdr2);transform:translateY(-1px)}
.a-stripe{position:absolute;top:0;left:0;width:4px;height:100%}
.a-name{font-size:14px;font-weight:700;color:var(â€“t1);padding-left:8px;margin-bottom:2px}
.a-meta{font-size:11px;color:var(â€“t3);font-family:var(â€“mono);padding-left:8px;margin-bottom:10px}
.a-stats{display:flex;gap:14px;padding-left:8px}
.asv{font-size:17px;font-weight:800}
.asl{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1px}
.a-prog{height:3px;background:var(â€“elev);border-radius:2px;margin-top:10px}
.a-fill{height:100%;border-radius:2px;transition:width .8s}

/* â”€â”€ REP BARS â”€â”€ */
.rb-wrap{display:flex;align-items:center;gap:9px;margin-bottom:8px}
.rb-name{width:58px;font-size:11px;font-family:var(â€“mono);color:var(â€“t3);
text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rb-track{flex:1;height:20px;background:var(â€“elev);border-radius:4px;overflow:hidden}
.rb-fill{height:100%;border-radius:4px;display:flex;align-items:center;
justify-content:flex-end;padding-right:7px;transition:width .8s ease}
.rb-fill span{font-size:9px;font-weight:700;color:#fff;font-family:var(â€“mono)}

/* â”€â”€ ACTIVITY â”€â”€ */
.act-item{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(â€“bdr)}
.act-item:last-child{border-bottom:none}
.act-ic{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.act-ttl{font-size:12px;font-weight:600;color:var(â€“t1)}
.act-sub{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);margin-top:1px}
.act-ts{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);white-space:nowrap;margin-left:auto}

/* â”€â”€ WEATHER â”€â”€ */
.wx-grid{display:grid;grid-template-columns:1fr 1.1fr;gap:12px;margin-bottom:13px}
.wx-main{background:linear-gradient(135deg,var(â€“card),rgba(37,99,235,.09));
border:1px solid var(â€“bdr);border-radius:12px;padding:20px;
display:flex;align-items:center;gap:16px}
.wx-icon{font-size:52px;line-height:1}
.wx-temp{font-size:42px;font-weight:900;letter-spacing:-2px;line-height:1}
.wx-desc{font-size:13px;font-weight:600;color:var(â€“bl);margin-top:4px}
.wx-loc{font-size:10px;color:var(â€“t3);font-family:var(â€“mono);margin-top:3px}
.wx-feels{font-size:11px;color:var(â€“t2);margin-top:2px}
.wx-det{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;padding:13px}
.wx-row{display:flex;justify-content:space-between;align-items:center;
padding:5px 0;border-bottom:1px solid var(â€“bdr)}
.wx-row:last-child{border-bottom:none}
.wx-rl{font-size:12px;color:var(â€“t2)}
.wx-rv{font-size:12px;font-weight:600;font-family:var(â€“mono);color:var(â€“t1)}
.fc-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:12px}
.fc-d{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:8px;padding:9px 5px;text-align:center}
.fc-dl{font-size:9px;font-family:var(â€“mono);color:var(â€“t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px}
.fc-di{font-size:17px;margin-bottom:3px}
.fc-hi{font-size:11px;font-weight:700;color:var(â€“t1)}
.fc-lo{font-size:10px;color:var(â€“t3);font-family:var(â€“mono)}
.wx-alert-box{background:var(â€“ag);border:1px solid var(â€“ab);border-radius:8px;
padding:10px 13px;margin-bottom:13px;display:flex;gap:9px;align-items:flex-start;font-size:12px;color:var(â€“amber)}
.wx-impact{background:var(â€“card);border:1px solid var(â€“bdr);border-radius:12px;padding:14px}
.wx-impact h4{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);
text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px}
.imp-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.imp{background:var(â€“elev);border:1px solid var(â€“bdr);border-radius:8px;padding:10px;text-align:center}
.imp-ico{font-size:16px;margin-bottom:3px}
.imp-lbl{font-size:9px;color:var(â€“t3);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
.imp-val{font-size:11px;font-weight:700}
.ig{color:var(â€“green)}.io{color:var(â€“amber)}.ib{color:var(â€“red)}

/* â”€â”€ TEAM JOIN SCREEN â”€â”€ */
#join-overlay{position:fixed;inset:0;z-index:2000;background:var(â€“bg);
display:flex;align-items:center;justify-content:center;padding:20px}
.join-box{background:var(â€“card);border:1px solid var(â€“bdr2);border-radius:20px;
padding:40px 36px;max-width:420px;width:100%;text-align:center;
box-shadow:0 24px 80px rgba(0,0,0,.8)}
.join-logo{width:56px;height:56px;background:var(â€“blue);border-radius:14px;
display:flex;align-items:center;justify-content:center;font-size:26px;
margin:0 auto 16px;box-shadow:0 0 30px rgba(37,99,235,.6)}
.join-title{font-size:22px;font-weight:900;letter-spacing:-.5px;margin-bottom:6px}
.join-sub{font-size:13px;color:var(â€“t2);margin-bottom:28px;line-height:1.7}
.join-lbl{display:block;font-size:11px;font-weight:600;color:var(â€“t2);
text-align:left;margin-bottom:5px}
.join-inp{width:100%;background:var(â€“inp);border:1px solid var(â€“bdr2);
border-radius:10px;color:var(â€“t1);padding:13px 14px;font-size:18px;
font-family:var(â€“mono);outline:none;letter-spacing:4px;text-align:center;
text-transform:uppercase;margin-bottom:16px;
transition:border-color .15s,box-shadow .15s}
.join-inp:focus{border-color:rgba(59,130,246,.6);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
.join-btn{width:100%;background:var(â€“blue);color:#fff;border:none;
border-radius:10px;padding:14px;font-size:15px;font-weight:700;
cursor:pointer;transition:all .15s;margin-bottom:14px}
.join-btn:hover{background:var(â€“bl);box-shadow:0 4px 20px rgba(37,99,235,.5)}
.join-note{font-size:11px;color:var(â€“t3);line-height:1.8}
.join-note strong{color:var(â€“t2)}
.join-examples{display:flex;gap:7px;justify-content:center;margin-bottom:22px;flex-wrap:wrap}
.join-ex{background:var(â€“elev);border:1px solid var(â€“bdr);border-radius:6px;
padding:4px 10px;font-size:11px;font-family:var(â€“mono);color:var(â€“t3);
cursor:pointer;transition:all .15s;letter-spacing:1px}
.join-ex:hover{border-color:var(â€“bb);color:var(â€“bl)}

/* â”€â”€ SYNC STATUS CHIP â”€â”€ */
.sync-chip{display:flex;align-items:center;gap:5px;padding:5px 10px;
background:rgba(255,255,255,.04);border:1px solid var(â€“bdr);border-radius:7px}
.sdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;transition:all .3s}
.sdot.live{background:var(â€“green);box-shadow:0 0 6px var(â€“green);animation:pg 2.5s infinite}
.sdot.sync{background:var(â€“amber);box-shadow:0 0 6px var(â€“amber);animation:pg .8s infinite}
.sdot.off{background:var(â€“red)}
@keyframes pg{0%,100%{opacity:1}50%{opacity:.3}}
.team-pill{background:var(â€“bg2);border:1px solid var(â€“bb);border-radius:6px;
padding:3px 9px;font-size:10px;font-family:var(â€“mono);color:var(â€“bl);
letter-spacing:1px;cursor:pointer;transition:all .15s;white-space:nowrap}
.team-pill:hover{background:rgba(37,99,235,.25)}

/* â”€â”€ SPINNER / EMPTY â”€â”€ */
.spinner{width:24px;height:24px;border:3px solid var(â€“bdr2);
border-top-color:var(â€“bl);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.ld-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;padding:40px}
.ld-wrap p{font-size:11px;color:var(â€“t3);font-family:var(â€“mono)}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;
padding:36px 20px;text-align:center;gap:6px}
.ei{font-size:26px;opacity:.4}
.et{font-size:13px;font-weight:600;color:var(â€“t2)}
.es{font-size:11px;color:var(â€“t3);max-width:200px;line-height:1.6}

/* â”€â”€ MODALS â”€â”€ */
.mbk{position:fixed;inset:0;background:rgba(7,11,20,.86);backdrop-filter:blur(6px);
z-index:800;display:none;align-items:center;justify-content:center;padding:20px}
.mbk.open{display:flex;animation:fi .2s ease}
@keyframes fi{from{opacity:0}to{opacity:1}}
.modal{background:var(â€“card);border:1px solid var(â€“bdr2);border-radius:16px;
width:480px;max-width:100%;max-height:90vh;overflow-y:auto;
box-shadow:0 24px 70px rgba(0,0,0,.7);animation:su .25s cubic-bezier(.4,0,.2,1)}
@keyframes su{from{opacity:0;transform:translateY(12px) scale(.98)}to{opacity:1;transform:none}}
.mhd{padding:15px 17px 12px;border-bottom:1px solid var(â€“bdr);
display:flex;align-items:center;justify-content:space-between}
.mhd h3{font-size:15px;font-weight:700}
.mx{width:26px;height:26px;background:var(â€“elev);border:1px solid var(â€“bdr);
border-radius:6px;display:flex;align-items:center;justify-content:center;
font-size:13px;color:var(â€“t3);cursor:pointer;transition:all .15s}
.mx:hover{background:var(â€“rg);border-color:var(â€“rb);color:var(â€“red)}
.mbd{padding:15px 17px}
.mft{padding:11px 17px;border-top:1px solid var(â€“bdr);display:flex;gap:7px;justify-content:flex-end}

/* â”€â”€ TOASTS â”€â”€ */
#toasts{position:fixed;bottom:18px;right:18px;z-index:9999;
display:flex;flex-direction:column;gap:6px;pointer-events:none}
.toast{background:var(â€“elev);border:1px solid var(â€“bdr2);border-radius:9px;
padding:10px 14px;display:flex;align-items:center;gap:8px;font-size:12px;
color:var(â€“t1);box-shadow:0 8px 30px rgba(0,0,0,.5);
pointer-events:all;max-width:280px;animation:ti .3s ease}
.toast.ok{border-left:3px solid var(â€“green)}
.toast.er{border-left:3px solid var(â€“red)}
.toast.in{border-left:3px solid var(â€“bl)}
@keyframes ti{from{opacity:0;transform:translateX(12px)}to{opacity:1;transform:none}}
</style>

</head>
<body>

<!-- â•”â•â• TEAM JOIN â•â•â•— -->

<div id="join-overlay">
  <div class="join-box">
    <div class="join-logo">ğŸ </div>
    <div class="join-title">Complete Home</div>
    <div class="join-sub">Enter a <strong>Team Code</strong> to connect.<br>Everyone using the same code shares all leads, sales, and appointments in <strong>real-time</strong>.</div>
    <label class="join-lbl">Team Code</label>
    <input class="join-inp" id="join-code" type="text" placeholder="MONTEREY" maxlength="20"
      autocomplete="off" spellcheck="false" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/,'')"
      onkeydown="if(event.key==='Enter')doJoin()">
    <div style="font-size:11px;color:var(--t3);margin-bottom:10px">Quick join:</div>
    <div class="join-examples">
      <div class="join-ex" onclick="quickJoin('MONTEREY')">MONTEREY</div>
      <div class="join-ex" onclick="quickJoin('SALINAS')">SALINAS</div>
      <div class="join-ex" onclick="quickJoin('COMPLETEHOME')">COMPLETEHOME</div>
    </div>
    <button class="join-btn" onclick="doJoin()">ğŸš€ Connect to Team</button>
    <div class="join-note">
      <strong>All data syncs live across every device.</strong><br>
      Share the same code with your reps so everyone sees every pin, sale, note, and appointment the moment it's created â€” no refresh needed.<br><br>
      Keep your code private â€” anyone with it can access your team's data.
    </div>
  </div>
</div>

<!-- â•”â•â• NAV â•â•â•— -->

<nav id="nav">
  <div class="n-brand">
    <div class="n-logo">ğŸ </div>
    <div><div class="n-title">Complete Home</div><div class="n-sub">Monterey County</div></div>
  </div>
  <div class="n-links">
    <button class="nb on" onclick="sc('sec-dash')">â¬› Dashboard</button>
    <button class="nb" onclick="sc('sec-map')">ğŸ“ Map</button>
    <button class="nb" onclick="sc('sec-leads')">ğŸ“‹ All Leads</button>
    <button class="nb" onclick="sc('sec-cal')">ğŸ“… Calendar</button>
    <button class="nb" onclick="sc('sec-sales')">ğŸ’° Sales</button>
    <button class="nb" onclick="sc('sec-lb')">ğŸ† Leaderboard</button>
    <button class="nb" onclick="sc('sec-team')">ğŸ‘¥ Team</button>
    <button class="nb" onclick="sc('sec-areas')">ğŸ—º Territories</button>
    <button class="nb" onclick="sc('sec-wx')">ğŸŒ¤ Weather</button>
  </div>
  <div class="n-right">
    <div class="wx-chip" onclick="sc('sec-wx')" title="Open-Meteo live weather">
      <span id="wx-nav-ico">ğŸŒ¤</span>
      <span id="wx-nav-temp" style="color:var(--t1)">--Â°F</span>
    </div>
    <div class="sync-chip">
      <span class="sdot off" id="sdot"></span>
      <span id="slbl" style="font-size:11px;font-weight:600;color:var(--t1)">Connectingâ€¦</span>
    </div>
    <div class="team-pill" id="team-pill" onclick="confirmLeave()" title="Click to switch team">
      TEAM: <span id="team-disp">â€”</span>
    </div>
  </div>
</nav>

<div id="page">

<!-- â•”â•â• DASHBOARD â•â•â•— -->

<section class="sec" id="sec-dash">
  <div class="sec-tag">Overview</div>
  <div class="sec-hd">
    <div><h2>Field Dashboard ğŸ </h2><p>Complete Home â€” Monterey County, CA Â· All data stored locally on this device</p></div>
    <div class="sec-act">
      <button class="btn btn-p btn-sm" onclick="sc('sec-map')">ğŸ“ Go to Map</button>
      <button class="btn btn-g btn-sm" onclick="openSaleModal()">+ Log Sale</button>
    </div>
  </div>
  <div class="kpis k4">
    <div class="kpi bl"><div class="kpi-lbl">Total Leads</div><div class="kpi-val" id="db-pins">0</div><div class="kpi-sub">All doors worked</div></div>
    <div class="kpi gr"><div class="kpi-lbl">Revenue</div><div class="kpi-val" id="db-rev">$0</div><div class="kpi-sub">Closed sales</div></div>
    <div class="kpi am"><div class="kpi-lbl">Appointments</div><div class="kpi-val" id="db-appts">0</div><div class="kpi-sub">Scheduled</div></div>
    <div class="kpi vi"><div class="kpi-lbl">Close Rate</div><div class="kpi-val" id="db-rate">0%</div><div class="kpi-sub">Sold Ã· total leads</div></div>
  </div>
  <div class="g2">
    <div class="card"><div class="card-hd"><h3>Activity Feed</h3><span class="meta" style="display:flex;align-items:center;gap:5px"><span style="width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green)"></span>Live</span></div><div class="card-bd" id="dash-feed"></div></div>
    <div class="card"><div class="card-hd"><h3>Today's Appointments</h3></div><div id="dash-today"></div></div>
  </div>
</section>

<!-- â•”â•â• MAP â•â•â•— -->

<section id="sec-map">
  <div class="map-bar">
    <div class="map-bar-l">
      <h2>ğŸ“ Lead Map â€” Monterey County</h2>
      <span class="badge b-bl" id="map-ct">0 pins</span>
      <span style="font-size:11px;color:var(--t3)">Click map to drop pin Â· Drag pin to move</span>
    </div>
    <div class="map-bar-r">
      <button class="btn btn-ghost btn-sm" id="tool-pin-bar" onclick="setTool('pin')">ğŸ“ Pin Mode</button>
      <button class="btn btn-ghost btn-sm" id="tool-lasso-bar" onclick="setTool('lasso')">âœï¸ Lasso Area</button>
      <button class="btn btn-ghost btn-sm" style="color:var(--red)" onclick="clearAllPins()">ğŸ—‘ Clear All</button>
    </div>
  </div>
  <div class="map-body">
    <div class="map-side">
      <div class="side-tools">
        <button class="mtool on" id="tool-pin" onclick="setTool('pin')">ğŸ“ Pin</button>
        <button class="mtool" id="tool-lasso" onclick="setTool('lasso')">âœï¸ Lasso</button>
        <button class="mtool del" onclick="clearAllPins()">ğŸ—‘</button>
      </div>
      <div class="map-stats">
        <div class="mst"><div class="mst-v" id="ms-tot">0</div><div class="mst-l">Total</div></div>
        <div class="mst"><div class="mst-v" style="color:var(--green)" id="ms-sold">0</div><div class="mst-l">Sold</div></div>
        <div class="mst"><div class="mst-v" style="color:var(--violet)" id="ms-appt">0</div><div class="mst-l">Appt</div></div>
        <div class="mst"><div class="mst-v" style="color:var(--t3)" id="ms-nh">0</div><div class="mst-l">N/H</div></div>
      </div>
      <div class="side-srch"><input id="side-srch-inp" type="text" placeholder="ğŸ”  Search leadsâ€¦" oninput="filterPanel(this.value)"></div>
      <div class="pin-list" id="pin-list">
        <div class="empty" style="padding:24px 10px">
          <div class="ei" style="font-size:20px">ğŸ“</div>
          <div class="et" style="font-size:12px">No leads yet</div>
          <div class="es" style="font-size:11px">Click anywhere on the map to drop a pin. A lead card will open automatically.</div>
        </div>
      </div>
    </div>
    <div class="map-canvas">
      <div id="lmap"></div>
      <div class="lasso-hint" id="lasso-hint">Click to draw points â€” Enter to finish Â· Esc to cancel</div>
      <div class="map-ldr" id="map-ldr">
        <div class="spinner"></div>
        <div class="ldr-txt" id="ldr-msg">Querying buildingsâ€¦</div>
      </div>
      <div class="map-leg">
        <h5>Status Legend</h5>
        <div class="lr"><div class="ld" style="background:#475569"></div>Not Home</div>
        <div class="lr"><div class="ld" style="background:#3b82f6"></div>New Lead</div>
        <div class="lr"><div class="ld" style="background:#f59e0b"></div>Contacted</div>
        <div class="lr"><div class="ld" style="background:#8b5cf6"></div>Appt Set</div>
        <div class="lr"><div class="ld" style="background:#10b981"></div>Sold âœ“</div>
        <div class="lr"><div class="ld" style="background:#ef4444"></div>Not Interested</div>
      </div>
    </div>
  </div>
</section>

<!-- â•”â•â• ALL LEADS (CRM table) â•â•â•— -->

<section class="sec" id="sec-leads">
  <div class="sec-tag">Lead Management</div>
  <div class="sec-hd">
    <div><h2>ğŸ“‹ All Leads</h2><p>Full CRM view â€” click any row to open the lead detail panel</p></div>
    <div class="sec-act">
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()">â¬‡ Export CSV</button>
      <button class="btn btn-p btn-sm" onclick="openManualLeadModal()">+ New Lead</button>
    </div>
  </div>
  <div class="fbar">
    <input class="s-inp" id="lead-srch" type="text" placeholder="ğŸ”  Search name, addressâ€¦" oninput="renderLeadsTable()">
    <button class="fb on" onclick="setLF('all',this)">All</button>
    <button class="fb" onclick="setLF('new',this)">New</button>
    <button class="fb" onclick="setLF('contact',this)">Contacted</button>
    <button class="fb" onclick="setLF('appt',this)">Appt Set</button>
    <button class="fb" onclick="setLF('sold',this)">Sold</button>
    <button class="fb" onclick="setLF('no',this)">Not Interested</button>
    <button class="fb" onclick="setLF('nh',this)">Not Home</button>
  </div>
  <div class="card">
    <div class="card-hd"><h3 id="lt-title">All Leads</h3><span class="meta" id="lt-ct">0</span></div>
    <div class="empty" id="lt-empty"><div class="ei">ğŸ“‹</div><div class="et">No leads yet</div><div class="es">Drop pins on the map or click "New Lead".</div></div>
    <table class="tbl" id="lt-tbl" style="display:none">
      <thead><tr><th>Status</th><th>Name</th><th>Address</th><th>Rep</th><th>Updated</th><th>Last Note</th></tr></thead>
      <tbody id="lt-body"></tbody>
    </table>
  </div>
</section>

<!-- â•”â•â• CALENDAR â•â•â•— -->

<section class="sec" id="sec-cal">
  <div class="sec-tag">Scheduling</div>
  <div class="sec-hd">
    <div><h2>ğŸ“… Appointment Calendar</h2><p>Double-click any day to add an appointment</p></div>
    <div class="sec-act">
      <div class="cal-nav"><button class="cal-arr" onclick="calNav(-1)">â€¹</button><div class="cal-lbl" id="cal-lbl"></div><button class="cal-arr" onclick="calNav(1)">â€º</button></div>
      <button class="btn btn-p btn-sm" onclick="openApptModal(null)">+ Appointment</button>
    </div>
  </div>
  <div class="cal-shell">
    <div><div class="cal-hd-row" id="cal-hd"></div><div class="cal-grid" id="cal-grid"></div></div>
    <div class="card" style="max-height:560px;overflow-y:auto">
      <div class="card-hd"><h3>Upcoming</h3></div>
      <div id="appt-list"></div>
    </div>
  </div>
</section>

<!-- â•”â•â• SALES â•â•â•— -->

<section class="sec" id="sec-sales">
  <div class="sec-tag">Performance</div>
  <div class="sec-hd">
    <div><h2>ğŸ’° Sales Log</h2><p>Every closed deal â€” Monterey County</p></div>
    <div class="sec-act"><button class="btn btn-g btn-sm" onclick="openSaleModal()">+ Log Sale</button></div>
  </div>
  <div class="g2">
    <div class="card">
      <div class="card-hd"><h3>Transactions</h3><span class="meta" id="sales-ct">0</span></div>
      <div class="empty" id="sales-empty"><div class="ei">ğŸ’°</div><div class="et">No sales yet</div></div>
      <table class="tbl" id="sales-tbl" style="display:none">
        <thead><tr><th>Date</th><th>Customer</th><th>Rep</th><th>Product</th><th>Amount</th></tr></thead>
        <tbody id="sales-body"></tbody>
      </table>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div class="kpi gr"><div class="kpi-lbl">Total Revenue</div><div class="kpi-val" id="sales-rev">$0</div><div class="kpi-sub" id="sales-sub">0 transactions</div></div>
      <div class="card"><div class="card-hd"><h3>Revenue by Rep</h3></div><div class="card-bd" id="rep-bars"><div class="empty" style="padding:14px"><div class="es">Log sales to see chart</div></div></div></div>
    </div>
  </div>
</section>

<!-- â•”â•â• LEADERBOARD â•â•â•— -->

<section class="sec" id="sec-lb">
  <div class="sec-tag">Performance</div>
  <div class="sec-hd">
    <div><h2>ğŸ† Leaderboard</h2><p>Live rankings from sales log</p></div>
    <div class="sec-act">
      <button class="btn btn-p btn-sm lb-b" onclick="setLBP('all',this)">All Time</button>
      <button class="btn btn-ghost btn-sm lb-b" onclick="setLBP('month',this)">Month</button>
      <button class="btn btn-ghost btn-sm lb-b" onclick="setLBP('week',this)">Week</button>
    </div>
  </div>
  <div class="podium" id="podium" style="display:none"></div>
  <div class="card">
    <div class="card-hd"><h3>Rankings</h3></div>
    <div class="empty" id="lb-empty"><div class="ei">ğŸ†</div><div class="et">No rankings yet</div><div class="es">Log sales to see the leaderboard.</div></div>
    <table class="tbl" id="lb-tbl" style="display:none">
      <thead><tr><th>#</th><th>Rep</th><th>Territory</th><th>Revenue</th><th>Closes</th><th>Doors</th><th>Rate</th></tr></thead>
      <tbody id="lb-body"></tbody>
    </table>
  </div>
</section>

<!-- â•”â•â• TEAM â•â•â•— -->

<section class="sec" id="sec-team">
  <div class="sec-tag">Team</div>
  <div class="sec-hd">
    <div><h2>ğŸ‘¥ Team</h2><p>Complete Home field reps â€” Monterey County</p></div>
    <div class="sec-act"><button class="btn btn-p btn-sm" onclick="openRepModal()">+ Add Rep</button></div>
  </div>
  <div class="g4" id="team-grid"></div>
</section>

<!-- â•”â•â• TERRITORIES â•â•â•— -->

<section class="sec" id="sec-areas">
  <div class="sec-tag">Field Ops</div>
  <div class="sec-hd">
    <div><h2>ğŸ—º Territories</h2><p>Monterey County canvassing zones</p></div>
    <div class="sec-act"><button class="btn btn-p btn-sm" onclick="openAreaModal()">+ Add Territory</button></div>
  </div>
  <div class="g3" id="areas-grid">
    <div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ—º</div><div class="et">No territories</div><div class="es">Add zones to organize your canvassing efforts.</div></div>
  </div>
</section>

<!-- â•”â•â• WEATHER (Open-Meteo â€” free, no key needed) â•â•â•— -->

<section class="sec" id="sec-wx">
  <div class="sec-tag">Intelligence</div>
  <div class="sec-hd">
    <div><h2>ğŸŒ¤ Weather â€” Monterey County</h2><p>Live data via Open-Meteo API Â· No API key required Â· Updates automatically</p></div>
    <div class="sec-act"><button class="btn btn-ghost btn-sm" onclick="loadWx(true)">â†» Refresh</button></div>
  </div>
  <div id="wx-alert-box"></div>
  <div id="wx-body"><div class="ld-wrap"><div class="spinner"></div><p>Fetching from Open-Meteoâ€¦</p></div></div>
</section>

</div><!-- /page -->

<!-- â•”â•â• LEAD DRAWER (Spotio-style) â•â•â•— -->

<div id="dov" onclick="closeDrawer()"></div>
<div id="drawer">
  <div class="d-hd">
    <h3 id="d-title">Lead Details</h3>
    <button class="d-x" onclick="closeDrawer()">âœ•</button>
  </div>
  <div class="d-body" id="d-body"></div>
  <div class="d-foot">
    <button class="btn btn-ghost btn-sm" onclick="closeDrawer()">Close</button>
    <button class="btn btn-r btn-sm" onclick="deleteLead()">ğŸ—‘ Delete</button>
    <button class="btn btn-p btn-sm" onclick="saveDrawer()">ğŸ’¾ Save</button>
  </div>
</div>

<!-- â•”â•â• MODALS â•â•â•— -->

<!-- Manual Lead -->

<div class="mbk" id="modal-lead">
  <div class="modal">
    <div class="mhd"><h3>ğŸ“‹ Add New Lead</h3><button class="mx" onclick="closeModal('modal-lead')">âœ•</button></div>
    <div class="mbd">
      <div class="fr2"><div class="fg"><label class="fl">First Name</label><input class="fi" id="ml-fn" placeholder="John"></div><div class="fg"><label class="fl">Last Name</label><input class="fi" id="ml-ln" placeholder="Doe"></div></div>
      <div class="fg"><label class="fl">Address *</label><input class="fi" id="ml-ad" placeholder="123 Main St, Salinas, CA 93901"></div>
      <div class="fr2"><div class="fg"><label class="fl">Phone</label><input class="fi" id="ml-ph" placeholder="(831) 555-0100" type="tel"></div><div class="fg"><label class="fl">Status</label><select class="fs" id="ml-st"><option value="new">New Lead</option><option value="nh">Not Home</option><option value="contact">Contacted</option><option value="appt">Appointment Set</option><option value="sold">Sold âœ“</option><option value="no">Not Interested</option></select></div></div>
      <div class="fr2"><div class="fg"><label class="fl">Rep</label><select class="fs" id="ml-rp"></select></div><div class="fg"><label class="fl">Territory</label><select class="fs" id="ml-ar"></select></div></div>
      <div class="fg"><label class="fl">Notes</label><textarea class="ft" id="ml-nt" placeholder="Initial notes, interest level, objectionsâ€¦"></textarea></div>
    </div>
    <div class="mft"><button class="btn btn-ghost btn-sm" onclick="closeModal('modal-lead')">Cancel</button><button class="btn btn-p btn-sm" onclick="saveManualLead()">Add Lead</button></div>
  </div>
</div>

<!-- Appointment -->

<div class="mbk" id="modal-appt">
  <div class="modal">
    <div class="mhd"><h3 id="appt-title">ğŸ“… New Appointment</h3><button class="mx" onclick="closeModal('modal-appt')">âœ•</button></div>
    <div class="mbd">
      <div class="fr2"><div class="fg"><label class="fl">Customer</label><input class="fi" id="ac" placeholder="John Doe"></div><div class="fg"><label class="fl">Phone</label><input class="fi" id="aph" type="tel"></div></div>
      <div class="fg"><label class="fl">Address</label><input class="fi" id="aa" placeholder="Customer address"></div>
      <div class="fr2"><div class="fg"><label class="fl">Date</label><input class="fi" type="date" id="ad"></div><div class="fg"><label class="fl">Time</label><input class="fi" type="time" id="at2"></div></div>
      <div class="fr2"><div class="fg"><label class="fl">Type</label><select class="fs" id="aty"><option value="demo">Product Demo</option><option value="followup">Follow-up</option><option value="close">Close / Sign</option><option value="visit">Initial Visit</option></select></div><div class="fg"><label class="fl">Rep</label><select class="fs" id="ar2"></select></div></div>
      <div class="fg"><label class="fl">Notes</label><textarea class="ft" id="an" style="min-height:54px"></textarea></div>
    </div>
    <div class="mft"><button class="btn btn-ghost btn-sm" onclick="closeModal('modal-appt')">Cancel</button><button class="btn btn-r btn-sm" id="appt-del" onclick="deleteAppt()" style="display:none">Delete</button><button class="btn btn-p btn-sm" onclick="saveAppt()">Save</button></div>
  </div>
</div>

<!-- Sale -->

<div class="mbk" id="modal-sale">
  <div class="modal">
    <div class="mhd"><h3>ğŸ’° Log Sale</h3><button class="mx" onclick="closeModal('modal-sale')">âœ•</button></div>
    <div class="mbd">
      <div class="fr2"><div class="fg"><label class="fl">Customer</label><input class="fi" id="sc2" placeholder="Full name"></div><div class="fg"><label class="fl">Date</label><input class="fi" type="date" id="sd"></div></div>
      <div class="fg"><label class="fl">Address</label><input class="fi" id="sa" placeholder="Customer address"></div>
      <div class="fr2"><div class="fg"><label class="fl">Product</label><select class="fs" id="sp"><option>Solar Basic (5kW)</option><option>Solar Plus (8kW)</option><option>Solar Premium (12kW)</option><option>Home Security Basic</option><option>Home Security Premium</option><option>Internet Package A</option><option>Internet Package B</option><option>Custom Package</option></select></div><div class="fg"><label class="fl">Amount ($)</label><input class="fi" type="number" id="sam" placeholder="5000" min="0"></div></div>
      <div class="fr2"><div class="fg"><label class="fl">Rep</label><select class="fs" id="sr"></select></div><div class="fg"><label class="fl">Territory</label><select class="fs" id="sz"></select></div></div>
    </div>
    <div class="mft"><button class="btn btn-ghost btn-sm" onclick="closeModal('modal-sale')">Cancel</button><button class="btn btn-g btn-sm" onclick="saveSale()">Log Sale</button></div>
  </div>
</div>

<!-- Area -->

<div class="mbk" id="modal-area">
  <div class="modal">
    <div class="mhd"><h3>ğŸ—º Add Territory</h3><button class="mx" onclick="closeModal('modal-area')">âœ•</button></div>
    <div class="mbd">
      <div class="fr2"><div class="fg"><label class="fl">Name</label><input class="fi" id="zn" placeholder="e.g. North Salinas"></div><div class="fg"><label class="fl">ZIP</label><input class="fi" id="zz" placeholder="93901"></div></div>
      <div class="fg"><label class="fl">Assigned Rep</label><select class="fs" id="zr"></select></div>
      <div class="fg"><label class="fl">Notes</label><textarea class="ft" id="zo" placeholder="Neighborhood type, notesâ€¦" style="min-height:54px"></textarea></div>
    </div>
    <div class="mft"><button class="btn btn-ghost btn-sm" onclick="closeModal('modal-area')">Cancel</button><button class="btn btn-p btn-sm" onclick="saveArea()">Create</button></div>
  </div>
</div>

<!-- Rep -->

<div class="mbk" id="modal-rep">
  <div class="modal">
    <div class="mhd"><h3>ğŸ‘¤ Add Team Member</h3><button class="mx" onclick="closeModal('modal-rep')">âœ•</button></div>
    <div class="mbd">
      <div class="fr2"><div class="fg"><label class="fl">First Name</label><input class="fi" id="rf" placeholder="First"></div><div class="fg"><label class="fl">Last Name</label><input class="fi" id="rl" placeholder="Last"></div></div>
      <div class="fr2"><div class="fg"><label class="fl">Role</label><select class="fs" id="rr"><option value="rep">Sales Rep</option><option value="manager">Manager</option></select></div><div class="fg"><label class="fl">Phone</label><input class="fi" id="rph" type="tel"></div></div>
      <div class="fg"><label class="fl">Territory</label><select class="fs" id="ra"></select></div>
    </div>
    <div class="mft"><button class="btn btn-ghost btn-sm" onclick="closeModal('modal-rep')">Cancel</button><button class="btn btn-p btn-sm" onclick="saveRep()">Add</button></div>
  </div>
</div>

<div id="toasts"></div>

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPLETE HOME â€” MONTEREY COUNTY
   Real-time sync via Gun.js (free, no server, no account needed)
   All data stored per team namespace in Gun's distributed network
   Falls back to localStorage for offline resilience
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ GUN PEERS (public relays â€” multiple for redundancy) â”€â”€ */
const GUN_PEERS = [
  'https://peer.wallie.io/gun',
  'https://gun-us.herokuapp.com/gun',
  'wss://gun-on-heroku.onrender.com/gun'
];

let GUN = null;   // Gun instance
let NS  = null;   // Team namespace node in Gun
let TEAM_CODE = '';

const TEAM_LS_KEY = 'ch_team_v1';

/* â”€â”€ IN-MEMORY STATE (populated by Gun listeners) â”€â”€ */
const DB = {
  pins:[], appts:[], sales:[], areas:[],
  reps:[
    {id:'rep_darrell',  fname:'Darrell', lname:'',         role:'CEO',     phone:'', areaId:'', color:'#2563eb'},
    {id:'rep_king',     fname:'King',    lname:'Cannon',   role:'manager', phone:'', areaId:'', color:'#8b5cf6'},
    {id:'rep_shafik',   fname:'Shafik',  lname:'Elafrangi',role:'manager', phone:'', areaId:'', color:'#f59e0b'},
    {id:'rep_sly',      fname:'Sly',     lname:'Walker',   role:'manager', phone:'', areaId:'', color:'#06b6d4'}
  ]
};

/* â”€â”€ CONSTANTS â”€â”€ */
const PCOLS   = ['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#ec4899'];
const PCOLORS = {nh:'#475569',new:'#3b82f6',contact:'#f59e0b',appt:'#8b5cf6',sold:'#10b981',no:'#ef4444'};
const PLBL    = {nh:'Not Home',new:'New Lead',contact:'Contacted',appt:'Appt Set',sold:'Sold',no:'Not Interested'};
const PBDG    = {nh:'b-gy',new:'b-bl',contact:'b-am',appt:'b-vi',sold:'b-gr',no:'b-re'};

/* â”€â”€ ACTIVITY FEED (local, synced to gun) â”€â”€ */
let feed = [];

/* â”€â”€ UTILS â”€â”€ */
const $ = id => document.getElementById(id);
const iso    = () => new Date().toISOString().slice(0,10);
const tsNow  = () => new Date().toISOString();
const newId  = () => Date.now().toString(36) + Math.random().toString(36).slice(2,6);
const rName  = id => { const r=DB.reps.find(x=>x.id===id); return r?`${r.fname} ${r.lname}`.trim():'â€”'; };
const rObj   = id => DB.reps.find(x=>x.id===id);
const fmt$   = n  => '$'+(+n||0).toLocaleString();
const fmtT   = t  => { if(!t)return''; const[h,m]=t.split(':'); const hr=+h; return`${hr>12?hr-12:hr||12}:${m} ${hr>=12?'PM':'AM'}`; };
const inits  = r  => r?(r.fname[0]||'')+(r.lname[0]||''):'?';
const ago    = ts => { if(!ts)return''; const s=Math.floor((Date.now()-new Date(ts).getTime())/1000); if(s<60)return'just now'; if(s<3600)return Math.floor(s/60)+'m ago'; if(s<86400)return Math.floor(s/3600)+'h ago'; return Math.floor(s/86400)+'d ago'; };

function toast(msg, type='in') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span>${{ok:'âœ…',er:'âŒ',in:'â„¹ï¸'}[type]||'â„¹ï¸'}</span><span>${msg}</span>`;
  $('toasts').appendChild(el);
  setTimeout(() => { el.style.opacity='0'; el.style.transform='translateX(12px)'; el.style.transition='all .3s'; setTimeout(()=>el.remove(),300); }, 3200);
}
function openModal(id){$(id).classList.add('open');}
function closeModal(id){$(id).classList.remove('open');}
document.querySelectorAll('.mbk').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));

function popRep(id) {
  const el=$(id); if(!el)return; const p=el.value;
  el.innerHTML='<option value="">Select repâ€¦</option>'+DB.reps.map(r=>`<option value="${r.id}">${`${r.fname} ${r.lname}`.trim()} (${r.role})</option>`).join('');
  el.value=p;
}
function popArea(id) {
  const el=$(id); if(!el)return; const p=el.value;
  el.innerHTML='<option value="">No territory</option>'+DB.areas.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  el.value=p;
}
function popAll() {
  ['ml-rp','ar2','sr','zr','ra'].forEach(popRep);
  ['ml-ar','sz'].forEach(popArea);
}

function setSyncStatus(s) {
  const dot=$('sdot'), lbl=$('slbl');
  if(!dot)return;
  dot.className='sdot '+{live:'live',syncing:'sync',offline:'off'}[s];
  lbl.textContent={live:'Live',syncing:'Syncingâ€¦',offline:'Offline'}[s]||s;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEAM JOIN / LEAVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function quickJoin(code) {
  $('join-code').value = code;
  doJoin();
}
function doJoin() {
  const raw = ($('join-code').value||'').trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
  if(!raw) { toast('Enter a team code','er'); return; }
  TEAM_CODE = raw;
  localStorage.setItem(TEAM_LS_KEY, raw);
  $('join-overlay').style.display = 'none';
  $('team-disp').textContent = raw;
  initGun();
  initMap();
  setupSpy();
  setupLazy();
  document.querySelectorAll('input[type=date]').forEach(el=>{if(!el.value)el.value=iso();});
  toast(`Connected to team ${raw}`,'ok');
}
function confirmLeave() {
  if(!confirm(`Leave team "${TEAM_CODE}"? You can rejoin any time with the same code.`))return;
  localStorage.removeItem(TEAM_LS_KEY);
  location.reload();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GUN.JS REAL-TIME SYNC LAYER
   Each record stored as JSON string by ID.
   Gun's .map().on() fires for:
     â€¢ All existing records on first connect
     â€¢ Every future change from any device
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let renderTimer = null;
function schedRender() {
  clearTimeout(renderTimer);
  renderTimer = setTimeout(fullRender, 250);
}
function fullRender() {
  updateMapUI(); renderDash(); renderLeadsTable();
  renderSales(); renderLeaderboard(); renderTeam(); renderAreas(); renderCal();
  popAll();
}

function gunSave(collection, item) {
  if(!NS)return;
  setSyncStatus('syncing');
  NS.get(collection).get(String(item.id)).put(JSON.stringify(item), () => setSyncStatus('live'));
}
function gunDel(collection, id) {
  if(!NS)return;
  NS.get(collection).get(String(id)).put(null);
}

function initGun() {
  GUN = new Gun({ peers: GUN_PEERS, localStorage: false });
  NS = GUN.get('completehome_v1_' + TEAM_CODE);

  /* Monitor connection */
  GUN.on('hi',  () => setSyncStatus('live'));
  GUN.on('bye', () => setSyncStatus('offline'));
  setTimeout(() => setSyncStatus('live'), 1500);

  /* â”€â”€ SYNC: PINS â”€â”€ */
  NS.get('pins').map().on((json, key) => {
    if(!json) {
      const had = DB.pins.findIndex(p=>p.id===key);
      if(had>=0) {
        DB.pins.splice(had,1);
        if(mkrs[key]) { if(lmap) lmap.removeLayer(mkrs[key]); delete mkrs[key]; }
        schedRender();
      }
      return;
    }
    try {
      const pin = JSON.parse(json);
      const idx = DB.pins.findIndex(p=>p.id===key);
      if(idx>=0) {
        DB.pins[idx] = pin;
        if(mkrs[key]) mkrs[key].setIcon(mkIco(pin.status));
      } else {
        DB.pins.push(pin);
        if(lmap && !mkrs[key]) placeMkr(pin);
      }
      if(drawerPin===key) { const p=DB.pins.find(x=>x.id===key); if(p) renderDrawerContent(p); }
    } catch(e){}
    schedRender();
  });

  /* â”€â”€ SYNC: SALES â”€â”€ */
  NS.get('sales').map().on((json, key) => {
    if(!json) { DB.sales=DB.sales.filter(s=>s.id!==key); schedRender(); return; }
    try {
      const sale = JSON.parse(json);
      const idx = DB.sales.findIndex(s=>s.id===key);
      if(idx>=0) DB.sales[idx]=sale; else DB.sales.push(sale);
    } catch(e){}
    schedRender();
  });

  /* â”€â”€ SYNC: APPOINTMENTS â”€â”€ */
  NS.get('appts').map().on((json, key) => {
    if(!json) { DB.appts=DB.appts.filter(a=>a.id!==key); schedRender(); return; }
    try {
      const appt = JSON.parse(json);
      const idx = DB.appts.findIndex(a=>a.id===key);
      if(idx>=0) DB.appts[idx]=appt; else DB.appts.push(appt);
    } catch(e){}
    schedRender();
  });

  /* â”€â”€ SYNC: AREAS â”€â”€ */
  NS.get('areas').map().on((json, key) => {
    if(!json) { DB.areas=DB.areas.filter(a=>a.id!==key); schedRender(); return; }
    try {
      const area = JSON.parse(json);
      const idx = DB.areas.findIndex(a=>a.id===key);
      if(idx>=0) DB.areas[idx]=area; else DB.areas.push(area);
    } catch(e){}
    schedRender();
  });

  /* â”€â”€ SYNC: REPS â”€â”€ */
  NS.get('reps').map().on((json, key) => {
    if(!json) return;
    try {
      const rep = JSON.parse(json);
      const idx = DB.reps.findIndex(r=>r.id===key);
      if(idx>=0) DB.reps[idx]=rep; else DB.reps.push(rep);
    } catch(e){}
    schedRender();
  });

  /* â”€â”€ SYNC: ACTIVITY FEED â”€â”€ */
  NS.get('feed').on((json) => {
    if(!json)return;
    try {
      const remote = JSON.parse(json);
      if(Array.isArray(remote)) { feed=remote; renderDash(); }
    } catch(e){}
  });

  /* â”€â”€ SEED DEFAULT REPS (only if namespace is brand new) â”€â”€ */
  NS.get('reps').once(data => {
    if(!data || Object.keys(data).filter(k=>k!=='_').length===0) {
      DB.reps.forEach(r => NS.get('reps').get(r.id).put(JSON.stringify(r)));
    }
  });
}

function addFeed(icon, title, sub, bg) {
  feed.unshift({icon,title,sub,bg,ts:tsNow()});
  if(feed.length>50) feed.pop();
  if(NS) NS.get('feed').put(JSON.stringify(feed));
  renderDash();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCROLL SPY NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sc(id) {
  const el=$(id); if(!el)return;
  const nh=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--nh'))||54;
  window.scrollTo({top:el.getBoundingClientRect().top+window.scrollY-nh-4,behavior:'smooth'});
}
function setupSpy() {
  const secs=document.querySelectorAll('section[id]');
  const btns=document.querySelectorAll('.nb');
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(!e.isIntersecting)return;
      btns.forEach(b=>b.classList.remove('on'));
      const b=[...btns].find(b=>b.getAttribute('onclick')===`sc('${e.target.id}')`);
      if(b)b.classList.add('on');
    });
  },{threshold:0.15,rootMargin:'-54px 0px -55% 0px'});
  secs.forEach(s=>obs.observe(s));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDash() {
  const pins=DB.pins.length, sold=DB.pins.filter(p=>p.status==='sold').length;
  const rev=DB.sales.reduce((s,x)=>s+(+x.amount||0),0);
  $('db-pins').textContent=pins.toLocaleString();
  $('db-rev').textContent=fmt$(rev);
  $('db-appts').textContent=DB.appts.length;
  $('db-rate').textContent=pins>0?(sold/pins*100).toFixed(1)+'%':'0%';
  $('dash-feed').innerHTML=!feed.length
    ?'<div class="empty"><div class="ei">ğŸ“‹</div><div class="et">No activity yet</div></div>'
    :feed.slice(0,8).map(a=>`<div class="act-item"><div class="act-ic" style="background:${a.bg}">${a.icon}</div><div style="flex:1;min-width:0"><div class="act-ttl">${a.title}</div><div class="act-sub">${a.sub}</div></div><div class="act-ts">${ago(a.ts)}</div></div>`).join('');
  const t=iso();
  const ta=DB.appts.filter(a=>a.date===t).sort((a,b)=>a.time.localeCompare(b.time));
  $('dash-today').innerHTML=!ta.length
    ?'<div class="empty" style="padding:24px"><div class="ei">ğŸ“…</div><div class="et">No appointments today</div></div>'
    :ta.map(a=>`<div class="appt-item" onclick="openApptModal(null,'${a.id}')"><div class="at">${fmtT(a.time)}</div><div class="an">${a.cust}</div><div class="ad">${a.addr||''}</div><div class="ad">${rName(a.rep)}</div></div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lmap=null, tool='pin', mkrs={}, activePin=null;
let lPts=[], lLG=null;

function mkIco(s) {
  const c=PCOLORS[s]||'#475569';
  return L.divIcon({
    html:`<div style="width:14px;height:14px;border-radius:50%;background:${c};border:2.5px solid rgba(255,255,255,.45);box-shadow:0 0 0 1px rgba(0,0,0,.3),0 2px 8px rgba(0,0,0,.5),0 0 10px ${c}55;cursor:pointer"></div>`,
    className:'',iconSize:[14,14],iconAnchor:[7,7]
  });
}
function initMap() {
  lmap=L.map('lmap',{center:[36.6002,-121.8947],zoom:11});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'Â© <a href="https://openstreetmap.org">OpenStreetMap</a>',maxZoom:20
  }).addTo(lmap);
  lLG=L.layerGroup().addTo(lmap);
  lmap.on('click',onMapClick);
  document.addEventListener('keydown',e=>{
    if(!lmap)return;
    if(e.key==='Escape'&&tool==='lasso')cancelLasso();
    if(e.key==='Enter'&&tool==='lasso'&&lPts.length>=3)finishLasso();
  });
  updateMapUI();
}
function setTool(t) {
  tool=t;
  ['tool-pin','tool-pin-bar'].forEach(id=>{const e=$(id);if(e)e.classList.toggle('on',t==='pin');});
  ['tool-lasso','tool-lasso-bar'].forEach(id=>{const e=$(id);if(e)e.classList.toggle('on',t==='lasso');});
  if(lmap)lmap.getContainer().style.cursor=t==='lasso'?'crosshair':'';
  if(t==='pin') cancelLasso();
  else { $('lasso-hint').style.display='block'; $('lasso-hint').textContent='Click to draw points â€” Enter to finish Â· Esc to cancel'; }
}
function onMapClick(e) {
  if(tool==='pin') dropPin(e.latlng);
  else if(tool==='lasso') addLPt(e.latlng);
}
function dropPin(ll) {
  const pin={
    id:newId(), lat:ll.lat, lng:ll.lng,
    addr:`${ll.lat.toFixed(5)}, ${ll.lng.toFixed(5)}`,
    fname:'',lname:'',phone:'',
    status:'new',rep:'',areaId:'',
    history:[{action:'Lead created â€” pin dropped on map',status:'new',note:'',ts:tsNow()}],
    createdAt:tsNow(), updatedAt:tsNow()
  };
  DB.pins.push(pin); placeMkr(pin); gunSave('pins',pin);
  updateMapUI(); addFeed('ğŸ“','Pin dropped',pin.addr,'var(--bg2)');
  openDrawer(pin.id);
}
function placeMkr(pin) {
  const m=L.marker([pin.lat,pin.lng],{icon:mkIco(pin.status),draggable:true}).addTo(lmap);
  m.on('click',()=>openDrawer(pin.id));
  m.on('dragend',e=>{
    const ll=e.target.getLatLng();
    pin.lat=ll.lat; pin.lng=ll.lng;
    pin.addr=`${ll.lat.toFixed(5)}, ${ll.lng.toFixed(5)}`;
    pin.updatedAt=tsNow();
    gunSave('pins',pin); renderSidePanel();
  });
  mkrs[pin.id]=m;
}
function updateMapUI() {
  const total=DB.pins.length;
  const sold=DB.pins.filter(p=>p.status==='sold').length;
  const appt=DB.pins.filter(p=>p.status==='appt').length;
  const nh=DB.pins.filter(p=>p.status==='nh').length;
  $('ms-tot').textContent=total; $('ms-sold').textContent=sold;
  $('ms-appt').textContent=appt; $('ms-nh').textContent=nh;
  $('map-ct').textContent=total+' pin'+(total!==1?'s':'');
  renderSidePanel(); renderDash(); renderLeadsTable();
}
let sideFilt='';
function filterPanel(v){sideFilt=v.toLowerCase();renderSidePanel();}
function renderSidePanel() {
  const pl=$('pin-list');
  const pins=[...DB.pins].filter(p=>{
    if(!sideFilt)return true;
    return(`${p.fname||''} ${p.lname||''} ${p.addr||''}`).toLowerCase().includes(sideFilt);
  }).sort((a,b)=>new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt));
  if(!pins.length) {
    pl.innerHTML=`<div class="empty" style="padding:24px 10px"><div class="ei" style="font-size:20px">ğŸ“</div><div class="et" style="font-size:12px">${DB.pins.length?'No matches':'No leads yet'}</div><div class="es" style="font-size:11px">Click the map to drop a pin.</div></div>`;
    return;
  }
  pl.innerHTML=pins.map(p=>{
    const name=(p.fname||p.lname)?`${p.fname||''} ${p.lname||''}`.trim():'Unnamed Lead';
    return `<div class="prow${activePin===p.id?' act':''}" onclick="openDrawer('${p.id}')">
      <div class="pdot" style="background:${PCOLORS[p.status]||'#475569'}"></div>
      <div style="flex:1;min-width:0"><div class="pname">${name}</div><div class="paddr">${p.addr||''}</div></div>
      <div class="pago">${ago(p.updatedAt||p.createdAt)}</div>
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEAD DRAWER (Spotio-style)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let drawerPin=null;
function openDrawer(id) {
  const pin=DB.pins.find(p=>p.id===id); if(!pin)return;
  drawerPin=id; activePin=id;
  popAll(); renderSidePanel(); renderDrawerContent(pin);
  $('drawer').classList.add('open'); $('dov').style.display='block';
}
function closeDrawer() {
  $('drawer').classList.remove('open'); $('dov').style.display='none';
  drawerPin=null; activePin=null; renderSidePanel();
}
function renderDrawerContent(pin) {
  const name=(pin.fname||pin.lname)?`${pin.fname||''} ${pin.lname||''}`.trim():'Unnamed Lead';
  $('d-title').textContent=`ğŸ“ ${name}`;
  const scfg={
    nh:     {label:'Not Home',      c:'#475569',bg:'rgba(71,85,105,.18)'},
    new:    {label:'New Lead',      c:'#3b82f6',bg:'rgba(59,130,246,.15)'},
    contact:{label:'Contacted',     c:'#f59e0b',bg:'rgba(245,158,11,.15)'},
    appt:   {label:'Appt Set',      c:'#8b5cf6',bg:'rgba(139,92,246,.15)'},
    sold:   {label:'Sold âœ“',        c:'#10b981',bg:'rgba(16,185,129,.15)'},
    no:     {label:'Not Interested',c:'#ef4444',bg:'rgba(239,68,68,.15)'},
  };
  $('d-body').innerHTML=`
    <div class="d-sect">
      <div class="d-stitle">Contact Info</div>
      <div class="fr2" style="margin-bottom:9px">
        <div class="fg"><label class="fl">First Name</label><input class="fi" id="d-fn" value="${pin.fname||''}" placeholder="First"></div>
        <div class="fg"><label class="fl">Last Name</label><input class="fi" id="d-ln" value="${pin.lname||''}" placeholder="Last"></div>
      </div>
      <div class="fg"><label class="fl">Address</label><input class="fi" id="d-addr" value="${pin.addr||''}" placeholder="Address"></div>
      <div class="fr2">
        <div class="fg"><label class="fl">Phone</label><input class="fi" id="d-ph" value="${pin.phone||''}" type="tel"></div>
        <div class="fg"><label class="fl">Rep</label>
          <select class="fs" id="d-rep"><option value="">â€”</option>${DB.reps.map(r=>`<option value="${r.id}"${r.id===pin.rep?' selected':''}>${`${r.fname||''} ${r.lname||''}`.trim()}</option>`).join('')}</select>
        </div>
      </div>
      <div class="fg"><label class="fl">Territory</label>
        <select class="fs" id="d-area"><option value="">No territory</option>${DB.areas.map(a=>`<option value="${a.id}"${a.id===pin.areaId?' selected':''}>${a.name}</option>`).join('')}</select>
      </div>
    </div>
    <div class="d-sect">
      <div class="d-stitle">Lead Status â€” click to update</div>
      <div class="status-grid">
        ${Object.entries(scfg).map(([k,v])=>`
          <button class="spill${pin.status===k?' active-s':''}"
            style="background:${pin.status===k?v.bg:'transparent'};color:${v.c};border-color:${v.c}${pin.status===k?';border-width:2px':''}"
            onclick="setLeadStatus('${k}')">
            ${v.label}
          </button>`).join('')}
      </div>
    </div>
    <div class="d-sect">
      <div class="d-stitle">Add Note / Update</div>
      <textarea class="ft" id="d-note" placeholder="Outcome, objection, price discussed, follow-up neededâ€¦" style="margin-bottom:8px;min-height:80px"></textarea>

```
  <button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center" onclick="addNote()">+ Save Note to Timeline</button>
</div>
<div class="d-sect">
  <div class="d-stitle">Activity Timeline</div>
  <div class="timeline" id="d-timeline">${buildTimeline(pin)}</div>
</div>`;
```

}
function buildTimeline(pin) {
if(!pin.history||!pin.history.length) return â€˜<div style="font-size:11px;color:var(--t3);padding:6px 0">No activity yet.</div>â€™;
return pin.history.map(h=>{
const c=PCOLORS[h.status]||â€™#475569â€™;
return `<div class="tl-item"> <div class="tl-dot" style="background:${c}22;color:${c};border-color:${c}55">â—</div> <div class="tl-b"> <div class="tl-act">${h.action}</div> ${h.note?`<div class="tl-note">${h.note}</div>`:''} <div class="tl-when">${ago(h.ts)} Â· ${new Date(h.ts).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div> </div> </div>`;
}).join(â€™â€™);
}
function setLeadStatus(s) {
const pin=DB.pins.find(p=>p.id===drawerPin); if(!pin)return;
pin.status=s; pin.updatedAt=tsNow();
pin.history.unshift({action:`Status â†’ ${PLBL[s]}`,status:s,note:â€™â€™,ts:tsNow()});
if(mkrs[pin.id]) mkrs[pin.id].setIcon(mkIco(s));
gunSave(â€˜pinsâ€™,pin);
updateMapUI(); renderLeadsTable(); renderDrawerContent(pin);
addFeed(â€˜ğŸ”„â€™,`${pin.fname||'Lead'} â†’ ${PLBL[s]}`,pin.addr||â€™â€™,â€˜var(â€“vg)â€™);
toast(`Status: ${PLBL[s]}`,â€˜okâ€™);
}
function addNote() {
const pin=DB.pins.find(p=>p.id===drawerPin); if(!pin)return;
const note=(($(â€˜d-noteâ€™).value)||â€™â€™).trim();
if(!note){toast(â€˜Enter a note firstâ€™,â€˜erâ€™);return;}
pin.updatedAt=tsNow();
pin.history.unshift({action:â€˜Note addedâ€™,status:pin.status,note,ts:tsNow()});
$(â€˜d-noteâ€™).value=â€™â€™;
gunSave(â€˜pinsâ€™,pin);
renderSidePanel(); renderLeadsTable();
$(â€˜d-timelineâ€™).innerHTML=buildTimeline(pin);
addFeed(â€˜ğŸ“â€™,`Note: ${(pin.fname||'Lead').slice(0,12)}`,note.slice(0,40),â€˜var(â€“ag)â€™);
toast(â€˜Note saved and syncedâ€™,â€˜okâ€™);
}
function saveDrawer() {
const pin=DB.pins.find(p=>p.id===drawerPin); if(!pin)return;
const fn=($(â€˜d-fnâ€™).value||â€™â€™).trim(), ln=($(â€˜d-lnâ€™).value||â€™â€™).trim();
const changed=fn!==pin.fname||ln!==pin.lname||($(â€˜d-phâ€™).value||â€™â€™).trim()!==pin.phone;
pin.fname=fn; pin.lname=ln;
const na=($(â€˜d-addrâ€™).value||â€™â€™).trim(); if(na&&na!==pin.addr) pin.addr=na;
pin.phone=($(â€˜d-phâ€™).value||â€™â€™).trim();
pin.rep=$(â€˜d-repâ€™).value; pin.areaId=$(â€˜d-areaâ€™).value;
pin.updatedAt=tsNow();
if(changed) pin.history.unshift({action:â€˜Contact info updatedâ€™,status:pin.status,note:â€™â€™,ts:tsNow()});
gunSave(â€˜pinsâ€™,pin);
updateMapUI(); renderLeadsTable();
$(â€˜d-titleâ€™).textContent=`ğŸ“ ${fn||ln?`${fn} ${ln}`.trim():'Unnamed Lead'}`;
toast(â€˜Lead saved and syncedâ€™,â€˜okâ€™);
}
function deleteLead() {
const pin=DB.pins.find(p=>p.id===drawerPin); if(!pin)return;
if(!confirm(`Delete lead for ${pin.fname||pin.addr||'this pin'}?`))return;
if(mkrs[drawerPin]){if(lmap)lmap.removeLayer(mkrs[drawerPin]);delete mkrs[drawerPin];}
DB.pins=DB.pins.filter(p=>p.id!==drawerPin);
gunDel(â€˜pinsâ€™,drawerPin);
closeDrawer(); updateMapUI(); toast(â€˜Lead deletedâ€™,â€˜inâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
LASSO TOOL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addLPt(ll) {
lPts.push(ll); lLG.clearLayers();
if(lPts.length===1){
L.circleMarker(ll,{radius:5,color:â€™#3b82f6â€™,fillColor:â€™#3b82f6â€™,fillOpacity:1,weight:2}).addTo(lLG);
$(â€˜lasso-hintâ€™).textContent=â€˜First point â€” keep clicking to draw the areaâ€™;
} else {
L.polygon(lPts,{color:â€™#3b82f6â€™,fillColor:â€™#3b82f6â€™,fillOpacity:.07,weight:2,dashArray:â€˜6,4â€™}).addTo(lLG);
lPts.forEach((pt,i)=>L.circleMarker(pt,{radius:i===0?5:3,color:â€™#3b82f6â€™,fillColor:i===0?â€™#3b82f6â€™:â€™#f1f5f9â€™,fillOpacity:1,weight:2}).addTo(lLG));
$(â€˜lasso-hintâ€™).textContent=`${lPts.length} points â€” Enter to generate leads Â· Esc to cancel`;
}
}
function cancelLasso() {
lPts=[]; if(lLG)lLG.clearLayers();
$(â€˜lasso-hintâ€™).style.display=â€˜noneâ€™;
tool=â€˜pinâ€™;
[â€˜tool-pinâ€™,â€˜tool-pin-barâ€™].forEach(id=>{const e=$(id);if(e)e.classList.add(â€˜onâ€™);});
[â€˜tool-lassoâ€™,â€˜tool-lasso-barâ€™].forEach(id=>{const e=$(id);if(e)e.classList.remove(â€˜onâ€™);});
if(lmap)lmap.getContainer().style.cursor=â€™â€™;
}
async function finishLasso() {
if(lPts.length<3){toast(â€˜Draw at least 3 pointsâ€™,â€˜erâ€™);return;}
$(â€˜lasso-hintâ€™).style.display=â€˜noneâ€™;
const ldr=$(â€˜map-ldrâ€™); ldr.classList.add(â€˜onâ€™);
$(â€˜ldr-msgâ€™).textContent=â€˜Querying OpenStreetMapâ€¦â€™;
const lats=lPts.map(p=>p.lat), lngs=lPts.map(p=>p.lng);
const s=Math.min(â€¦lats)-.001, n=Math.max(â€¦lats)+.001;
const w=Math.min(â€¦lngs)-.001, e2=Math.max(â€¦lngs)+.001;
const q=`[out:json][timeout:25];(node["addr:housenumber"](${s},${w},${n},${e2});way["building"](${s},${w},${n},${e2}););out center;`;
let added=0;
try {
const res=await fetch(â€˜https://overpass-api.de/api/interpreter?data=â€™+encodeURIComponent(q));
if(!res.ok) throw new Error(â€˜Overpass â€˜+res.status);
const data=await res.json();
$(â€˜ldr-msgâ€™).textContent=`Placing ${data.elements.length} pinsâ€¦`;
for(const el of data.elements) {
const lat=el.type===â€˜nodeâ€™?el.lat:el.center?.lat;
const lng=el.type===â€˜nodeâ€™?el.lon:el.center?.lon;
if(!lat||!lng||!ptInPoly({lat,lng},lPts)) continue;
const hn=el.tags?.[â€˜addr:housenumberâ€™]||â€™â€™, st=el.tags?.[â€˜addr:streetâ€™]||â€™â€™;
const addr=hn&&st?`${hn} ${st}`:`${lat.toFixed(5)}, ${lng.toFixed(5)}`;
const pin={id:newId(),lat,lng,addr,fname:â€™â€™,lname:â€™â€™,phone:â€™â€™,status:â€˜nhâ€™,rep:â€™â€™,areaId:â€™â€™,history:[{action:â€˜Lead created via lasso scanâ€™,status:â€˜nhâ€™,note:â€™â€™,ts:tsNow()}],createdAt:tsNow(),updatedAt:tsNow()};
DB.pins.push(pin); placeMkr(pin); gunSave(â€˜pinsâ€™,pin); added++;
}
if(!added) {
$(â€˜ldr-msgâ€™).textContent=â€˜No OSM data â€” using gridâ€¦â€™;
await new Promise(r=>setTimeout(r,400));
for(const g of gridPoly(lPts)) {
const pin={id:newId(),â€¦g,fname:â€™â€™,lname:â€™â€™,phone:â€™â€™,status:â€˜nhâ€™,rep:â€™â€™,areaId:â€™â€™,history:[{action:â€˜Lead created via lassoâ€™,status:â€˜nhâ€™,note:â€™â€™,ts:tsNow()}],createdAt:tsNow(),updatedAt:tsNow()};
DB.pins.push(pin); placeMkr(pin); gunSave(â€˜pinsâ€™,pin); added++;
}
}
updateMapUI();
addFeed(â€˜âœï¸â€™,â€˜Lasso scanâ€™,`${added} leads generated`,â€˜var(â€“gg)â€™);
toast(`${added} leads created and synced to team`,â€˜okâ€™);
} catch(err) {
toast(`Overpass failed: ${err.message}`,â€˜erâ€™);
} finally { ldr.classList.remove(â€˜onâ€™); cancelLasso(); }
}
function ptInPoly(pt,poly){let inside=false;for(let i=0,j=poly.length-1;i<poly.length;j=i++){const xi=poly[i].lat,yi=poly[i].lng,xj=poly[j].lat,yj=poly[j].lng;if(((yi>pt.lng)!==(yj>pt.lng))&&(pt.lat<(xj-xi)*(pt.lng-yi)/(yj-yi)+xi))inside=!inside;}return inside;}
function gridPoly(poly){const lats=poly.map(p=>p.lat),lngs=poly.map(p=>p.lng),s=Math.min(â€¦lats),n=Math.max(â€¦lats),w=Math.min(â€¦lngs),e=Math.max(â€¦lngs),pts=[];for(let lat=s;lat<=n;lat+=.00045)for(let lng=w;lng<=e;lng+=.00045)if(ptInPoly({lat,lng},poly))pts.push({lat,lng,addr:`${lat.toFixed(5)}, ${lng.toFixed(5)}`});return pts.slice(0,200);}
function clearAllPins() {
if(!DB.pins.length)return;
if(!confirm(`Permanently delete ALL ${DB.pins.length} leads for the whole team?`))return;
Object.entries(mkrs).forEach(([id,m])=>{if(lmap)lmap.removeLayer(m);});
mkrs={};
const ids=DB.pins.map(p=>p.id); DB.pins=[];
ids.forEach(id=>gunDel(â€˜pinsâ€™,id));
updateMapUI(); toast(â€˜All leads clearedâ€™,â€˜inâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ALL LEADS TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lfilt=â€˜allâ€™;
function setLF(f,btn){lfilt=f;document.querySelectorAll(â€™.fbâ€™).forEach(b=>b.classList.remove(â€˜onâ€™));btn.classList.add(â€˜onâ€™);renderLeadsTable();}
function renderLeadsTable() {
const q=(($(â€˜lead-srchâ€™)||{value:â€™â€™}).value||â€™â€™).toLowerCase();
const pins=DB.pins.filter(p=>{
if(lfilt!==â€˜allâ€™&&p.status!==lfilt)return false;
if(q)return(`${p.fname||''} ${p.lname||''} ${p.addr||''}`).toLowerCase().includes(q);
return true;
}).sort((a,b)=>new Date(b.updatedAt||b.createdAt)-new Date(a.updatedAt||a.createdAt));
$(â€˜lt-ctâ€™).textContent=pins.length+â€™ leadsâ€™;
$(â€˜lt-titleâ€™).textContent=lfilt===â€˜allâ€™?â€˜All Leadsâ€™:(PLBL[lfilt]||â€˜Leadsâ€™);
const em=$(â€˜lt-emptyâ€™),tbl=$(â€˜lt-tblâ€™);
if(!pins.length){em.style.display=â€˜flexâ€™;tbl.style.display=â€˜noneâ€™;return;}
em.style.display=â€˜noneâ€™; tbl.style.display=â€˜tableâ€™;
$(â€˜lt-bodyâ€™).innerHTML=pins.map(p=>{
const name=(p.fname||p.lname)?`${p.fname||''} ${p.lname||''}`.trim():â€˜Unnamedâ€™;
const last=p.history&&p.history[0]?p.history[0].note||p.history[0].action:â€™â€”â€™;
return `<tr onclick="openDrawer('${p.id}')"> <td><span class="badge ${PBDG[p.status]||'b-gy'}">${PLBL[p.status]||p.status}</span></td> <td class="pri">${name}</td> <td class="mono" style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.addr||''}</td> <td>${rName(p.rep)}</td> <td class="mono">${ago(p.updatedAt||p.createdAt)}</td> <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;color:var(--t3)">${last}</td> </tr>`;
}).join(â€™â€™);
}
function exportCSV() {
const rows=[[â€˜IDâ€™,â€˜Firstâ€™,â€˜Lastâ€™,â€˜Addressâ€™,â€˜Phoneâ€™,â€˜Statusâ€™,â€˜Repâ€™,â€˜Territoryâ€™,â€˜Createdâ€™,â€˜Updatedâ€™,â€˜Last Noteâ€™]];
DB.pins.forEach(p=>{
const zone=p.areaId?DB.areas.find(a=>a.id===p.areaId)?.name||â€™â€™:â€™â€™;
const last=p.history&&p.history[0]?p.history[0].note||p.history[0].action:â€™â€™;
rows.push([p.id,p.fname||â€™â€™,p.lname||â€™â€™,p.addr||â€™â€™,p.phone||â€™â€™,PLBL[p.status]||p.status,rName(p.rep),zone,p.createdAt||â€™â€™,p.updatedAt||â€™â€™,last]);
});
const csv=rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(â€™,â€™)).join(â€™\nâ€™);
const a=document.createElement(â€˜aâ€™); a.href=â€˜data:text/csv;charset=utf-8,â€™+encodeURIComponent(csv);
a.download=`completehome_leads_${iso()}.csv`; a.click(); toast(â€˜CSV exportedâ€™,â€˜okâ€™);
}
function openManualLeadModal() {
popAll(); [â€˜ml-fnâ€™,â€˜ml-lnâ€™,â€˜ml-adâ€™,â€˜ml-phâ€™,â€˜ml-ntâ€™].forEach(id=>{const e=$(id);if(e)e.value=â€™â€™;});
$(â€˜ml-stâ€™).value=â€˜newâ€™; openModal(â€˜modal-leadâ€™);
}
function saveManualLead() {
const addr=($(â€˜ml-adâ€™).value||â€™â€™).trim(); if(!addr){toast(â€˜Address requiredâ€™,â€˜erâ€™);return;}
const fn=($(â€˜ml-fnâ€™).value||â€™â€™).trim(), ln=($(â€˜ml-lnâ€™).value||â€™â€™).trim();
const pin={id:newId(),lat:36.6002,lng:-121.8947,addr,fname:fn,lname:ln,
phone:($(â€˜ml-phâ€™).value||â€™â€™).trim(),status:$(â€˜ml-stâ€™).value,
rep:$(â€˜ml-rpâ€™).value,areaId:$(â€˜ml-arâ€™).value,
history:[{action:â€˜Lead added manuallyâ€™,status:$(â€˜ml-stâ€™).value,note:($(â€˜ml-ntâ€™).value||â€™â€™).trim(),ts:tsNow()}],
createdAt:tsNow(),updatedAt:tsNow()};
DB.pins.push(pin); placeMkr(pin); gunSave(â€˜pinsâ€™,pin);
updateMapUI(); renderLeadsTable();
addFeed(â€˜ğŸ“‹â€™,`New lead: ${fn||addr.slice(0,20)}`,addr,â€˜var(â€“bg2)â€™);
closeModal(â€˜modal-leadâ€™); toast(â€˜Lead added and syncedâ€™,â€˜okâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CALENDAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let calDate=new Date(), editApptId=null;
const MNS=[â€˜Januaryâ€™,â€˜Februaryâ€™,â€˜Marchâ€™,â€˜Aprilâ€™,â€˜Mayâ€™,â€˜Juneâ€™,â€˜Julyâ€™,â€˜Augustâ€™,â€˜Septemberâ€™,â€˜Octoberâ€™,â€˜Novemberâ€™,â€˜Decemberâ€™];
const DYS=[â€˜Sunâ€™,â€˜Monâ€™,â€˜Tueâ€™,â€˜Wedâ€™,â€˜Thuâ€™,â€˜Friâ€™,â€˜Satâ€™];
function renderCal() {
const y=calDate.getFullYear(), m=calDate.getMonth();
$(â€˜cal-lblâ€™).textContent=`${MNS[m].slice(0,3).toUpperCase()} ${y}`;
$(â€˜cal-hdâ€™).innerHTML=DYS.map(d=>`<div class="cdh">${d}</div>`).join(â€™â€™);
const fd=new Date(y,m,1).getDay(), dim=new Date(y,m+1,0).getDate();
const pd=new Date(y,m,0).getDate(), today=new Date();
const cells=[];
for(let i=fd-1;i>=0;iâ€“)cells.push({d:pd-i,other:true});
for(let i=1;i<=dim;i++)cells.push({d:i,other:false});
while(cells.length%7!==0)cells.push({d:cells.length-fd-dim+1,other:true});
$(â€˜cal-gridâ€™).innerHTML=cells.map(c=>{
const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(c.d).padStart(2,'0')}`;
const da=c.other?[]:DB.appts.filter(a=>a.date===ds);
const isT=!c.other&&today.getDate()===c.d&&today.getMonth()===m&&today.getFullYear()===y;
const cls=â€˜ccâ€™+(c.other?â€™ otherâ€™:â€™â€™)+(isT?â€™ todayâ€™:â€™â€™);
const dbl=c.other?â€™â€™:`ondblclick="openApptModal('${ds}')"`;
return `<div class="${cls}" ${dbl}><div class="cdn">${c.d}</div>${da.slice(0,3).map(a=>`<span class="cpill ap-${a.type}">${fmtT(a.time)} ${a.cust}</span>`).join('')}${da.length>3?`<span style="font-size:9px;color:var(--t3);font-family:var(--mono)">+${da.length-3}</span>`:''}</div>`;
}).join(â€™â€™);
const now=new Date();
const up=DB.appts.filter(a=>new Date(a.date+â€˜Tâ€™+a.time)>=now).sort((a,b)=>new Date(a.date+â€˜Tâ€™+a.time)-new Date(b.date+â€˜Tâ€™+b.time)).slice(0,10);
$(â€˜appt-listâ€™).innerHTML=!up.length
?â€™<div class="empty" style="padding:24px"><div class="ei" style="font-size:20px">ğŸ“…</div><div class="et" style="font-size:12px">No upcoming appointments</div></div>â€™
:up.map(a=>`<div class="appt-item" onclick="openApptModal(null,'${a.id}')"><div class="at">${a.date} Â· ${fmtT(a.time)}</div><div class="an">${a.cust}</div><div class="ad">${a.addr||''}</div><div class="ad">${rName(a.rep)}</div></div>`).join(â€™â€™);
}
function calNav(d){calDate.setMonth(calDate.getMonth()+d);renderCal();}
function openApptModal(date,editId=null) {
popAll(); editApptId=editId;
$(â€˜appt-titleâ€™).textContent=editId?â€˜ğŸ“… Edit Appointmentâ€™:â€˜ğŸ“… New Appointmentâ€™;
$(â€˜appt-delâ€™).style.display=editId?â€˜inline-flexâ€™:â€˜noneâ€™;
if(editId) {
const a=DB.appts.find(x=>x.id===editId); if(!a)return;
$(â€˜acâ€™).value=a.cust; $(â€˜aphâ€™).value=a.phone||â€™â€™; $(â€˜aaâ€™).value=a.addr||â€™â€™;
$(â€˜adâ€™).value=a.date; $(â€˜at2â€™).value=a.time; $(â€˜atyâ€™).value=a.type;
$(â€˜ar2â€™).value=a.rep; $(â€˜anâ€™).value=a.notes||â€™â€™;
} else {
[â€˜acâ€™,â€˜aphâ€™,â€˜aaâ€™,â€˜anâ€™].forEach(id=>$(id).value=â€™â€™);
$(â€˜adâ€™).value=date||iso(); $(â€˜at2â€™).value=â€˜10:00â€™; $(â€˜atyâ€™).value=â€˜demoâ€™; $(â€˜ar2â€™).value=â€™â€™;
}
openModal(â€˜modal-apptâ€™);
}
function saveAppt() {
const cust=($(â€˜acâ€™).value||â€™â€™).trim(), date=$(â€˜adâ€™).value;
if(!cust||!date){toast(â€˜Name and date requiredâ€™,â€˜erâ€™);return;}
const obj={cust,phone:$(â€˜aphâ€™).value||â€™â€™,addr:$(â€˜aaâ€™).value||â€™â€™,date,time:$(â€˜at2â€™).value,type:$(â€˜atyâ€™).value,rep:$(â€˜ar2â€™).value,notes:$(â€˜anâ€™).value||â€™â€™};
if(editApptId) {
const a=DB.appts.find(x=>x.id===editApptId);
if(a){Object.assign(a,obj);gunSave(â€˜apptsâ€™,a);}
toast(â€˜Appointment updated and syncedâ€™,â€˜okâ€™);
} else {
const appt={id:newId(),â€¦obj};
DB.appts.push(appt); gunSave(â€˜apptsâ€™,appt);
addFeed(â€˜ğŸ“…â€™,`Appt: ${cust}`,`${date} ${fmtT(obj.time)}`,â€˜var(â€“vg)â€™);
toast(â€˜Appointment saved and syncedâ€™,â€˜okâ€™);
}
renderCal(); renderDash(); closeModal(â€˜modal-apptâ€™);
}
function deleteAppt() {
if(!confirm(â€˜Delete this appointment?â€™))return;
gunDel(â€˜apptsâ€™,editApptId);
DB.appts=DB.appts.filter(a=>a.id!==editApptId);
editApptId=null; renderCal(); renderDash();
closeModal(â€˜modal-apptâ€™); toast(â€˜Deletedâ€™,â€˜inâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SALES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSales() {
const total=DB.sales.reduce((s,x)=>s+(+x.amount||0),0);
$(â€˜sales-revâ€™).textContent=fmt$(total);
$(â€˜sales-subâ€™).textContent=DB.sales.length+â€™ transactionâ€™+(DB.sales.length!==1?â€˜sâ€™:â€™â€™)+â€™ loggedâ€™;
$(â€˜sales-ctâ€™).textContent=DB.sales.length;
const em=$(â€˜sales-emptyâ€™), tbl=$(â€˜sales-tblâ€™);
if(!DB.sales.length){em.style.display=â€˜flexâ€™;tbl.style.display=â€˜noneâ€™;}
else {
em.style.display=â€˜noneâ€™; tbl.style.display=â€˜tableâ€™;
$(â€˜sales-bodyâ€™).innerHTML=[â€¦DB.sales].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(s=>`<tr><td class="mono">${s.date}</td><td class="pri">${s.cust}</td><td>${rName(s.rep)}</td><td>${s.product}</td><td class="money">${fmt$(s.amount)}</td></tr>`).join(â€™â€™);
}
const rt={};
DB.sales.forEach(s=>{if(!s.rep)return;if(!rt[s.rep])rt[s.rep]=0;rt[s.rep]+=(+s.amount||0);});
const sorted=Object.entries(rt).sort((a,b)=>b[1]-a[1]), maxA=sorted[0]?sorted[0][1]:1;
const bc=[â€™#2563ebâ€™,â€™#10b981â€™,â€™#f59e0bâ€™,â€™#8b5cf6â€™,â€™#06b6d4â€™,â€™#ef4444â€™];
$(â€˜rep-barsâ€™).innerHTML=!sorted.length?â€™<div class="empty" style="padding:14px"><div class="es">Log sales to see chart</div></div>â€™
:sorted.map(([rid,amt],i)=>`<div class="rb-wrap"><div class="rb-name">${rName(rid).split(' ')[0]}</div><div class="rb-track"><div class="rb-fill" style="width:${Math.round(amt/maxA*100)}%;background:${bc[i%6]}"><span>${fmt$(amt)}</span></div></div></div>`).join(â€™â€™);
}
function openSaleModal() {
popAll(); [â€˜sc2â€™,â€˜saâ€™,â€˜samâ€™].forEach(id=>{const e=$(id);if(e)e.value=â€™â€™;});
$(â€˜sdâ€™).value=iso(); $(â€˜srâ€™).value=â€™â€™; $(â€˜szâ€™).value=â€™â€™; openModal(â€˜modal-saleâ€™);
}
function saveSale() {
const cust=($(â€˜sc2â€™).value||â€™â€™).trim(), amt=parseFloat($(â€˜samâ€™).value)||0;
if(!cust||amt<=0){toast(â€˜Customer name and amount requiredâ€™,â€˜erâ€™);return;}
const sAddr=($(â€˜saâ€™).value||â€™â€™).trim();
const sale={id:newId(),cust,date:$(â€˜sdâ€™).value,addr:sAddr,product:$(â€˜spâ€™).value,amount:amt,rep:$(â€˜srâ€™).value,areaId:$(â€˜szâ€™).value};
DB.sales.push(sale); gunSave(â€˜salesâ€™,sale);
if(sAddr) {
const match=DB.pins.find(p=>p.addr&&p.addr.toLowerCase()===sAddr.toLowerCase());
if(match&&match.status!==â€˜soldâ€™){
match.status=â€˜soldâ€™; match.updatedAt=tsNow();
match.history.unshift({action:â€˜Marked Sold via sales logâ€™,status:â€˜soldâ€™,note:`${sale.product} Â· ${fmt$(amt)}`,ts:tsNow()});
if(mkrs[match.id])mkrs[match.id].setIcon(mkIco(â€˜soldâ€™));
gunSave(â€˜pinsâ€™,match);
}
}
addFeed(â€˜ğŸ’°â€™,`Sale: ${cust}`,fmt$(amt),â€˜var(â€“gg)â€™);
renderSales(); renderLeaderboard(); renderDash(); updateMapUI();
closeModal(â€˜modal-saleâ€™); toast(â€™Sale logged and synced â€” â€™+fmt$(amt),â€˜okâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
LEADERBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lbP=â€˜allâ€™;
function setLBP(p,btn){lbP=p;document.querySelectorAll(â€™.lb-bâ€™).forEach(b=>{b.classList.remove(â€˜btn-pâ€™);b.classList.add(â€˜btn-ghostâ€™);});btn.classList.remove(â€˜btn-ghostâ€™);btn.classList.add(â€˜btn-pâ€™);renderLeaderboard();}
function renderLeaderboard() {
const now=new Date(), wk=new Date(now-7*86400000), mo=new Date(now.getFullYear(),now.getMonth(),1);
const filt=DB.sales.filter(s=>{if(lbP===â€˜weekâ€™)return new Date(s.date)>=wk;if(lbP===â€˜monthâ€™)return new Date(s.date)>=mo;return true;});
const rd={};
filt.forEach(s=>{const k=s.rep||â€˜noneâ€™;if(!rd[k])rd[k]={rid:s.rep,amt:0,closes:0};rd[k].amt+=(+s.amount||0);rd[k].closes++;});
const sorted=Object.values(rd).sort((a,b)=>b.amt-a.amt);
$(â€˜lb-emptyâ€™).style.display=sorted.length?â€˜noneâ€™:â€˜flexâ€™;
$(â€˜lb-tblâ€™).style.display=sorted.length?â€˜tableâ€™:â€˜noneâ€™;
const pod=$(â€˜podiumâ€™);
if(sorted.length){
pod.style.display=â€˜gridâ€™;
pod.innerHTML=sorted.slice(0,3).map((d,i)=>{
const r=rObj(d.rid), col=r?.color||â€™#2563ebâ€™;
const doors=DB.pins.filter(p=>p.rep===d.rid).length;
const meds=[â€˜goldâ€™,â€˜silverâ€™,â€˜bronzeâ€™], ics=[â€˜ğŸ¥‡â€™,â€˜ğŸ¥ˆâ€™,â€˜ğŸ¥‰â€™];
return `<div class="pod ${meds[i]}"><div class="pod-med">${ics[i]}</div><div class="pod-av" style="background:${col}22;color:${col};border-color:${col}44">${r?inits(r):'?'}</div><div class="pod-name">${r?`${r.fname} ${r.lname}`.trim():'Unknown'}</div><div class="pod-zone">${r?.areaId?DB.areas.find(a=>a.id===r.areaId)?.name||'â€”':'â€”'}</div><div class="pod-amt">${fmt$(d.amt)}</div><div class="pod-meta">${d.closes} close${d.closes!==1?'s':''} Â· ${doors} doors</div></div>`;
}).join(â€™â€™);
} else pod.style.display=â€˜noneâ€™;
const rnk=[â€˜b-amâ€™,â€˜b-gyâ€™,â€˜b-viâ€™];
$(â€˜lb-bodyâ€™).innerHTML=sorted.map((d,i)=>{
const r=rObj(d.rid), col=r?.color||â€™#475569â€™;
const doors=DB.pins.filter(p=>p.rep===d.rid).length;
const rate=doors>0?(d.closes/doors*100).toFixed(1)+â€™%â€™:â€™â€”â€™;
return `<tr><td><span class="badge ${rnk[i]||'b-gy'}">${i+1}</span></td><td><div style="display:flex;align-items:center;gap:8px"><div style="width:28px;height:28px;border-radius:7px;background:${col}22;color:${col};border:1px solid ${col}44;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0">${r?inits(r):'?'}</div><span class="pri">${r?`${r.fname} ${r.lname}`.trim():'Unknown'}</span></div></td><td class="mono">${r?.areaId?DB.areas.find(a=>a.id===r.areaId)?.name||'â€”':'â€”'}</td><td><span style="font-size:14px;font-weight:800;color:var(--green)">${fmt$(d.amt)}</span></td><td style="font-weight:700;color:var(--bl);font-family:var(--mono)">${d.closes}</td><td class="mono">${doors}</td><td class="mono">${rate}</td></tr>`;
}).join(â€™â€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TERRITORIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAreas() {
const g=$(â€˜areas-gridâ€™);
if(!DB.areas.length){g.innerHTML=â€™<div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ—º</div><div class="et">No territories</div><div class="es">Add zones to organize your canvassing.</div></div>â€™;return;}
g.innerHTML=DB.areas.map(a=>{
const r=rObj(a.repId), pins=DB.pins.filter(p=>p.areaId===a.id).length;
const sold=DB.pins.filter(p=>p.areaId===a.id&&p.status===â€˜soldâ€™).length;
const rate=pins>0?(sold/pins*100).toFixed(1):0;
return `<div class="area-card"><div class="a-stripe" style="background:${a.color}"></div><div class="a-name">${a.name}</div><div class="a-meta">ZIP: ${a.zip||'â€”'} Â· ${r?`${r.fname} ${r.lname}`.trim():'Unassigned'}</div><div class="a-stats"><div><div class="asv" style="color:${a.color}">${pins}</div><div class="asl">Doors</div></div><div><div class="asv" style="color:var(--green)">${sold}</div><div class="asl">Sold</div></div><div><div class="asv" style="color:var(--t3)">${rate}%</div><div class="asl">Rate</div></div></div><div class="a-prog"><div class="a-fill" style="width:${Math.min(100,+rate*4)}%;background:${a.color}"></div></div>${a.notes?`<div style="font-size:11px;color:var(--t3);margin-top:7px;padding-left:8px;line-height:1.5">${a.notes}</div>`:''}</div>`;
}).join(â€™â€™);
}
function openAreaModal(){popAll();[â€˜znâ€™,â€˜zzâ€™,â€˜zoâ€™].forEach(id=>{const e=$(id);if(e)e.value=â€™â€™;});$(â€˜zrâ€™).value=â€™â€™;openModal(â€˜modal-areaâ€™);}
function saveArea(){
if(!($(â€˜znâ€™).value||â€™â€™).trim()){toast(â€˜Name requiredâ€™,â€˜erâ€™);return;}
const a={id:newId(),name:$(â€˜znâ€™).value.trim(),zip:($(â€˜zzâ€™).value||â€™â€™).trim(),repId:$(â€˜zrâ€™).value,notes:($(â€˜zoâ€™).value||â€™â€™).trim(),color:PCOLS[DB.areas.length%PCOLS.length]};
DB.areas.push(a); gunSave(â€˜areasâ€™,a); popAll(); renderAreas();
closeModal(â€˜modal-areaâ€™); toast(â€˜Territory created and syncedâ€™,â€˜okâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TEAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTeam() {
$(â€˜team-gridâ€™).innerHTML=DB.reps.map(r=>{
const rev=DB.sales.filter(s=>s.rep===r.id).reduce((t,s)=>t+(+s.amount||0),0);
const leads=DB.pins.filter(p=>p.rep===r.id).length;
const appts=DB.appts.filter(a=>a.rep===r.id).length;
const an=r.areaId?DB.areas.find(a=>a.id===r.areaId)?.name:â€™â€”â€™;
return `<div class="team-card"><div class="team-top"><div class="tav" style="background:${r.color}1a;color:${r.color};border-color:${r.color}33">${inits(r)}</div><div><div style="font-size:13px;font-weight:700;color:var(--t1)">${`${r.fname} ${r.lname}`.trim()}</div><div style="font-size:10px;font-family:var(--mono);color:var(--t3);text-transform:uppercase;letter-spacing:1px">${r.role}</div><div style="font-size:11px;color:var(--bl);margin-top:2px">${an||'No territory'}</div></div></div><div class="tm-g"><div><div class="tmv" style="color:var(--green)">${rev>0?fmt$(rev):'$0'}</div><div class="tml">Revenue</div></div><div><div class="tmv" style="color:var(--bl)">${leads}</div><div class="tml">Leads</div></div><div><div class="tmv" style="color:var(--violet)">${appts}</div><div class="tml">Appts</div></div></div></div>`;
}).join(â€™â€™);
}
function openRepModal(){popAll();[â€˜rfâ€™,â€˜rlâ€™,â€˜rphâ€™].forEach(id=>{const e=$(id);if(e)e.value=â€™â€™;});$(â€˜rrâ€™).value=â€˜repâ€™;$(â€˜raâ€™).value=â€™â€™;openModal(â€˜modal-repâ€™);}
function saveRep(){
if(!($(â€˜rfâ€™).value||â€™â€™).trim()||!($(â€˜rlâ€™).value||â€™â€™).trim()){toast(â€˜First and last name requiredâ€™,â€˜erâ€™);return;}
const r={id:newId(),fname:$(â€˜rfâ€™).value.trim(),lname:$(â€˜rlâ€™).value.trim(),role:$(â€˜rrâ€™).value,phone:($(â€˜rphâ€™).value||â€™â€™).trim(),areaId:$(â€˜raâ€™).value,color:PCOLS[DB.reps.length%PCOLS.length]};
DB.reps.push(r); gunSave(â€˜repsâ€™,r); popAll(); renderTeam();
closeModal(â€˜modal-repâ€™); toast(`${r.fname} ${r.lname} added and synced`,â€˜okâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
WEATHER (Open-Meteo â€” free, no API key)
Monterey County: 36.6002, -121.8947
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let wxLoaded=false;
const WMO_ICO={0:â€˜â˜€ï¸â€™,1:â€˜ğŸŒ¤â€™,2:â€˜â›…â€™,3:â€˜â˜ï¸â€™,45:â€˜ğŸŒ«â€™,48:â€˜ğŸŒ«â€™,51:â€˜ğŸŒ¦â€™,53:â€˜ğŸŒ¦â€™,55:â€˜ğŸŒ§â€™,61:â€˜ğŸŒ§â€™,63:â€˜ğŸŒ§â€™,65:â€˜ğŸŒ§â€™,71:â€˜â„ï¸â€™,73:â€˜â„ï¸â€™,75:â€˜â„ï¸â€™,80:â€˜ğŸŒ¦â€™,81:â€˜ğŸŒ§â€™,82:â€˜ğŸŒ§â€™,95:â€˜â›ˆâ€™,96:â€˜â›ˆâ€™,99:â€˜â›ˆâ€™};
const WMO_DSC={0:â€˜Clear skyâ€™,1:â€˜Mainly clearâ€™,2:â€˜Partly cloudyâ€™,3:â€˜Overcastâ€™,45:â€˜Foggyâ€™,48:â€˜Rime fogâ€™,51:â€˜Light drizzleâ€™,53:â€˜Moderate drizzleâ€™,55:â€˜Dense drizzleâ€™,61:â€˜Slight rainâ€™,63:â€˜Moderate rainâ€™,65:â€˜Heavy rainâ€™,71:â€˜Slight snowâ€™,73:â€˜Moderate snowâ€™,75:â€˜Heavy snowâ€™,80:â€˜Slight showersâ€™,81:â€˜Moderate showersâ€™,82:â€˜Violent showersâ€™,95:â€˜Thunderstormâ€™,96:â€˜Thunderstorm+hailâ€™,99:â€˜Heavy thunderstormâ€™};
const wIco=c=>WMO_ICO[+c]||â€˜ğŸŒ¡â€™;
const wDsc=c=>WMO_DSC[+c]||â€˜Unknownâ€™;
const DS7=[â€˜Sunâ€™,â€˜Monâ€™,â€˜Tueâ€™,â€˜Wedâ€™,â€˜Thuâ€™,â€˜Friâ€™,â€˜Satâ€™];

async function loadWx(force=false) {
if(wxLoaded&&!force)return;
$(â€˜wx-bodyâ€™).innerHTML=â€™<div class="ld-wrap"><div class="spinner"></div><p>Fetching from Open-Meteoâ€¦</p></div>â€™;
$(â€˜wx-alert-boxâ€™).innerHTML=â€™â€™;
try {
const url=â€˜https://api.open-meteo.com/v1/forecastâ€™
+â€™?latitude=36.6002&longitude=-121.8947â€™
+â€™&current=temperature_2m,relative_humidity_2m,apparent_temperature,wind_speed_10m,wind_direction_10m,weather_code,cloud_cover,precipitation,uv_indexâ€™
+â€™&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,uv_index_maxâ€™
+â€™&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America%2FLos_Angeles&forecast_days=7â€™;
const res=await fetch(url); if(!res.ok)throw new Error(â€˜HTTP â€˜+res.status);
const d=await res.json(); wxLoaded=true;
const c=d.current;
const temp=Math.round(c.temperature_2m), feels=Math.round(c.apparent_temperature);
const code=c.weather_code, icon=wIco(code), desc=wDsc(code);
const hum=c.relative_humidity_2m, wind=Math.round(c.wind_speed_10m);
const wdir=c.wind_direction_10m, cloud=c.cloud_cover, precip=c.precipitation, uv=c.uv_index;
const windDir=[â€˜Nâ€™,â€˜NNEâ€™,â€˜NEâ€™,â€˜ENEâ€™,â€˜Eâ€™,â€˜ESEâ€™,â€˜SEâ€™,â€˜SSEâ€™,â€˜Sâ€™,â€˜SSWâ€™,â€˜SWâ€™,â€˜WSWâ€™,â€˜Wâ€™,â€˜WNWâ€™,â€˜NWâ€™,â€˜NNWâ€™][Math.round(wdir/22.5)%16]||â€˜Nâ€™;
$(â€˜wx-nav-icoâ€™).textContent=icon; $(â€˜wx-nav-tempâ€™).textContent=temp+â€˜Â°Fâ€™;
const isRain=code>=51, isHot=temp>88, isCold=temp<45, isWindy=wind>20;
const grade=!isRain&&!isCold&&!isHot&&!isWindy?â€˜Excellentâ€™:!isRain&&!isCold?â€˜Goodâ€™:isRain?â€˜Poorâ€™:â€˜Fairâ€™;
const gc=grade===â€˜Excellentâ€™?â€˜igâ€™:grade===â€˜Goodâ€™?â€˜ioâ€™:â€˜ibâ€™;
if(isRain||isWindy||isCold) $(â€˜wx-alert-boxâ€™).innerHTML=`<div class="wx-alert-box"><span style="font-size:16px;flex-shrink:0">âš ï¸</span><span><strong>Field Advisory â€” </strong>${isRain?'Rain in area. ':''} ${isWindy?'High winds ('+wind+' mph). ':''} ${isCold?'Cold temps below 45Â°F.':''}</span></div>`;
const daily=d.daily;
const fcDays=daily.time.slice(0,7).map((dt,i)=>({dt,code:daily.weather_code[i],hi:Math.round(daily.temperature_2m_max[i]),lo:Math.round(daily.temperature_2m_min[i]),precip:daily.precipitation_sum[i]}));
$(â€˜wx-bodyâ€™).innerHTML=` <div class="wx-grid"> <div class="wx-main"><div class="wx-icon">${icon}</div><div><div class="wx-temp">${temp}Â°F</div><div class="wx-feels">Feels like ${feels}Â°F</div><div class="wx-desc">${desc}</div><div class="wx-loc">ğŸ“ Salinas / Monterey County, CA</div></div></div> <div class="wx-det"> <div class="wx-row"><span class="wx-rl">Humidity</span><span class="wx-rv">${hum}%</span></div> <div class="wx-row"><span class="wx-rl">Wind</span><span class="wx-rv">${wind} mph ${windDir}</span></div> <div class="wx-row"><span class="wx-rl">Cloud Cover</span><span class="wx-rv">${cloud}%</span></div> <div class="wx-row"><span class="wx-rl">Precipitation</span><span class="wx-rv">${precip} mm</span></div> <div class="wx-row"><span class="wx-rl">UV Index</span><span class="wx-rv" style="color:${uv<=2?'var(--green)':uv<=5?'var(--amber)':'var(--red)'}">${uv}</span></div> <div class="wx-row"><span class="wx-rl">Source</span><span class="wx-rv" style="color:var(--t3)">Open-Meteo (free)</span></div> </div> </div> <div style="font-size:10px;font-family:var(--mono);letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:10px">7-Day Forecast</div> <div class="fc-grid">${fcDays.map(day=>{const dt=new Date(day.dt+'T12:00:00');return`<div class="fc-d"><div class="fc-dl">${DS7[dt.getDay()]}</div><div class="fc-di">${wIco(day.code)}</div><div class="fc-hi">${day.hi}Â°</div><div class="fc-lo" style="color:var(--t3)">${day.lo}Â°</div>${day.precip>0?`<div style="font-size:9px;color:var(--bl);font-family:var(--mono);margin-top:2px">${day.precip}mm</div>`:â€™â€™}</div>`;}).join('')}</div> <div class="wx-impact"><h4>Canvassing Impact â€” Monterey County</h4> <div class="imp-grid"> <div class="imp"><div class="imp-ico">ğŸš¶</div><div class="imp-lbl">Canvassing</div><div class="imp-val ${gc}">${grade}</div></div> <div class="imp"><div class="imp-ico">ğŸŒ§</div><div class="imp-lbl">Rain Risk</div><div class="imp-val ${isRain?'ib':'ig'}">${isRain?'Active':'None'}</div></div> <div class="imp"><div class="imp-ico">ğŸ’¨</div><div class="imp-lbl">Wind</div><div class="imp-val ${wind<10?'ig':wind<20?'io':'ib'}">${wind<10?'Calm':wind<20?'Breezy':'Windy'}</div></div> <div class="imp"><div class="imp-ico">â˜€ï¸</div><div class="imp-lbl">UV Risk</div><div class="imp-val ${uv<=2?'ig':uv<=5?'io':'ib'}">${uv<=2?'Low':uv<=5?'Moderate':'High'}</div></div> </div> </div>`;
} catch(err) {
$(â€˜wx-bodyâ€™).innerHTML=`<div style="background:var(--rg);border:1px solid var(--rb);border-radius:9px;padding:16px;color:var(--red);font-size:13px;line-height:1.6">âš  Could not load weather: ${err.message}<br><span style="font-size:11px;color:var(--t2)">Open-Meteo is free and requires no API key. Check your internet connection.</span></div>`;
}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
LAZY LOAD WEATHER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setupLazy() {
const obs=new IntersectionObserver(entries=>{
entries.forEach(e=>{if(!e.isIntersecting)return;if(e.target.id===â€˜sec-wxâ€™&&!wxLoaded)loadWx();});
},{threshold:0.05});
const el=$(â€˜sec-wxâ€™); if(el)obs.observe(el);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener(â€˜DOMContentLoadedâ€™, () => {
// Initial render (empty state UI)
renderDash(); renderCal(); renderSales();
renderLeaderboard(); renderAreas(); renderTeam();
renderLeadsTable(); popAll();

// Auto-rejoin if team code was saved
const savedCode = localStorage.getItem(TEAM_LS_KEY);
if(savedCode) {
$(â€˜join-codeâ€™).value = savedCode;
doJoin();
}

// Refresh dashboard every minute
setInterval(renderDash, 60000);
});
</script>

</body>
</html>
