<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Complete Home â€” Field Operations Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
:root{
  --bg-base:#070b14;--bg-surface:#0d1220;--bg-card:#111827;--bg-card-hover:#161f30;
  --bg-elevated:#1a2235;--bg-input:#0d1220;
  --blue:#2563eb;--blue-light:#3b82f6;--blue-ghost:rgba(37,99,235,.12);--blue-border:rgba(59,130,246,.35);
  --green:#10b981;--green-ghost:rgba(16,185,129,.1);--green-border:rgba(16,185,129,.3);
  --amber:#f59e0b;--amber-ghost:rgba(245,158,11,.1);
  --red:#ef4444;--red-ghost:rgba(239,68,68,.1);--red-border:rgba(239,68,68,.3);
  --violet:#8b5cf6;--violet-ghost:rgba(139,92,246,.1);
  --cyan:#06b6d4;--cyan-ghost:rgba(6,182,212,.1);
  --text-primary:#f1f5f9;--text-secondary:#94a3b8;--text-muted:#475569;
  --border:rgba(255,255,255,.07);--border-strong:rgba(255,255,255,.14);--border-focus:rgba(59,130,246,.5);
  --shadow-sm:0 1px 3px rgba(0,0,0,.4);--shadow-md:0 4px 20px rgba(0,0,0,.5);
  --shadow-lg:0 10px 40px rgba(0,0,0,.6);--shadow-blue:0 0 0 3px rgba(59,130,246,.2);
  --sidebar-w:240px;--topbar-h:62px;
  --font:'Outfit',sans-serif;--mono:'DM Mono',monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg-base);color:var(--text-primary);font-family:var(--font);font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased}
body{overflow:hidden}
button{font-family:var(--font);cursor:pointer}
input,select,textarea{font-family:var(--font)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg-elevated);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}

/* SHELL */
#shell{display:flex;height:100vh;overflow:hidden}

/* SIDEBAR */
#sidebar{
width:var(â€“sidebar-w);height:100%;background:var(â€“bg-surface);
border-right:1px solid var(â€“border);display:flex;flex-direction:column;
flex-shrink:0;overflow:hidden;position:relative;z-index:100;
transition:width .25s cubic-bezier(.4,0,.2,1);
}
#sidebar.collapsed{width:64px}
.sb-logo{padding:18px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(â€“border);flex-shrink:0;min-height:var(â€“topbar-h)}
.sb-logo-icon{width:32px;height:32px;background:var(â€“blue);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;box-shadow:0 0 16px rgba(37,99,235,.4)}
.sb-logo-text{overflow:hidden;white-space:nowrap}
.sb-logo-title{font-size:14px;font-weight:800;color:var(â€“text-primary);letter-spacing:-.3px;line-height:1.2}
.sb-logo-sub{font-size:10px;color:var(â€“text-muted);font-family:var(â€“mono);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px}
.sb-toggle{position:absolute;top:18px;right:-12px;width:24px;height:24px;background:var(â€“bg-elevated);border:1px solid var(â€“border-strong);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(â€“text-secondary);transition:all .2s;z-index:10;cursor:pointer}
.sb-toggle:hover{background:var(â€“blue);color:#fff;border-color:var(â€“blue)}
.sb-nav{flex:1;padding:8px 0;overflow-y:auto;overflow-x:hidden}
.sb-group{padding:14px 16px 5px;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(â€“text-muted);white-space:nowrap;font-family:var(â€“mono);transition:opacity .2s}
#sidebar.collapsed .sb-group{opacity:0}
.sb-link{display:flex;align-items:center;gap:12px;padding:9px 16px;margin:1px 8px;border-radius:8px;cursor:pointer;transition:all .15s;white-space:nowrap;color:var(â€“text-secondary);font-size:13px;font-weight:500;border:none;background:transparent;width:calc(100% - 16px);text-align:left;position:relative}
.sb-link:hover{background:var(â€“bg-elevated);color:var(â€“text-primary)}
.sb-link.active{background:var(â€“blue-ghost);color:var(â€“blue-light)}
.sb-link.active::before{content:â€™â€™;position:absolute;left:8px;top:50%;transform:translateY(-50%);width:3px;height:60%;background:var(â€“blue-light);border-radius:0 2px 2px 0}
.sb-icon{width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.sb-lbl{flex:1;overflow:hidden;text-overflow:ellipsis}
.sb-badge{background:var(â€“blue);color:#fff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:10px;font-family:var(â€“mono);flex-shrink:0;min-width:18px;text-align:center}
.sb-user{padding:12px;border-top:1px solid var(â€“border);display:flex;align-items:center;gap:10px;flex-shrink:0;overflow:hidden}
.av{border-radius:50%;background:var(â€“blue);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;flex-shrink:0;box-shadow:0 0 10px rgba(37,99,235,.3)}
.sb-user .av{width:36px;height:36px;font-size:13px}
.sb-user-name{font-size:13px;font-weight:600;color:var(â€“text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb-user-role{font-size:11px;color:var(â€“text-muted);font-family:var(â€“mono)}
.online-dot{width:8px;height:8px;border-radius:50%;background:var(â€“green);flex-shrink:0;box-shadow:0 0 6px var(â€“green);animation:pulse-g 2s ease-in-out infinite}
@keyframes pulse-g{0%,100%{opacity:1}50%{opacity:.5}}

/* MAIN */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
#topbar{height:var(â€“topbar-h);background:var(â€“bg-surface);border-bottom:1px solid var(â€“border);display:flex;align-items:center;padding:0 24px;gap:14px;flex-shrink:0;z-index:50}
.tb-left{flex:1;min-width:0}
.tb-page{font-size:16px;font-weight:700;letter-spacing:-.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tb-crumb{font-size:11px;color:var(â€“text-muted);font-family:var(â€“mono);margin-top:2px}
.tb-right{display:flex;align-items:center;gap:9px}
.tb-chip{display:flex;align-items:center;gap:7px;background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:8px;padding:7px 12px;cursor:pointer;transition:border-color .2s;white-space:nowrap}
.tb-chip:hover{border-color:var(â€“border-strong)}
.tb-chip-lbl{font-size:10px;color:var(â€“text-muted);font-family:var(â€“mono)}
.tb-chip-val{font-size:12px;font-weight:600;color:var(â€“text-primary)}
.net-dot{width:8px;height:8px;border-radius:50%;background:var(â€“green);box-shadow:0 0 6px var(â€“green);animation:pulse-g 2s infinite}
.net-dot.warn{background:var(â€“amber);box-shadow:0 0 6px var(â€“amber)}
.net-dot.bad{background:var(â€“red);box-shadow:0 0 6px var(â€“red)}

/* SCROLL CONTAINER */
#scroll{flex:1;overflow-y:auto;overflow-x:hidden;scroll-behavior:smooth}

/* SECTIONS */
.section{padding:32px 28px;border-bottom:1px solid var(â€“border)}
.section:last-child{border-bottom:none;padding-bottom:60px}
.sec-tag{font-size:10px;font-family:var(â€“mono);letter-spacing:2px;text-transform:uppercase;color:var(â€“text-muted);display:inline-flex;align-items:center;gap:6px;margin-bottom:6px}
.sec-tag::before{content:â€™â€™;width:16px;height:1px;background:var(â€“text-muted);display:inline-block}
.sec-hd{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:22px;gap:16px}
.sec-hd-left h2{font-size:19px;font-weight:700;letter-spacing:-.4px;color:var(â€“text-primary);display:flex;align-items:center;gap:9px}
.sec-hd-left p{font-size:13px;color:var(â€“text-secondary);margin-top:4px}
.sec-hd-right{display:flex;gap:8px;align-items:center;flex-shrink:0}

/* COMPONENTS */
.card{background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:12px;overflow:hidden;transition:border-color .2s}
.card:hover{border-color:var(â€“border-strong)}
.card-hd{padding:14px 18px;border-bottom:1px solid var(â€“border);display:flex;align-items:center;justify-content:space-between}
.card-hd h3{font-size:13px;font-weight:600;color:var(â€“text-primary)}
.card-hd .meta{font-size:11px;color:var(â€“text-muted);font-family:var(â€“mono)}
.card-body{padding:16px}

/* KPI */
.kpi-row{display:grid;gap:14px;margin-bottom:22px}
.kpi-4{grid-template-columns:repeat(4,1fr)}
@media(max-width:1100px){.kpi-4{grid-template-columns:repeat(2,1fr)}}
.kpi{background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:12px;padding:18px 20px;position:relative;overflow:hidden;transition:border-color .2s,transform .15s}
.kpi:hover{border-color:var(â€“border-strong);transform:translateY(-1px)}
.kpi::after{content:â€™â€™;position:absolute;bottom:0;left:0;right:0;height:2px;opacity:.8}
.kpi.blue::after{background:linear-gradient(90deg,transparent,var(â€“blue),transparent)}
.kpi.green::after{background:linear-gradient(90deg,transparent,var(â€“green),transparent)}
.kpi.amber::after{background:linear-gradient(90deg,transparent,var(â€“amber),transparent)}
.kpi.violet::after{background:linear-gradient(90deg,transparent,var(â€“violet),transparent)}
.kpi.cyan::after{background:linear-gradient(90deg,transparent,var(â€“cyan),transparent)}
.kpi-lbl{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(â€“text-muted);font-family:var(â€“mono);margin-bottom:8px}
.kpi-val{font-size:28px;font-weight:900;letter-spacing:-1px;line-height:1}
.kpi.blue .kpi-val{color:var(â€“blue-light)}.kpi.green .kpi-val{color:var(â€“green)}
.kpi.amber .kpi-val{color:var(â€“amber)}.kpi.violet .kpi-val{color:var(â€“violet)}.kpi.cyan .kpi-val{color:var(â€“cyan)}
.kpi-sub{font-size:11px;color:var(â€“text-muted);margin-top:5px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;border:none;transition:all .15s;cursor:pointer;white-space:nowrap;font-family:var(â€“font)}
.btn-primary{background:var(â€“blue);color:#fff;box-shadow:0 1px 3px rgba(37,99,235,.3)}
.btn-primary:hover{background:var(â€“blue-light);box-shadow:0 4px 12px rgba(37,99,235,.4)}
.btn-secondary{background:var(â€“bg-elevated);color:var(â€“text-secondary);border:1px solid var(â€“border-strong)}
.btn-secondary:hover{color:var(â€“text-primary);border-color:var(â€“blue-border)}
.btn-success{background:var(â€“green);color:#fff}
.btn-success:hover{background:#0ea371;box-shadow:0 4px 12px rgba(16,185,129,.3)}
.btn-danger{background:var(â€“red);color:#fff}
.btn-ghost{background:transparent;color:var(â€“text-secondary);border:1px solid var(â€“border);padding:8px 14px}
.btn-ghost:hover{color:var(â€“text-primary);border-color:var(â€“border-strong);background:var(â€“bg-elevated)}
.btn-sm{padding:6px 14px;font-size:12px}

/* BADGES */
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:10px;font-weight:600;font-family:var(â€“mono);letter-spacing:.5px;text-transform:uppercase;white-space:nowrap}
.b-blue{background:var(â€“blue-ghost);color:var(â€“blue-light);border:1px solid var(â€“blue-border)}
.b-green{background:var(â€“green-ghost);color:var(â€“green);border:1px solid var(â€“green-border)}
.b-amber{background:var(â€“amber-ghost);color:var(â€“amber);border:1px solid rgba(245,158,11,.3)}
.b-red{background:var(â€“red-ghost);color:var(â€“red);border:1px solid var(â€“red-border)}
.b-violet{background:var(â€“violet-ghost);color:var(â€“violet);border:1px solid rgba(139,92,246,.3)}
.b-gray{background:rgba(71,85,105,.2);color:var(â€“text-muted);border:1px solid rgba(71,85,105,.3)}
.b-cyan{background:var(â€“cyan-ghost);color:var(â€“cyan);border:1px solid rgba(6,182,212,.3)}

/* STATUS DOTS */
.dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot.g{background:var(â€“green);box-shadow:0 0 6px var(â€“green)}
.dot.a{background:var(â€“amber);box-shadow:0 0 6px var(â€“amber)}
.dot.r{background:var(â€“red);box-shadow:0 0 6px var(â€“red)}

/* TABLES */
.tbl{width:100%;border-collapse:collapse}
.tbl th{padding:10px 14px;text-align:left;font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(â€“text-muted);font-family:var(â€“mono);border-bottom:1px solid var(â€“border);background:var(â€“bg-card);white-space:nowrap}
.tbl td{padding:12px 14px;border-bottom:1px solid var(â€“border);font-size:13px;color:var(â€“text-secondary);background:var(â€“bg-card)}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(â€“bg-card-hover)}
.tbl td.pri{color:var(â€“text-primary);font-weight:600}
.tbl td.money{color:var(â€“green);font-family:var(â€“mono);font-weight:700;font-size:14px}
.tbl td.mono{font-family:var(â€“mono);font-size:11px}

/* FORMS */
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:11px;font-weight:600;color:var(â€“text-secondary);margin-bottom:5px}
.form-input,.form-select,.form-textarea{width:100%;background:var(â€“bg-input);border:1px solid var(â€“border-strong);border-radius:8px;color:var(â€“text-primary);padding:9px 12px;font-size:13px;font-family:var(â€“font);outline:none;transition:border-color .15s,box-shadow .15s;appearance:none}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(â€“border-focus);box-shadow:var(â€“shadow-blue)}
.form-select option{background:var(â€“bg-elevated)}
.form-textarea{resize:vertical;min-height:72px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* GRIDS */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
@media(max-width:1100px){.g3,.g4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:700px){.g2,.g3,.g4{grid-template-columns:1fr}}

/* EMPTY STATE */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:44px 20px;text-align:center;color:var(â€“text-muted);gap:8px}
.empty-icon{font-size:30px;opacity:.4}
.empty-title{font-size:14px;font-weight:600;color:var(â€“text-secondary)}
.empty-sub{font-size:12px;max-width:240px;line-height:1.6}

/* SPINNER */
.spinner{width:28px;height:28px;border:3px solid var(â€“border-strong);border-top-color:var(â€“blue-light);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.load-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:48px}
.load-txt{font-size:12px;color:var(â€“text-muted);font-family:var(â€“mono);letter-spacing:1px}

/* ACTIVITY */
.act-item{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(â€“border)}
.act-item:last-child{border-bottom:none}
.act-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.act-title{font-size:13px;font-weight:600;color:var(â€“text-primary)}
.act-sub{font-size:11px;color:var(â€“text-muted);font-family:var(â€“mono);margin-top:1px}
.act-time{font-size:11px;color:var(â€“text-muted);font-family:var(â€“mono);white-space:nowrap;margin-left:auto}

/* MAP */
.map-wrap{display:flex;border:1px solid var(â€“border);border-radius:12px;overflow:hidden;height:520px}
.map-panel{width:270px;flex-shrink:0;background:var(â€“bg-surface);border-right:1px solid var(â€“border);display:flex;flex-direction:column}
.map-panel-hd{padding:13px 15px;border-bottom:1px solid var(â€“border);display:flex;align-items:center;justify-content:space-between}
.map-panel-hd h4{font-size:13px;font-weight:700;color:var(â€“text-primary)}
.map-tools{padding:9px 11px;border-bottom:1px solid var(â€“border);display:flex;gap:5px;flex-wrap:wrap}
.map-tool{flex:1;min-width:56px;background:var(â€“bg-elevated);border:1px solid var(â€“border-strong);border-radius:7px;color:var(â€“text-secondary);padding:7px 8px;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;text-align:center;font-family:var(â€“font)}
.map-tool:hover,.map-tool.active{border-color:var(â€“blue-border);color:var(â€“blue-light);background:var(â€“blue-ghost)}
.map-tool.danger:hover{border-color:var(â€“red-border);color:var(â€“red);background:var(â€“red-ghost)}
.map-stats-row{display:grid;grid-template-columns:repeat(4,1fr);border-bottom:1px solid var(â€“border)}
.ms{padding:8px 0;text-align:center;border-right:1px solid var(â€“border)}
.ms:last-child{border-right:none}
.ms-val{font-size:16px;font-weight:800;color:var(â€“text-primary)}
.ms-lbl{font-size:9px;color:var(â€“text-muted);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1px}
.pins-list{flex:1;overflow-y:auto}
.pin-row{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(â€“border);cursor:pointer;transition:background .12s}
.pin-row:hover{background:var(â€“bg-elevated)}
.pin-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.pin-name{font-size:12px;font-weight:600;color:var(â€“text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pin-addr{font-size:10px;color:var(â€“text-muted);font-family:var(â€“mono);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.map-area{flex:1;position:relative}
#leaflet-map{width:100%;height:100%}
.map-hint{position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:500;background:rgba(37,99,235,.92);color:#fff;padding:8px 18px;border-radius:8px;font-size:11px;font-family:var(â€“mono);letter-spacing:.5px;display:none;box-shadow:var(â€“shadow-md);white-space:nowrap}
.map-loader{position:absolute;inset:0;z-index:600;background:rgba(7,11,20,.75);display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px;backdrop-filter:blur(4px)}
.map-loader.show{display:flex}
.map-loader-txt{font-size:12px;color:var(â€“blue-light);font-family:var(â€“mono);letter-spacing:1px}
.map-legend{position:absolute;bottom:14px;right:8px;z-index:400;background:rgba(13,18,32,.94);border:1px solid var(â€“border-strong);border-radius:9px;padding:12px 14px;backdrop-filter:blur(6px);min-width:130px}
.map-legend h5{font-size:9px;color:var(â€“text-muted);font-family:var(â€“mono);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px}
.leg-r{display:flex;align-items:center;gap:7px;margin-bottom:5px;font-size:11px;color:var(â€“text-secondary)}
.leg-d{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.pc-nh{background:#475569}.pc-new{background:#3b82f6}.pc-contact{background:#f59e0b}
.pc-appt{background:#8b5cf6}.pc-sold{background:#10b981}.pc-no{background:#ef4444}

/* CALENDAR */
.cal-shell{display:grid;grid-template-columns:1fr 270px;gap:16px}
.cal-nav{display:flex;align-items:center;gap:8px}
.cal-arr{background:var(â€“bg-elevated);border:1px solid var(â€“border-strong);border-radius:7px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:15px;cursor:pointer;color:var(â€“text-secondary);transition:all .15s}
.cal-arr:hover{border-color:var(â€“blue-border);color:var(â€“blue-light)}
.cal-mlbl{font-size:12px;font-weight:600;font-family:var(â€“mono);color:var(â€“text-primary);min-width:110px;text-align:center}
.cal-grid-hd{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:2px}
.cal-dh{text-align:center;padding:7px 4px;font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(â€“text-muted);font-family:var(â€“mono)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-cell{background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:7px;min-height:76px;padding:6px;cursor:pointer;transition:border-color .15s}
.cal-cell:hover{border-color:var(â€“blue-border);background:var(â€“bg-card-hover)}
.cal-cell.today{border-color:var(â€“blue-light);background:var(â€“blue-ghost)}
.cal-cell.other{background:var(â€“bg-surface);opacity:.4;cursor:default}
.cal-cell.other:hover{border-color:var(â€“border);background:var(â€“bg-surface)}
.cal-dn{font-size:11px;font-family:var(â€“mono);color:var(â€“text-muted);margin-bottom:3px}
.cal-cell.today .cal-dn{color:var(â€“blue-light);font-weight:700}
.cal-pill{display:block;border-radius:3px;padding:2px 5px;margin-bottom:2px;font-size:9px;font-weight:600;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
.ap-demo{background:var(â€“violet-ghost);color:var(â€“violet);border-left:2px solid var(â€“violet)}
.ap-followup{background:var(â€“amber-ghost);color:var(â€“amber);border-left:2px solid var(â€“amber)}
.ap-close{background:var(â€“green-ghost);color:var(â€“green);border-left:2px solid var(â€“green)}
.ap-visit{background:var(â€“blue-ghost);color:var(â€“blue-light);border-left:2px solid var(â€“blue-light)}
.appt-item{padding:12px 14px;border-bottom:1px solid var(â€“border);cursor:pointer;transition:background .12s}
.appt-item:hover{background:var(â€“bg-elevated)}
.appt-time{font-size:10px;color:var(â€“blue-light);font-family:var(â€“mono);font-weight:600;margin-bottom:3px}
.appt-name{font-size:13px;font-weight:600;color:var(â€“text-primary)}
.appt-det{font-size:11px;color:var(â€“text-muted);margin-top:2px}

/* LEADERBOARD */
.podium{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:18px}
.pod-card{background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:12px;padding:20px;text-align:center;transition:transform .15s}
.pod-card:hover{transform:translateY(-2px);border-color:var(â€“border-strong)}
.pod-card.gold{border-color:rgba(245,158,11,.4);background:linear-gradient(135deg,var(â€“bg-card),rgba(245,158,11,.05))}
.pod-card.silver{border-color:rgba(148,163,184,.3)}
.pod-card.bronze{border-color:rgba(205,127,50,.3)}
.pod-medal{font-size:24px;margin-bottom:8px}
.pod-av{width:46px;height:46px;border-radius:50%;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;border:2px solid}
.pod-name{font-size:14px;font-weight:700;color:var(â€“text-primary)}
.pod-area{font-size:10px;color:var(â€“text-muted);font-family:var(â€“mono);margin-top:2px;margin-bottom:10px}
.pod-amt{font-size:22px;font-weight:900;color:var(â€“green);letter-spacing:-.5px}
.pod-meta{font-size:11px;color:var(â€“text-muted);font-family:var(â€“mono);margin-top:3px}

/* AREAS & TEAM */
.area-card{background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:12px;padding:18px;position:relative;overflow:hidden;transition:border-color .2s,transform .15s}
.area-card:hover{border-color:var(â€“border-strong);transform:translateY(-1px)}
.area-stripe{position:absolute;top:0;left:0;width:4px;height:100%}
.area-name{font-size:15px;font-weight:700;color:var(â€“text-primary);margin-bottom:3px;padding-left:8px}
.area-meta{font-size:11px;color:var(â€“text-muted);font-family:var(â€“mono);margin-bottom:12px;padding-left:8px}
.area-stats{display:flex;gap:16px;padding-left:8px}
.area-sv{font-size:20px;font-weight:800;letter-spacing:-.4px}
.area-sl{font-size:9px;color:var(â€“text-muted);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1px}
.area-prog{height:3px;background:var(â€“bg-elevated);border-radius:2px;margin-top:12px}
.area-prog-fill{height:100%;border-radius:2px;transition:width .8s}
.area-note{font-size:11px;color:var(â€“text-muted);margin-top:8px;line-height:1.5;padding-left:8px}
.team-card{background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:12px;padding:18px;transition:border-color .2s,transform .15s}
.team-card:hover{border-color:var(â€“border-strong);transform:translateY(-1px)}
.team-top{display:flex;align-items:center;gap:12px;padding-bottom:14px;margin-bottom:14px;border-bottom:1px solid var(â€“border)}
.team-av{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;flex-shrink:0;border:1px solid}
.team-name{font-size:14px;font-weight:700;color:var(â€“text-primary)}
.team-role{font-size:10px;font-family:var(â€“mono);color:var(â€“text-muted);text-transform:uppercase;letter-spacing:1px;margin-top:1px}
.team-area-lbl{font-size:11px;color:var(â€“blue-light);margin-top:2px}
.team-metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.tm-val{font-size:18px;font-weight:800;letter-spacing:-.3px}
.tm-lbl{font-size:9px;color:var(â€“text-muted);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1px}

/* WEATHER */
.wx-hero{display:grid;grid-template-columns:1fr 1.2fr;gap:14px;margin-bottom:16px}
.wx-main{background:linear-gradient(135deg,var(â€“bg-card),rgba(37,99,235,.08));border:1px solid var(â€“border);border-radius:12px;padding:24px;display:flex;align-items:center;gap:20px}
.wx-big-icon{font-size:60px;line-height:1}
.wx-temp{font-size:46px;font-weight:900;letter-spacing:-2px;line-height:1}
.wx-cond{font-size:15px;font-weight:600;color:var(â€“blue-light);margin-top:4px}
.wx-loc{font-size:11px;color:var(â€“text-muted);font-family:var(â€“mono);margin-top:4px}
.wx-feels{font-size:12px;color:var(â€“text-secondary);margin-top:3px}
.wx-details{background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:12px;padding:16px}
.wx-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(â€“border)}
.wx-row:last-child{border-bottom:none}
.wx-row-lbl{font-size:12px;color:var(â€“text-secondary)}
.wx-row-val{font-size:12px;font-weight:600;font-family:var(â€“mono);color:var(â€“text-primary)}
.fc-row{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:14px}
.fc-day{background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:9px;padding:11px 6px;text-align:center}
.fc-lbl{font-size:10px;font-family:var(â€“mono);color:var(â€“text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px}
.fc-ico{font-size:20px;margin-bottom:5px}
.fc-hi{font-size:13px;font-weight:700;color:var(â€“text-primary)}
.fc-lo{font-size:10px;color:var(â€“text-muted);font-family:var(â€“mono)}
.wx-alert{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:9px;padding:12px 14px;margin-bottom:14px;display:flex;gap:10px;align-items:flex-start}
.wx-alert-ico{font-size:16px;flex-shrink:0}
.wx-alert-txt{font-size:12px;color:var(â€“amber);line-height:1.6}
.wx-impact{background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:12px;padding:16px}
.wx-impact h4{font-size:10px;color:var(â€“text-muted);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px}
.impact-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.imp{background:var(â€“bg-elevated);border:1px solid var(â€“border);border-radius:9px;padding:12px;text-align:center}
.imp-ico{font-size:18px;margin-bottom:5px}
.imp-lbl{font-size:9px;color:var(â€“text-muted);font-family:var(â€“mono);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px}
.imp-val{font-size:13px;font-weight:700}
.imp-good{color:var(â€“green)}.imp-ok{color:var(â€“amber)}.imp-bad{color:var(â€“red)}

/* CRIME */
#crime-map-wrap{border:1px solid var(â€“border);border-radius:12px;overflow:hidden;height:340px;margin-bottom:12px}
.crime-bar{background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:9px;padding:11px 14px;margin-bottom:12px;font-size:13px;color:var(â€“text-secondary)}
.crime-bar.ok{border-color:var(â€“green-border);color:var(â€“green);background:var(â€“green-ghost)}
.crime-bar.err{border-color:var(â€“red-border);color:var(â€“red);background:var(â€“red-ghost)}
.crime-filters{display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap}
.cf-btn{background:var(â€“bg-elevated);border:1px solid var(â€“border-strong);border-radius:7px;color:var(â€“text-secondary);padding:6px 12px;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;font-family:var(â€“font)}
.cf-btn.active,.cf-btn:hover{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.4);color:var(â€“amber)}

/* SERVICE STATUS */
.svc-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.svc-card{background:var(â€“bg-card);border:1px solid var(â€“border);border-radius:12px;padding:16px;transition:border-color .2s}
.svc-card:hover{border-color:var(â€“border-strong)}
.svc-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px}
.svc-name{font-size:13px;font-weight:600;color:var(â€“text-primary)}
.svc-desc{font-size:11px;color:var(â€“text-muted);font-family:var(â€“mono);margin-top:1px}
.svc-spark{height:38px;display:flex;align-items:flex-end;gap:2px;margin-bottom:8px}
.svc-bar{flex:1;border-radius:2px;min-height:3px}
.svc-bot{display:flex;justify-content:space-between;font-size:10px;font-family:var(â€“mono);color:var(â€“text-muted)}
.svc-bot .ok{color:var(â€“green);font-weight:700}
.svc-bot .down{color:var(â€“red);font-weight:700}
.svc-bot .chk{color:var(â€“amber);font-weight:700}
.ov-banner{border-radius:10px;padding:15px 18px;margin-bottom:16px;display:flex;align-items:center;gap:14px;background:var(â€“bg-card);border:1px solid var(â€“border)}
.ov-banner.all-ok{border-color:var(â€“green-border);background:var(â€“green-ghost)}
.ov-banner.issues{border-color:rgba(245,158,11,.3);background:var(â€“amber-ghost)}
.ov-icon{font-size:22px}
.ov-title{font-size:14px;font-weight:700}
.ov-banner.all-ok .ov-title{color:var(â€“green)}
.ov-banner.issues .ov-title{color:var(â€“amber)}
.ov-sub{font-size:11px;color:var(â€“text-muted);font-family:var(â€“mono);margin-top:1px}
.log-row{display:grid;grid-template-columns:100px 1fr 60px;gap:12px;align-items:center;padding:10px 14px;border-bottom:1px solid var(â€“border);font-size:12px}
.log-row:last-child{border-bottom:none}
.log-time{font-family:var(â€“mono);font-size:10px;color:var(â€“text-muted)}
.log-msg{color:var(â€“text-secondary)}
.log-score{font-family:var(â€“mono);font-size:10px;text-align:right;font-weight:600}

/* REP BARS */
.rep-bar-wrap{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.rep-bar-name{width:68px;font-size:11px;font-family:var(â€“mono);color:var(â€“text-muted);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rep-bar-track{flex:1;height:20px;background:var(â€“bg-elevated);border-radius:4px;overflow:hidden}
.rep-bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:7px;transition:width .8s ease}
.rep-bar-fill span{font-size:9px;font-weight:700;color:#fff;font-family:var(â€“mono)}

/* MODALS */
.modal-backdrop{position:fixed;inset:0;background:rgba(7,11,20,.82);backdrop-filter:blur(6px);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.modal-backdrop.open{display:flex;animation:fadein .2s ease}
@keyframes fadein{from{opacity:0}to{opacity:1}}
.modal{background:var(â€“bg-card);border:1px solid var(â€“border-strong);border-radius:16px;width:500px;max-width:100%;max-height:90vh;overflow-y:auto;box-shadow:var(â€“shadow-lg);animation:slideUp .25s cubic-bezier(.4,0,.2,1)}
@keyframes slideUp{from{opacity:0;transform:translateY(14px) scale(.98)}to{opacity:1;transform:none}}
.modal-hd{padding:20px 22px 16px;border-bottom:1px solid var(â€“border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:16px;font-weight:700;color:var(â€“text-primary);letter-spacing:-.2px}
.modal-x{width:28px;height:28px;background:var(â€“bg-elevated);border:1px solid var(â€“border);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:15px;color:var(â€“text-muted);cursor:pointer;transition:all .15s}
.modal-x:hover{background:var(â€“red-ghost);border-color:var(â€“red-border);color:var(â€“red)}
.modal-bd{padding:20px 22px}
.modal-ft{padding:14px 22px;border-top:1px solid var(â€“border);display:flex;gap:8px;justify-content:flex-end}

/* TOASTS */
#toasts{position:fixed;bottom:22px;right:22px;z-index:9999;display:flex;flex-direction:column;gap:7px;pointer-events:none}
.toast{background:var(â€“bg-elevated);border:1px solid var(â€“border-strong);border-radius:9px;padding:11px 16px;display:flex;align-items:center;gap:9px;font-size:13px;color:var(â€“text-primary);box-shadow:var(â€“shadow-md);pointer-events:all;max-width:300px;animation:toastIn .3s ease}
.toast.success{border-left:3px solid var(â€“green)}
.toast.error{border-left:3px solid var(â€“red)}
.toast.info{border-left:3px solid var(â€“blue-light)}
@keyframes toastIn{from{opacity:0;transform:translateX(18px)}to{opacity:1;transform:none}}
</style>

</head>
<body>
<div id="shell">
<!-- SIDEBAR -->
<nav id="sidebar">
  <div class="sb-logo">
    <div class="sb-logo-icon">ğŸ </div>
    <div class="sb-logo-text">
      <div class="sb-logo-title">Complete Home</div>
      <div class="sb-logo-sub">Field Ops Platform</div>
    </div>
  </div>
  <button class="sb-toggle" onclick="toggleSidebar()">â—€</button>
  <div class="sb-nav">
    <div class="sb-group">Overview</div>
    <button class="sb-link active" onclick="scrollSec('sec-dashboard')"><span class="sb-icon">â¬›</span><span class="sb-lbl">Dashboard</span></button>
    <div class="sb-group">Field Operations</div>
    <button class="sb-link" onclick="scrollSec('sec-map')"><span class="sb-icon">ğŸ“</span><span class="sb-lbl">Live Map</span><span class="sb-badge" id="sb-pin-ct">0</span></button>
    <button class="sb-link" onclick="scrollSec('sec-calendar')"><span class="sb-icon">ğŸ“…</span><span class="sb-lbl">Calendar</span></button>
    <button class="sb-link" onclick="scrollSec('sec-areas')"><span class="sb-icon">ğŸ—º</span><span class="sb-lbl">Territory Areas</span></button>
    <div class="sb-group">Performance</div>
    <button class="sb-link" onclick="scrollSec('sec-sales')"><span class="sb-icon">ğŸ’°</span><span class="sb-lbl">Sales Log</span></button>
    <button class="sb-link" onclick="scrollSec('sec-leaderboard')"><span class="sb-icon">ğŸ†</span><span class="sb-lbl">Leaderboard</span></button>
    <button class="sb-link" onclick="scrollSec('sec-team')"><span class="sb-icon">ğŸ‘¥</span><span class="sb-lbl">Team</span></button>
    <div class="sb-group">Intelligence</div>
    <button class="sb-link" onclick="scrollSec('sec-weather')"><span class="sb-icon">ğŸŒ¤</span><span class="sb-lbl">Weather</span></button>
    <button class="sb-link" onclick="scrollSec('sec-crime')"><span class="sb-icon">ğŸš¨</span><span class="sb-lbl">Crime Map</span></button>
    <button class="sb-link" onclick="scrollSec('sec-status')"><span class="sb-icon">âš¡</span><span class="sb-lbl">Service Status</span><span id="sb-net-dot" class="sb-badge" style="background:var(--green);font-size:0;width:9px;height:9px;border-radius:50%;padding:0;min-width:9px"></span></button>
  </div>
  <div class="sb-user">
    <div class="av">D</div>
    <div style="overflow:hidden;flex:1">
      <div class="sb-user-name">Darrell</div>
      <div class="sb-user-role">Complete Home CEO</div>
    </div>
    <div class="online-dot"></div>
  </div>
</nav>

<!-- MAIN -->

<div id="main">
  <div id="topbar">
    <div class="tb-left">
      <div class="tb-page">Complete Home â€” Field Operations</div>
      <div class="tb-crumb">Monterey County Â· Scroll to navigate all sections below</div>
    </div>
    <div class="tb-right">
      <div class="tb-chip" onclick="scrollSec('sec-weather')" style="cursor:pointer">
        <span id="top-wx-icon">ğŸŒ¤</span>
        <div><div class="tb-chip-lbl">Salinas, CA</div><div class="tb-chip-val"><span id="top-wx-temp">--Â°F</span> <span id="top-wx-cond" style="font-size:10px;color:var(--text-muted);font-weight:400"></span></div></div>
      </div>
      <div class="tb-chip">
        <div class="net-dot" id="net-dot"></div>
        <div><div class="tb-chip-lbl">Network</div><div class="tb-chip-val" id="net-lbl" style="font-size:11px">Online</div></div>
      </div>
      <div class="tb-chip" style="gap:9px">
        <div class="av" style="width:30px;height:30px;font-size:11px">D</div>
        <div><div class="tb-chip-val" style="font-size:12px">Darrell</div><div class="tb-chip-lbl">Complete Home CEO</div></div>
      </div>
    </div>
  </div>

  <!-- SCROLL CONTAINER -->

  <div id="scroll">

```
<!-- DASHBOARD -->
<section class="section" id="sec-dashboard">
  <div class="sec-tag">Overview</div>
  <div class="sec-hd">
    <div class="sec-hd-left"><h2>Good morning, Darrell ğŸ‘‹</h2><p>Here's what's happening across Complete Home operations today.</p></div>
    <div class="sec-hd-right"><button class="btn btn-primary btn-sm" onclick="scrollSec('sec-map')">ğŸ“ Open Map</button></div>
  </div>
  <div class="kpi-row kpi-4">
    <div class="kpi blue"><div class="kpi-lbl">Total Pins</div><div class="kpi-val" id="db-pins">0</div><div class="kpi-sub">Doors worked</div></div>
    <div class="kpi green"><div class="kpi-lbl">Revenue</div><div class="kpi-val" id="db-rev">$0</div><div class="kpi-sub">Logged sales</div></div>
    <div class="kpi amber"><div class="kpi-lbl">Appointments</div><div class="kpi-val" id="db-appts">0</div><div class="kpi-sub">Scheduled</div></div>
    <div class="kpi violet"><div class="kpi-lbl">Close Rate</div><div class="kpi-val" id="db-rate">0%</div><div class="kpi-sub">Sold Ã· pins</div></div>
  </div>
  <div class="g2">
    <div class="card">
      <div class="card-hd"><h3>Recent Activity</h3><span class="meta" style="display:flex;align-items:center;gap:5px"><span class="dot g"></span>Live</span></div>
      <div class="card-body" id="db-activity"><div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">No activity yet</div><div class="empty-sub">Pins, sales, and appointments appear here.</div></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><h3>Today's Appointments</h3></div>
      <div id="db-today"><div class="empty" style="padding:32px"><div class="empty-icon">ğŸ“…</div><div class="empty-title">No appointments today</div></div></div>
    </div>
  </div>
</section>

<!-- MAP -->
<section class="section" id="sec-map">
  <div class="sec-tag">Field Operations</div>
  <div class="sec-hd">
    <div class="sec-hd-left"><h2>ğŸ“ Live Map</h2><p>Drop pins, draw lasso areas, and manage leads</p></div>
    <div class="sec-hd-right"><span class="badge b-blue" id="map-ct">0 pins</span></div>
  </div>
  <div class="map-wrap">
    <div class="map-panel">
      <div class="map-panel-hd"><h4>Lead Manager</h4></div>
      <div class="map-tools">
        <button class="map-tool active" id="tool-pin" onclick="setMapTool('pin',this)">ğŸ“ Pin</button>
        <button class="map-tool" id="tool-lasso" onclick="setMapTool('lasso',this)">âœï¸ Lasso</button>
        <button class="map-tool danger" onclick="clearPins()">ğŸ—‘ Clear</button>
      </div>
      <div class="map-stats-row">
        <div class="ms"><div class="ms-val" id="ms-total">0</div><div class="ms-lbl">Total</div></div>
        <div class="ms"><div class="ms-val" style="color:var(--green)" id="ms-sold">0</div><div class="ms-lbl">Sold</div></div>
        <div class="ms"><div class="ms-val" style="color:var(--violet)" id="ms-appt">0</div><div class="ms-lbl">Appts</div></div>
        <div class="ms"><div class="ms-val" style="color:var(--text-muted)" id="ms-nh">0</div><div class="ms-lbl">N/H</div></div>
      </div>
      <div class="pins-list" id="pin-list">
        <div class="empty" style="padding:32px 12px"><div class="empty-icon" style="font-size:22px">ğŸ“</div><div class="empty-title" style="font-size:12px">No pins yet</div><div class="empty-sub" style="font-size:11px">Click the map to drop a pin, or use Lasso to auto-generate house pins.</div></div>
      </div>
    </div>
    <div class="map-area">
      <div id="leaflet-map"></div>
      <div class="map-hint" id="lasso-hint">Click to add points â€” Enter to finish Â· Esc to cancel</div>
      <div class="map-loader" id="map-loader"><div class="spinner"></div><div class="map-loader-txt" id="map-loader-msg">Querying buildingsâ€¦</div></div>
      <div class="map-legend">
        <h5>Pin Status</h5>
        <div class="leg-r"><div class="leg-d pc-nh"></div>Not Home</div>
        <div class="leg-r"><div class="leg-d pc-new"></div>New Lead</div>
        <div class="leg-r"><div class="leg-d pc-contact"></div>Contacted</div>
        <div class="leg-r"><div class="leg-d pc-appt"></div>Appointment</div>
        <div class="leg-r"><div class="leg-d pc-sold"></div>Sold</div>
        <div class="leg-r"><div class="leg-d pc-no"></div>Not Interested</div>
      </div>
    </div>
  </div>
</section>

<!-- CALENDAR -->
<section class="section" id="sec-calendar">
  <div class="sec-tag">Field Operations</div>
  <div class="sec-hd">
    <div class="sec-hd-left"><h2>ğŸ“… Appointment Calendar</h2><p>Double-click any day to add an appointment</p></div>
    <div class="sec-hd-right">
      <div class="cal-nav">
        <button class="cal-arr" onclick="calNav(-1)">â€¹</button>
        <div class="cal-mlbl" id="cal-lbl">FEB 2026</div>
        <button class="cal-arr" onclick="calNav(1)">â€º</button>
      </div>
      <button class="btn btn-primary btn-sm" onclick="openApptModal(null)">+ Appointment</button>
    </div>
  </div>
  <div class="cal-shell">
    <div>
      <div class="cal-grid-hd" id="cal-hd"></div>
      <div class="cal-grid" id="cal-grid"></div>
    </div>
    <div class="card" style="height:fit-content;max-height:520px;overflow-y:auto">
      <div class="card-hd"><h3>Upcoming</h3></div>
      <div id="appt-list"><div class="empty" style="padding:32px"><div class="empty-icon" style="font-size:22px">ğŸ“…</div><div class="empty-title" style="font-size:12px">No upcoming appointments</div></div></div>
    </div>
  </div>
</section>

<!-- AREAS -->
<section class="section" id="sec-areas">
  <div class="sec-tag">Field Operations</div>
  <div class="sec-hd">
    <div class="sec-hd-left"><h2>ğŸ—º Territory Areas</h2><p>Define and manage canvassing zones across your Complete Home territory</p></div>
    <div class="sec-hd-right"><button class="btn btn-primary btn-sm" onclick="openAreaModal()">+ Add Territory</button></div>
  </div>
  <div class="g3" id="areas-grid">
    <div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ—º</div><div class="empty-title">No territories defined</div><div class="empty-sub">Create territories to organize your canvassing zones.</div></div>
  </div>
</section>

<!-- SALES -->
<section class="section" id="sec-sales">
  <div class="sec-tag">Performance</div>
  <div class="sec-hd">
    <div class="sec-hd-left"><h2>ğŸ’° Sales Log</h2><p>Track every closed deal â€” Complete Home field operations</p></div>
    <div class="sec-hd-right"><button class="btn btn-success btn-sm" onclick="openSaleModal()">+ Log Sale</button></div>
  </div>
  <div class="g2">
    <div class="card">
      <div class="card-hd"><h3>All Transactions</h3><span class="meta" id="sales-ct">0 transactions</span></div>
      <div id="sales-wrap">
        <div class="empty" id="sales-empty"><div class="empty-icon">ğŸ’°</div><div class="empty-title">No sales yet</div><div class="empty-sub">Log your first sale to start tracking revenue.</div></div>
        <table class="tbl" id="sales-tbl" style="display:none">
          <thead><tr><th>Date</th><th>Customer</th><th>Rep</th><th>Product</th><th>Amount</th></tr></thead>
          <tbody id="sales-body"></tbody>
        </table>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="kpi green"><div class="kpi-lbl">Total Revenue</div><div class="kpi-val" id="sales-rev">$0</div><div class="kpi-sub" id="sales-sub">0 transactions</div></div>
      <div class="card"><div class="card-hd"><h3>Revenue by Rep</h3></div><div class="card-body" id="rep-bars"><div class="empty" style="padding:20px"><div class="empty-sub">Log sales to see data</div></div></div></div>
    </div>
  </div>
</section>

<!-- LEADERBOARD -->
<section class="section" id="sec-leaderboard">
  <div class="sec-tag">Performance</div>
  <div class="sec-hd">
    <div class="sec-hd-left"><h2>ğŸ† Sales Leaderboard</h2><p>Live rankings computed from your sales log</p></div>
    <div class="sec-hd-right" style="display:flex;gap:5px">
      <button class="btn btn-primary btn-sm lb-btn" onclick="setLBPeriod('all',this)">All Time</button>
      <button class="btn btn-ghost btn-sm lb-btn" onclick="setLBPeriod('month',this)">This Month</button>
      <button class="btn btn-ghost btn-sm lb-btn" onclick="setLBPeriod('week',this)">This Week</button>
    </div>
  </div>
  <div class="podium" id="lb-podium" style="display:none"></div>
  <div class="card">
    <div class="card-hd"><h3>Full Rankings</h3></div>
    <div class="empty" id="lb-empty"><div class="empty-icon">ğŸ†</div><div class="empty-title">No rankings yet</div><div class="empty-sub">Log sales to see the leaderboard.</div></div>
    <table class="tbl" id="lb-tbl" style="display:none">
      <thead><tr><th>Rank</th><th>Rep</th><th>Territory</th><th>Revenue</th><th>Closes</th><th>Doors</th><th>Close Rate</th></tr></thead>
      <tbody id="lb-body"></tbody>
    </table>
  </div>
</section>

<!-- TEAM -->
<section class="section" id="sec-team">
  <div class="sec-tag">Performance</div>
  <div class="sec-hd">
    <div class="sec-hd-left"><h2>ğŸ‘¥ Team Management</h2><p>Manage your Complete Home field representatives</p></div>
    <div class="sec-hd-right"><button class="btn btn-primary btn-sm" onclick="openRepModal()">+ Add Rep</button></div>
  </div>
  <div class="g4" id="team-grid"></div>
</section>

<!-- WEATHER -->
<section class="section" id="sec-weather">
  <div class="sec-tag">Intelligence</div>
  <div class="sec-hd">
    <div class="sec-hd-left"><h2>ğŸŒ¤ Live Weather</h2><p>Salinas / Monterey County, CA â€” Powered by wttr.in</p></div>
    <div class="sec-hd-right"><button class="btn btn-ghost btn-sm" onclick="loadWeather(true)">â†» Refresh</button></div>
  </div>
  <div id="wx-alert"></div>
  <div id="wx-body"><div class="load-wrap"><div class="spinner"></div><div class="load-txt">Loading weatherâ€¦</div></div></div>
</section>

<!-- CRIME -->
<section class="section" id="sec-crime">
  <div class="sec-tag">Intelligence</div>
  <div class="sec-hd">
    <div class="sec-hd-left"><h2>ğŸš¨ Crime Intelligence Map</h2><p>Recent incidents near Monterey County â€” SpotCrime data</p></div>
    <div class="sec-hd-right"><button class="btn btn-ghost btn-sm" onclick="loadCrime(true)">â†» Refresh</button></div>
  </div>
  <div class="crime-bar" id="crime-bar">ğŸ“¡ Initializing crime data feedâ€¦</div>
  <div id="crime-map-wrap"></div>
  <div class="crime-filters" id="crime-filters" style="display:none">
    <button class="cf-btn active" onclick="filterCrime('all',this)">All Types</button>
    <button class="cf-btn" onclick="filterCrime('theft',this)">Theft</button>
    <button class="cf-btn" onclick="filterCrime('burglary',this)">Burglary</button>
    <button class="cf-btn" onclick="filterCrime('assault',this)">Assault</button>
    <button class="cf-btn" onclick="filterCrime('vandalism',this)">Vandalism</button>
    <button class="cf-btn" onclick="filterCrime('other',this)">Other</button>
  </div>
  <div class="card" id="crime-log" style="display:none">
    <div class="card-hd"><h3>Incident Log</h3><span class="meta" id="crime-ct"></span></div>
    <div id="crime-rows"></div>
  </div>
</section>

<!-- SERVICE STATUS -->
<section class="section" id="sec-status">
  <div class="sec-tag">System</div>
  <div class="sec-hd">
    <div class="sec-hd-left"><h2>âš¡ Service Status</h2><p>Real-time connectivity checks for all platform dependencies</p></div>
    <div class="sec-hd-right"><button class="btn btn-ghost btn-sm" id="check-btn" onclick="runChecks()">â†» Run Checks</button></div>
  </div>
  <div class="ov-banner" id="ov-banner"><div class="ov-icon">ğŸ”„</div><div><div class="ov-title">Initializingâ€¦</div><div class="ov-sub" id="ov-sub">Last checked: â€”</div></div></div>
  <div class="svc-grid" id="svc-grid"></div>
  <div class="card"><div class="card-hd"><h3>Check History</h3><span class="meta" id="log-ct"></span></div><div id="status-log"></div></div>
</section>
```

  </div><!-- /scroll -->
</div><!-- /main -->
</div><!-- /shell -->
<!-- MODALS -->
<div class="modal-backdrop" id="modal-pin">
  <div class="modal">
    <div class="modal-hd"><div class="modal-title">ğŸ“ Lead Details</div><button class="modal-x" onclick="closeModal('modal-pin')">âœ•</button></div>
    <div class="modal-bd">
      <div class="form-row"><div class="form-group"><label class="form-label">First Name</label><input class="form-input" id="pin-fname" placeholder="John"></div><div class="form-group"><label class="form-label">Last Name</label><input class="form-input" id="pin-lname" placeholder="Doe"></div></div>
      <div class="form-group"><label class="form-label">Address</label><input class="form-input" id="pin-addr" readonly style="color:var(--text-muted)"></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="pin-phone" placeholder="(831) 555-0100"></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" id="pin-status"><option value="nh">Not Home</option><option value="new">New Lead</option><option value="contact">Contacted</option><option value="appt">Appointment Set</option><option value="sold">Sold âœ“</option><option value="no">Not Interested</option></select></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Assigned Rep</label><select class="form-select" id="pin-rep"></select></div><div class="form-group"><label class="form-label">Territory</label><select class="form-select" id="pin-area"></select></div></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="pin-notes" placeholder="Customer notes, objections, follow-up detailsâ€¦"></textarea></div>
    </div>
    <div class="modal-ft"><button class="btn btn-secondary btn-sm" onclick="closeModal('modal-pin')">Cancel</button><button class="btn btn-danger btn-sm" id="pin-del" onclick="deletePin()" style="display:none">Delete</button><button class="btn btn-primary btn-sm" onclick="savePin()">Save Lead</button></div>
  </div>
</div>

<div class="modal-backdrop" id="modal-appt">
  <div class="modal">
    <div class="modal-hd"><div class="modal-title" id="appt-modal-title">ğŸ“… New Appointment</div><button class="modal-x" onclick="closeModal('modal-appt')">âœ•</button></div>
    <div class="modal-bd">
      <div class="form-row"><div class="form-group"><label class="form-label">Customer Name</label><input class="form-input" id="appt-cust" placeholder="John Doe"></div><div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="appt-phone" placeholder="(831) 555-0100"></div></div>
      <div class="form-group"><label class="form-label">Address</label><input class="form-input" id="appt-addr" placeholder="Customer address"></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Date</label><input class="form-input" type="date" id="appt-date"></div><div class="form-group"><label class="form-label">Time</label><input class="form-input" type="time" id="appt-time"></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="appt-type"><option value="demo">Product Demo</option><option value="followup">Follow-up</option><option value="close">Close / Sign</option><option value="visit">Initial Visit</option></select></div><div class="form-group"><label class="form-label">Assigned Rep</label><select class="form-select" id="appt-rep"></select></div></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="appt-notes" placeholder="Additional notesâ€¦"></textarea></div>
    </div>
    <div class="modal-ft"><button class="btn btn-secondary btn-sm" onclick="closeModal('modal-appt')">Cancel</button><button class="btn btn-danger btn-sm" id="appt-del" onclick="deleteAppt()" style="display:none">Delete</button><button class="btn btn-primary btn-sm" onclick="saveAppt()">Save Appointment</button></div>
  </div>
</div>

<div class="modal-backdrop" id="modal-sale">
  <div class="modal">
    <div class="modal-hd"><div class="modal-title">ğŸ’° Log New Sale</div><button class="modal-x" onclick="closeModal('modal-sale')">âœ•</button></div>
    <div class="modal-bd">
      <div class="form-row"><div class="form-group"><label class="form-label">Customer Name</label><input class="form-input" id="sale-cust" placeholder="Full name"></div><div class="form-group"><label class="form-label">Sale Date</label><input class="form-input" type="date" id="sale-date"></div></div>
      <div class="form-group"><label class="form-label">Address</label><input class="form-input" id="sale-addr" placeholder="Customer address"></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Product / Package</label><select class="form-select" id="sale-product"><option>Solar Basic (5kW)</option><option>Solar Plus (8kW)</option><option>Solar Premium (12kW)</option><option>Home Security Basic</option><option>Home Security Premium</option><option>Internet Package A</option><option>Internet Package B</option><option>Custom Package</option></select></div><div class="form-group"><label class="form-label">Amount ($)</label><input class="form-input" type="number" id="sale-amount" placeholder="5000" min="0"></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Sales Rep</label><select class="form-select" id="sale-rep"></select></div><div class="form-group"><label class="form-label">Territory</label><select class="form-select" id="sale-area"></select></div></div>
    </div>
    <div class="modal-ft"><button class="btn btn-secondary btn-sm" onclick="closeModal('modal-sale')">Cancel</button><button class="btn btn-success btn-sm" onclick="saveSale()">Log Sale</button></div>
  </div>
</div>

<div class="modal-backdrop" id="modal-area">
  <div class="modal">
    <div class="modal-hd"><div class="modal-title">ğŸ—º Add Territory</div><button class="modal-x" onclick="closeModal('modal-area')">âœ•</button></div>
    <div class="modal-bd">
      <div class="form-row"><div class="form-group"><label class="form-label">Territory Name</label><input class="form-input" id="area-name" placeholder="e.g. North Salinas"></div><div class="form-group"><label class="form-label">ZIP Code</label><input class="form-input" id="area-zip" placeholder="93901"></div></div>
      <div class="form-group"><label class="form-label">Assigned Rep</label><select class="form-select" id="area-rep"></select></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="area-notes" placeholder="Neighborhood type, population densityâ€¦"></textarea></div>
    </div>
    <div class="modal-ft"><button class="btn btn-secondary btn-sm" onclick="closeModal('modal-area')">Cancel</button><button class="btn btn-primary btn-sm" onclick="saveArea()">Create Territory</button></div>
  </div>
</div>

<div class="modal-backdrop" id="modal-rep">
  <div class="modal">
    <div class="modal-hd"><div class="modal-title">ğŸ‘¤ Add Team Member</div><button class="modal-x" onclick="closeModal('modal-rep')">âœ•</button></div>
    <div class="modal-bd">
      <div class="form-row"><div class="form-group"><label class="form-label">First Name</label><input class="form-input" id="rep-fname" placeholder="First"></div><div class="form-group"><label class="form-label">Last Name</label><input class="form-input" id="rep-lname" placeholder="Last"></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Role</label><select class="form-select" id="rep-role"><option value="rep">Sales Rep</option><option value="manager">Manager</option></select></div><div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="rep-phone" placeholder="(831) 555-0100"></div></div>
      <div class="form-group"><label class="form-label">Territory</label><select class="form-select" id="rep-area"></select></div>
    </div>
    <div class="modal-ft"><button class="btn btn-secondary btn-sm" onclick="closeModal('modal-rep')">Cancel</button><button class="btn btn-primary btn-sm" onclick="saveRep()">Add Member</button></div>
  </div>
</div>

<div id="toasts"></div>
<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSISTENT STORAGE â€” localStorage wrapper
   All data is saved automatically on every
   mutation and restored on page load.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STORE_KEY = 'completehome_v1';

function saveAll() {
try {
localStorage.setItem(STORE_KEY, JSON.stringify({
pins:  DB.pins,
appts: DB.appts,
sales: DB.sales,
areas: DB.areas,
reps:  DB.reps,
ids:   IDs,
actLog: actLog
}));
} catch(e) { console.warn(â€˜Save failed:â€™, e); }
}

function loadAll() {
try {
const raw = localStorage.getItem(STORE_KEY);
if (!raw) return;
const saved = JSON.parse(raw);
if (saved.pins)   DB.pins   = saved.pins;
if (saved.appts)  DB.appts  = saved.appts;
if (saved.sales)  DB.sales  = saved.sales;
if (saved.areas)  DB.areas  = saved.areas;
if (saved.reps)   DB.reps   = saved.reps;
if (saved.ids)    Object.assign(IDs, saved.ids);
if (saved.actLog) actLog = saved.actLog;
} catch(e) { console.warn(â€˜Load failed:â€™, e); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DATA STORE (defaults â€” overwritten by localStorage on load)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB = {
pins:  [],
appts: [],
sales: [],
areas: [],
reps: [
{id:1,fname:â€˜Darrellâ€™, lname:â€™â€™,           role:â€˜CEOâ€™,     phone:â€™â€™,areaId:â€™â€™,color:â€™#2563ebâ€™},
{id:2,fname:â€˜Kingâ€™,    lname:â€˜Cannonâ€™,      role:â€˜managerâ€™, phone:â€™â€™,areaId:â€™â€™,color:â€™#8b5cf6â€™},
{id:3,fname:â€˜Shafikâ€™,  lname:â€˜Elafrangiâ€™,   role:â€˜managerâ€™, phone:â€™â€™,areaId:â€™â€™,color:â€™#f59e0bâ€™},
{id:4,fname:â€˜Slyâ€™,     lname:â€˜Walkerâ€™,      role:â€˜managerâ€™, phone:â€™â€™,areaId:â€™â€™,color:â€™#06b6d4â€™}
]
};
const IDs = {pin:1, appt:1, sale:1, area:1, rep:5};
const AREA_COLORS = [â€™#2563ebâ€™,â€™#10b981â€™,â€™#f59e0bâ€™,â€™#ef4444â€™,â€™#8b5cf6â€™,â€™#06b6d4â€™,â€™#ec4899â€™];
const PIN_COLORS  = {nh:â€™#475569â€™,new:â€™#3b82f6â€™,contact:â€™#f59e0bâ€™,appt:â€™#8b5cf6â€™,sold:â€™#10b981â€™,no:â€™#ef4444â€™};
let actLog = [];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $   = id => document.getElementById(id);
const iso  = ()  => new Date().toISOString().slice(0,10);
const rName = id => { const r = DB.reps.find(x=>x.id==id); return r ? `${r.fname} ${r.lname}`.trim() : â€˜â€”â€™; };
const rObj  = id => DB.reps.find(x=>x.id==id);
const fmtAmt = n => â€˜$â€™+(+n||0).toLocaleString();
const fmtT   = t => { if(!t)returnâ€™â€™; const[h,m]=t.split(â€™:â€™); const hr=+h; return`${hr>12?hr-12:hr||12}:${m} ${hr>=12?'PM':'AM'}`; };
const inits  = r => r?(r.fname[0]||â€™â€™)+(r.lname[0]||â€™â€™):â€™?â€™;
const ago    = ts => { const s=Math.floor((Date.now()-ts)/1000); if(s<60)returnâ€™just nowâ€™; if(s<3600)return Math.floor(s/60)+â€˜m agoâ€™; if(s<86400)return Math.floor(s/3600)+â€˜h agoâ€™; return Math.floor(s/86400)+â€˜d agoâ€™; };

function toast(msg, type=â€˜infoâ€™) {
const el = document.createElement(â€˜divâ€™);
el.className = `toast ${type}`;
el.innerHTML = `<span>${{success:'âœ…',error:'âŒ',info:'â„¹ï¸'}[type]}</span><span>${msg}</span>`;
$(â€˜toastsâ€™).appendChild(el);
setTimeout(()=>{ el.style.opacity=â€˜0â€™; el.style.transform=â€˜translateX(18px)â€™; el.style.transition=â€˜all .3sâ€™; setTimeout(()=>el.remove(),300); }, 3500);
}

function openModal(id)  { $(id).classList.add(â€˜openâ€™); }
function closeModal(id) { $(id).classList.remove(â€˜openâ€™); }
document.querySelectorAll(â€™.modal-backdropâ€™).forEach(m => m.addEventListener(â€˜clickâ€™, e => { if(e.target===m) m.classList.remove(â€˜openâ€™); }));

function populateRepSelect(id) {
const el=$(id); if(!el)return;
const prev=el.value;
el.innerHTML=â€™<option value="">Select repâ€¦</option>â€™+DB.reps.map(r=>`<option value="${r.id}">${`${r.fname} ${r.lname}`.trim()} (${r.role})</option>`).join(â€™â€™);
el.value=prev;
}
function populateAreaSelect(id) {
const el=$(id); if(!el)return;
const prev=el.value;
el.innerHTML=â€™<option value="">No territory</option>â€™+DB.areas.map(a=>`<option value="${a.id}">${a.name}</option>`).join(â€™â€™);
el.value=prev;
}
function refreshSelects() {
[â€˜pin-repâ€™,â€˜appt-repâ€™,â€˜sale-repâ€™,â€˜area-repâ€™,â€˜rep-areaâ€™].forEach(populateRepSelect);
[â€˜pin-areaâ€™,â€˜sale-areaâ€™].forEach(populateAreaSelect);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
NAVIGATION â€” scroll-spy
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function scrollSec(id) {
const el=$(id); if(!el)return;
$(â€˜scrollâ€™).scrollTo({ top: el.offsetTop - 8, behavior:â€˜smoothâ€™ });
}

let sidebarCollapsed = false;
function toggleSidebar() {
sidebarCollapsed = !sidebarCollapsed;
$(â€˜sidebarâ€™).classList.toggle(â€˜collapsedâ€™, sidebarCollapsed);
document.querySelector(â€™.sb-toggleâ€™).textContent = sidebarCollapsed ? â€˜â–¶â€™ : â€˜â—€â€™;
}

function setupScrollSpy() {
const sections = document.querySelectorAll(â€˜section.section[id]â€™);
const links    = document.querySelectorAll(â€™.sb-linkâ€™);
const idToLink = {};
links.forEach(l => {
const fn = l.getAttribute(â€˜onclickâ€™);
const m  = fn && fn.match(/scrollSec(â€™([^â€™]+)â€™)/);
if(m) idToLink[m[1]] = l;
});
const scroller = $(â€˜scrollâ€™);
const obs = new IntersectionObserver(entries => {
entries.forEach(e => {
if(e.isIntersecting) {
links.forEach(l => l.classList.remove(â€˜activeâ€™));
const lnk = idToLink[e.target.id];
if(lnk) lnk.classList.add(â€˜activeâ€™);
}
});
}, { root: scroller, threshold: 0.15, rootMargin: â€˜-60px 0px -50% 0pxâ€™ });
sections.forEach(s => obs.observe(s));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateDash() {
const pins  = DB.pins.length;
const sold  = DB.pins.filter(p=>p.status===â€˜soldâ€™).length;
const rev   = DB.sales.reduce((s,x)=>s+(+x.amount||0), 0);
const appts = DB.appts.length;

$(â€˜db-pinsâ€™).textContent  = pins.toLocaleString();
$(â€˜db-revâ€™).textContent   = fmtAmt(rev);
$(â€˜db-apptsâ€™).textContent = appts;
$(â€˜db-rateâ€™).textContent  = pins>0 ? (sold/pins*100).toFixed(1)+â€™%â€™ : â€˜0%â€™;
$(â€˜sb-pin-ctâ€™).textContent = pins;

const ac = $(â€˜db-activityâ€™);
if(!actLog.length) {
ac.innerHTML=â€™<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-title">No activity yet</div><div class="empty-sub">Pins, sales, and appointments appear here in real time.</div></div>â€™;
} else {
ac.innerHTML = actLog.slice(0,8).map(a=>` <div class="act-item"> <div class="act-icon" style="background:${a.bg}">${a.icon}</div> <div style="flex:1;min-width:0"> <div class="act-title">${a.title}</div> <div class="act-sub">${a.sub}</div> </div> <div class="act-time">${ago(a.ts)}</div> </div>`).join(â€™â€™);
}

const today = iso();
const todayA = DB.appts.filter(a=>a.date===today).sort((a,b)=>a.time.localeCompare(b.time));
$(â€˜db-todayâ€™).innerHTML = !todayA.length
? â€˜<div class="empty" style="padding:32px"><div class="empty-icon">ğŸ“…</div><div class="empty-title">No appointments today</div></div>â€™
: todayA.map(a=>`<div class="appt-item"> <div class="appt-time">${fmtT(a.time)}</div> <div class="appt-name">${a.cust}</div> <div class="appt-det">${a.addr}</div> <div class="appt-det">${rName(a.rep)}</div> </div>`).join(â€™â€™);
}

function logAct(icon, title, sub, bg) {
actLog.unshift({icon, title, sub, bg, ts: Date.now()});
if(actLog.length > 40) actLog.pop();
saveAll();
updateDash();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lmap=null, mapTool=â€˜pinâ€™, mapMkrs={}, activePinId=null;
let lassoPoints=[], lassoLG=null;
let mapInitialized=false;

function mkIcon(status) {
const c = PIN_COLORS[status]||â€™#475569â€™;
return L.divIcon({
html:`<div style="width:13px;height:13px;border-radius:50%;background:${c};border:2px solid rgba(255,255,255,.3);box-shadow:0 2px 5px rgba(0,0,0,.4),0 0 7px ${c}66"></div>`,
className:â€™â€™, iconSize:[13,13], iconAnchor:[6,6]
});
}

function initMap() {
if(mapInitialized) { if(lmap) lmap.invalidateSize(); return; }
mapInitialized = true;
lmap = L.map(â€˜leaflet-mapâ€™, {center:[36.677,-121.655], zoom:12});
L.tileLayer(â€˜https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.pngâ€™, {attribution:â€˜Â© OpenStreetMapâ€™, maxZoom:20}).addTo(lmap);
lassoLG = L.layerGroup().addTo(lmap);
lmap.on(â€˜clickâ€™, onMapClick);
document.addEventListener(â€˜keydownâ€™, e => {
if(e.key===â€˜Escapeâ€™ && mapTool===â€˜lassoâ€™) cancelLasso();
if(e.key===â€˜Enterâ€™  && mapTool===â€˜lassoâ€™ && lassoPoints.length>=3) finishLasso();
});
// Re-place all saved pins onto the map
DB.pins.forEach(pin => placeMarker(pin));
updateMapUI();
}

function setMapTool(t, btn) {
mapTool = t;
document.querySelectorAll(â€™.map-toolâ€™).forEach(b=>b.classList.remove(â€˜activeâ€™));
btn.classList.add(â€˜activeâ€™);
if(lmap) lmap.getContainer().style.cursor = t===â€˜lassoâ€™ ? â€˜crosshairâ€™ : â€˜â€™;
if(t===â€˜lassoâ€™) {
$(â€˜lasso-hintâ€™).style.display = â€˜blockâ€™;
$(â€˜lasso-hintâ€™).textContent   = â€˜Click to add points â€” Enter to finish Â· Esc to cancelâ€™;
} else {
lassoPoints = [];
if(lassoLG) lassoLG.clearLayers();
$(â€˜lasso-hintâ€™).style.display = â€˜noneâ€™;
}
}

function onMapClick(e) {
if(mapTool===â€˜pinâ€™)   dropPin(e.latlng);
else if(mapTool===â€˜lassoâ€™) addLassoPoint(e.latlng);
}

function dropPin(ll) {
const pin = {
id:IDs.pin++, lat:ll.lat, lng:ll.lng,
addr:`${ll.lat.toFixed(5)}, ${ll.lng.toFixed(5)}`,
fname:â€™â€™, lname:â€™â€™, phone:â€™â€™, status:â€˜newâ€™, rep:â€™â€™, areaId:â€™â€™, notes:â€™â€™
};
DB.pins.push(pin);
placeMarker(pin);
saveAll();
updateMapUI();
logAct(â€˜ğŸ“â€™,â€˜Pin droppedâ€™, pin.addr, â€˜var(â€“blue-ghost)â€™);
openPinModal(pin.id);
}

function placeMarker(pin) {
const m = L.marker([pin.lat, pin.lng], {icon:mkIcon(pin.status), draggable:true}).addTo(lmap);
m.on(â€˜clickâ€™, () => openPinModal(pin.id));
m.on(â€˜dragendâ€™, e => {
const ll = e.target.getLatLng();
pin.lat = ll.lat; pin.lng = ll.lng;
saveAll();
});
mapMkrs[pin.id] = m;
}

function updateMapUI() {
const total = DB.pins.length;
const sold  = DB.pins.filter(p=>p.status===â€˜soldâ€™).length;
const appt  = DB.pins.filter(p=>p.status===â€˜apptâ€™).length;
const nh    = DB.pins.filter(p=>p.status===â€˜nhâ€™).length;
$(â€˜ms-totalâ€™).textContent = total;
$(â€˜ms-soldâ€™).textContent  = sold;
$(â€˜ms-apptâ€™).textContent  = appt;
$(â€˜ms-nhâ€™).textContent    = nh;
$(â€˜map-ctâ€™).textContent   = total+â€™ pinâ€™+(total!==1?â€˜sâ€™:â€™â€™);
$(â€˜sb-pin-ctâ€™).textContent = total;

const pl = $(â€˜pin-listâ€™);
if(!DB.pins.length) {
pl.innerHTML=â€™<div class="empty" style="padding:32px 12px"><div class="empty-icon" style="font-size:22px">ğŸ“</div><div class="empty-title" style="font-size:12px">No pins yet</div><div class="empty-sub" style="font-size:11px">Click the map to drop a pin, or use Lasso to auto-generate house pins.</div></div>â€™;
return;
}
const bc = {nh:â€˜b-grayâ€™,new:â€˜b-blueâ€™,contact:â€˜b-amberâ€™,appt:â€˜b-violetâ€™,sold:â€˜b-greenâ€™,no:â€˜b-redâ€™};
pl.innerHTML = [â€¦DB.pins].reverse().map(p => {
const name = (p.fname||p.lname) ? `${p.fname} ${p.lname}`.trim() : â€˜Unnamedâ€™;
return `<div class="pin-row" onclick="openPinModal(${p.id})"> <div class="pin-dot" style="background:${PIN_COLORS[p.status]||'#475569'}"></div> <div style="flex:1;min-width:0"><div class="pin-name">${name}</div><div class="pin-addr">${p.addr}</div></div> <span class="badge ${bc[p.status]||'b-gray'}" style="font-size:8px;padding:2px 6px">${p.status==='nh'?'N/H':p.status}</span> </div>`;
}).join(â€™â€™);
}

/* Lasso */
function addLassoPoint(ll) {
lassoPoints.push(ll);
lassoLG.clearLayers();
if(lassoPoints.length===1) {
L.circleMarker(ll,{radius:6,color:â€™#3b82f6â€™,fillColor:â€™#3b82f6â€™,fillOpacity:1,weight:2}).addTo(lassoLG);
$(â€˜lasso-hintâ€™).textContent = â€˜First point set â€” keep clicking to draw your areaâ€™;
} else {
L.polygon(lassoPoints,{color:â€™#3b82f6â€™,fillColor:â€™#3b82f6â€™,fillOpacity:.07,weight:2,dashArray:â€˜6,4â€™}).addTo(lassoLG);
lassoPoints.forEach((pt,i)=>L.circleMarker(pt,{radius:i===0?6:3,color:â€™#3b82f6â€™,fillColor:i===0?â€™#3b82f6â€™:â€™#f1f5f9â€™,fillOpacity:1,weight:2}).addTo(lassoLG));
$(â€˜lasso-hintâ€™).textContent = `${lassoPoints.length} points â€” Enter to generate pins Â· Esc to cancel`;
}
}

function cancelLasso() {
lassoPoints = [];
if(lassoLG) lassoLG.clearLayers();
$(â€˜lasso-hintâ€™).style.display = â€˜noneâ€™;
mapTool = â€˜pinâ€™;
const pinBtn = $(â€˜tool-pinâ€™);
if(pinBtn) { document.querySelectorAll(â€™.map-toolâ€™).forEach(b=>b.classList.remove(â€˜activeâ€™)); pinBtn.classList.add(â€˜activeâ€™); }
if(lmap) lmap.getContainer().style.cursor = â€˜â€™;
}

async function finishLasso() {
if(lassoPoints.length<3) { toast(â€˜Draw at least 3 points firstâ€™,â€˜errorâ€™); return; }
$(â€˜lasso-hintâ€™).style.display = â€˜noneâ€™;
const loader = $(â€˜map-loaderâ€™); loader.classList.add(â€˜showâ€™);
$(â€˜map-loader-msgâ€™).textContent = â€˜Querying OpenStreetMap for buildingsâ€¦â€™;
const lats  = lassoPoints.map(p=>p.lat), lngs = lassoPoints.map(p=>p.lng);
const south = Math.min(â€¦lats)-.001, north = Math.max(â€¦lats)+.001;
const west  = Math.min(â€¦lngs)-.001, east  = Math.max(â€¦lngs)+.001;
const query = `[out:json][timeout:25];(node["addr:housenumber"](${south},${west},${north},${east});way["building"](${south},${west},${north},${east}););out center;`;
let added = 0;
try {
const res = await fetch(â€˜https://overpass-api.de/api/interpreter?data=â€™+encodeURIComponent(query));
if(!res.ok) throw new Error(â€˜Overpass â€˜+res.status);
const data = await res.json();
$(â€˜map-loader-msgâ€™).textContent = `Found ${data.elements.length} buildings â€” placing pinsâ€¦`;
for(const el of data.elements) {
const lat = el.type===â€˜nodeâ€™ ? el.lat : el.center?.lat;
const lng = el.type===â€˜nodeâ€™ ? el.lon : el.center?.lon;
if(!lat||!lng||!ptInPoly({lat,lng},lassoPoints)) continue;
const hn = el.tags?.[â€˜addr:housenumberâ€™]||â€™â€™, st = el.tags?.[â€˜addr:streetâ€™]||â€™â€™;
const addr = hn&&st ? `${hn} ${st}` : `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
const pin  = {id:IDs.pin++,lat,lng,addr,fname:â€™â€™,lname:â€™â€™,phone:â€™â€™,status:â€˜nhâ€™,rep:â€™â€™,areaId:â€™â€™,notes:â€™â€™};
DB.pins.push(pin); placeMarker(pin); added++;
}
if(!added) {
$(â€˜map-loader-msgâ€™).textContent = â€˜No OSM data â€” using grid estimateâ€¦â€™;
await new Promise(r=>setTimeout(r,600));
for(const g of gridInPoly(lassoPoints)) {
const pin = {id:IDs.pin++,â€¦g,fname:â€™â€™,lname:â€™â€™,phone:â€™â€™,status:â€˜nhâ€™,rep:â€™â€™,areaId:â€™â€™,notes:â€™â€™};
DB.pins.push(pin); placeMarker(pin); added++;
}
}
saveAll();
toast(`âœ“ ${added} pins generated from lasso area`,â€˜successâ€™);
logAct(â€˜âœï¸â€™,â€˜Lasso area scannedâ€™,`${added} house pins created`,â€˜rgba(16,185,129,.15)â€™);
} catch(err) { toast(â€˜Could not fetch building data â€” check connectionâ€™,â€˜errorâ€™); }
finally { loader.classList.remove(â€˜showâ€™); cancelLasso(); updateMapUI(); updateDash(); }
}

function ptInPoly(pt, poly) {
let inside=false;
for(let i=0,j=poly.length-1; i<poly.length; j=i++) {
const xi=poly[i].lat, yi=poly[i].lng, xj=poly[j].lat, yj=poly[j].lng;
if(((yi>pt.lng)!==(yj>pt.lng))&&(pt.lat<(xj-xi)*(pt.lng-yi)/(yj-yi)+xi)) inside=!inside;
}
return inside;
}
function gridInPoly(poly) {
const lats=poly.map(p=>p.lat), lngs=poly.map(p=>p.lng);
const s=Math.min(â€¦lats), n=Math.max(â€¦lats), w=Math.min(â€¦lngs), e=Math.max(â€¦lngs);
const step=.00045, pts=[];
for(let lat=s;lat<=n;lat+=step) for(let lng=w;lng<=e;lng+=step)
if(ptInPoly({lat,lng},poly)) pts.push({lat,lng,addr:`${lat.toFixed(5)}, ${lng.toFixed(5)}`});
return pts.slice(0,200);
}

function clearPins() {
if(!DB.pins.length) return;
if(!confirm(`Remove all ${DB.pins.length} pins from the map?`)) return;
Object.values(mapMkrs).forEach(m=>lmap.removeLayer(m));
mapMkrs={}; DB.pins=[];
saveAll(); updateMapUI(); updateDash();
toast(â€˜All pins clearedâ€™,â€˜infoâ€™);
}

/* Pin modal */
function openPinModal(id) {
const pin = DB.pins.find(p=>p.id===id); if(!pin) return;
activePinId = id; refreshSelects();
$(â€˜pin-fnameâ€™).value  = pin.fname||â€™â€™;
$(â€˜pin-lnameâ€™).value  = pin.lname||â€™â€™;
$(â€˜pin-addrâ€™).value   = pin.addr||â€™â€™;
$(â€˜pin-phoneâ€™).value  = pin.phone||â€™â€™;
$(â€˜pin-statusâ€™).value = pin.status||â€˜nhâ€™;
$(â€˜pin-repâ€™).value    = pin.rep||â€™â€™;
$(â€˜pin-areaâ€™).value   = pin.areaId||â€™â€™;
$(â€˜pin-notesâ€™).value  = pin.notes||â€™â€™;
$(â€˜pin-delâ€™).style.display = â€˜inline-flexâ€™;
openModal(â€˜modal-pinâ€™);
}
function savePin() {
const pin = DB.pins.find(p=>p.id===activePinId); if(!pin) return;
pin.fname  = $(â€˜pin-fnameâ€™).value.trim();
pin.lname  = $(â€˜pin-lnameâ€™).value.trim();
pin.phone  = $(â€˜pin-phoneâ€™).value.trim();
pin.status = $(â€˜pin-statusâ€™).value;
pin.rep    = $(â€˜pin-repâ€™).value;
pin.areaId = $(â€˜pin-areaâ€™).value;
pin.notes  = $(â€˜pin-notesâ€™).value.trim();
if(mapMkrs[pin.id]) mapMkrs[pin.id].setIcon(mkIcon(pin.status));
saveAll(); updateMapUI(); updateDash();
toast(â€˜Lead savedâ€™,â€˜successâ€™); closeModal(â€˜modal-pinâ€™);
}
function deletePin() {
if(!confirm(â€˜Delete this pin permanently?â€™)) return;
if(mapMkrs[activePinId]) { lmap.removeLayer(mapMkrs[activePinId]); delete mapMkrs[activePinId]; }
DB.pins = DB.pins.filter(p=>p.id!==activePinId);
activePinId = null;
saveAll(); updateMapUI(); updateDash();
closeModal(â€˜modal-pinâ€™); toast(â€˜Pin deletedâ€™,â€˜infoâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CALENDAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let calDate=new Date(), editApptId=null;
const MONTHS = [â€˜Januaryâ€™,â€˜Februaryâ€™,â€˜Marchâ€™,â€˜Aprilâ€™,â€˜Mayâ€™,â€˜Juneâ€™,â€˜Julyâ€™,â€˜Augustâ€™,â€˜Septemberâ€™,â€˜Octoberâ€™,â€˜Novemberâ€™,â€˜Decemberâ€™];
const DAYS   = [â€˜Sunâ€™,â€˜Monâ€™,â€˜Tueâ€™,â€˜Wedâ€™,â€˜Thuâ€™,â€˜Friâ€™,â€˜Satâ€™];

function renderCal() {
const y=calDate.getFullYear(), m=calDate.getMonth();
$(â€˜cal-lblâ€™).textContent = `${MONTHS[m].slice(0,3).toUpperCase()} ${y}`;
$(â€˜cal-hdâ€™).innerHTML = DAYS.map(d=>`<div class="cal-dh">${d}</div>`).join(â€™â€™);
const firstDay=new Date(y,m,1).getDay(), dim=new Date(y,m+1,0).getDate();
const prevDim=new Date(y,m,0).getDate(), today=new Date();
const cells=[];
for(let i=firstDay-1;i>=0;iâ€“)    cells.push({d:prevDim-i,other:true});
for(let i=1;i<=dim;i++)            cells.push({d:i,other:false});
while(cells.length%7!==0)          cells.push({d:cells.length-firstDay-dim+1,other:true});
$(â€˜cal-gridâ€™).innerHTML = cells.map(c=>{
const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(c.d).padStart(2,'0')}`;
const da = c.other ? [] : DB.appts.filter(a=>a.date===ds);
const isToday = !c.other && today.getDate()===c.d && today.getMonth()===m && today.getFullYear()===y;
const cls = â€˜cal-cellâ€™+(c.other?â€™ otherâ€™:â€™â€™)+(isToday?â€™ todayâ€™:â€™â€™);
const dbl = c.other ? â€˜â€™ : `ondblclick="openApptModal('${ds}')"`;
return `<div class="${cls}" ${dbl}> <div class="cal-dn">${c.d}</div> ${da.slice(0,3).map(a=>`<span class="cal-pill ap-${a.type}">${fmtT(a.time)} ${a.cust}</span>`).join('')} ${da.length>3?`<span style="font-size:9px;color:var(--text-muted);font-family:var(--mono)">+${da.length-3} more</span>`:''} </div>`;
}).join(â€™â€™);

const now=new Date();
const up=DB.appts.filter(a=>new Date(a.date+â€˜Tâ€™+a.time)>=now).sort((a,b)=>new Date(a.date+â€˜Tâ€™+a.time)-new Date(b.date+â€˜Tâ€™+b.time)).slice(0,8);
$(â€˜appt-listâ€™).innerHTML = !up.length
? â€˜<div class="empty" style="padding:32px"><div class="empty-icon" style="font-size:22px">ğŸ“…</div><div class="empty-title" style="font-size:12px">No upcoming appointments</div></div>â€™
: up.map(a=>`<div class="appt-item" onclick="openApptModal(null,${a.id})"> <div class="appt-time">${a.date} Â· ${fmtT(a.time)}</div> <div class="appt-name">${a.cust}</div> <div class="appt-det">${a.addr}</div> <div class="appt-det">${rName(a.rep)}</div> </div>`).join(â€™â€™);
}

function calNav(d) { calDate.setMonth(calDate.getMonth()+d); renderCal(); }

function openApptModal(date, editId=null) {
refreshSelects(); editApptId=editId;
$(â€˜appt-modal-titleâ€™).textContent = editId ? â€˜ğŸ“… Edit Appointmentâ€™ : â€˜ğŸ“… New Appointmentâ€™;
$(â€˜appt-delâ€™).style.display = editId ? â€˜inline-flexâ€™ : â€˜noneâ€™;
if(editId) {
const a=DB.appts.find(x=>x.id===editId); if(!a)return;
$(â€˜appt-custâ€™).value  = a.cust;
$(â€˜appt-phoneâ€™).value = a.phone;
$(â€˜appt-addrâ€™).value  = a.addr;
$(â€˜appt-dateâ€™).value  = a.date;
$(â€˜appt-timeâ€™).value  = a.time;
$(â€˜appt-typeâ€™).value  = a.type;
$(â€˜appt-repâ€™).value   = a.rep;
$(â€˜appt-notesâ€™).value = a.notes;
} else {
$(â€˜appt-custâ€™).value=â€™â€™; $(â€˜appt-phoneâ€™).value=â€™â€™; $(â€˜appt-addrâ€™).value=â€™â€™;
$(â€˜appt-dateâ€™).value=date||iso(); $(â€˜appt-timeâ€™).value=â€˜10:00â€™;
$(â€˜appt-typeâ€™).value=â€˜demoâ€™; $(â€˜appt-repâ€™).value=â€™â€™; $(â€˜appt-notesâ€™).value=â€™â€™;
}
openModal(â€˜modal-apptâ€™);
}
function saveAppt() {
const cust=$(â€˜appt-custâ€™).value.trim(), date=$(â€˜appt-dateâ€™).value;
if(!cust||!date) { toast(â€˜Name and date requiredâ€™,â€˜errorâ€™); return; }
const obj = {cust, phone:$(â€˜appt-phoneâ€™).value, addr:$(â€˜appt-addrâ€™).value, date, time:$(â€˜appt-timeâ€™).value, type:$(â€˜appt-typeâ€™).value, rep:$(â€˜appt-repâ€™).value, notes:$(â€˜appt-notesâ€™).value};
if(editApptId) {
Object.assign(DB.appts.find(a=>a.id===editApptId), obj);
toast(â€˜Appointment updatedâ€™,â€˜successâ€™);
} else {
DB.appts.push({id:IDs.appt++,â€¦obj});
logAct(â€˜ğŸ“…â€™,`Appt: ${cust}`,`${date} ${fmtT(obj.time)}`,â€˜rgba(139,92,246,.15)â€™);
toast(â€˜Appointment scheduledâ€™,â€˜successâ€™);
}
saveAll(); renderCal(); updateDash(); closeModal(â€˜modal-apptâ€™);
}
function deleteAppt() {
if(!confirm(â€˜Delete this appointment?â€™)) return;
DB.appts = DB.appts.filter(a=>a.id!==editApptId);
editApptId = null;
saveAll(); renderCal(); updateDash();
closeModal(â€˜modal-apptâ€™); toast(â€˜Appointment deletedâ€™,â€˜infoâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SALES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSales() {
const total = DB.sales.reduce((s,x)=>s+(+x.amount||0), 0);
$(â€˜sales-revâ€™).textContent = fmtAmt(total);
$(â€˜sales-subâ€™).textContent = DB.sales.length+â€™ transactionâ€™+(DB.sales.length!==1?â€˜sâ€™:â€™â€™)+â€™ loggedâ€™;
$(â€˜sales-ctâ€™).textContent  = DB.sales.length+â€™ transactionsâ€™;
const empty=$(â€˜sales-emptyâ€™), tbl=$(â€˜sales-tblâ€™);
if(!DB.sales.length) { empty.style.display=â€˜flexâ€™; tbl.style.display=â€˜noneâ€™; }
else {
empty.style.display=â€˜noneâ€™; tbl.style.display=â€˜tableâ€™;
$(â€˜sales-bodyâ€™).innerHTML = [â€¦DB.sales].reverse().map(s=>`<tr> <td class="mono">${s.date}</td> <td class="pri">${s.cust}</td> <td>${rName(s.rep)}</td> <td>${s.product}</td> <td class="money">${fmtAmt(s.amount)}</td> </tr>`).join(â€™â€™);
}
const rt={};
DB.sales.forEach(s=>{ if(!s.rep)return; if(!rt[s.rep])rt[s.rep]=0; rt[s.rep]+=(+s.amount||0); });
const sorted=Object.entries(rt).sort((a,b)=>b[1]-a[1]);
const maxAmt=sorted[0]?sorted[0][1]:1;
const barCols=[â€™#2563ebâ€™,â€™#10b981â€™,â€™#f59e0bâ€™,â€™#8b5cf6â€™,â€™#06b6d4â€™,â€™#ef4444â€™];
$(â€˜rep-barsâ€™).innerHTML = !sorted.length
? â€˜<div class="empty" style="padding:20px"><div class="empty-sub">Log sales to see data</div></div>â€™
: sorted.map(([rid,amt],i)=>` <div class="rep-bar-wrap"> <div class="rep-bar-name">${rName(rid).split(' ')[0]}</div> <div class="rep-bar-track"> <div class="rep-bar-fill" style="width:${Math.round(amt/maxAmt*100)}%;background:${barCols[i%6]}"> <span>${fmtAmt(amt)}</span> </div> </div> </div>`).join(â€™â€™);
}
function openSaleModal() {
refreshSelects();
$(â€˜sale-custâ€™).value=â€™â€™; $(â€˜sale-dateâ€™).value=iso(); $(â€˜sale-addrâ€™).value=â€™â€™;
$(â€˜sale-amountâ€™).value=â€™â€™; $(â€˜sale-repâ€™).value=â€™â€™; $(â€˜sale-areaâ€™).value=â€™â€™;
openModal(â€˜modal-saleâ€™);
}
function saveSale() {
const cust=$(â€˜sale-custâ€™).value.trim(), amt=parseFloat($(â€˜sale-amountâ€™).value)||0;
if(!cust||amt<=0) { toast(â€˜Customer name and valid amount requiredâ€™,â€˜errorâ€™); return; }
const s = {id:IDs.sale++, cust, date:$(â€˜sale-dateâ€™).value, addr:$(â€˜sale-addrâ€™).value, product:$(â€˜sale-productâ€™).value, amount:amt, rep:$(â€˜sale-repâ€™).value, areaId:$(â€˜sale-areaâ€™).value};
DB.sales.push(s);
logAct(â€˜ğŸ’°â€™,`Sale closed: ${cust}`,fmtAmt(amt),â€˜rgba(16,185,129,.15)â€™);
saveAll(); renderSales(); renderLeaderboard(); updateDash();
closeModal(â€˜modal-saleâ€™); toast(â€™Sale logged â€” â€™+fmtAmt(amt),â€˜successâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
LEADERBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lbPeriod=â€˜allâ€™;
function setLBPeriod(p, btn) {
lbPeriod=p;
document.querySelectorAll(â€™.lb-btnâ€™).forEach(b=>{ b.classList.remove(â€˜btn-primaryâ€™); b.classList.add(â€˜btn-ghostâ€™); });
btn.classList.remove(â€˜btn-ghostâ€™); btn.classList.add(â€˜btn-primaryâ€™);
renderLeaderboard();
}
function renderLeaderboard() {
const now=new Date(), wk=new Date(now-7*86400000), mo=new Date(now.getFullYear(),now.getMonth(),1);
const filt=DB.sales.filter(s=>{
if(lbPeriod===â€˜weekâ€™)  return new Date(s.date)>=wk;
if(lbPeriod===â€˜monthâ€™) return new Date(s.date)>=mo;
return true;
});
const rd={};
filt.forEach(s=>{ const k=s.rep||â€˜noneâ€™; if(!rd[k])rd[k]={rid:s.rep,amt:0,closes:0}; rd[k].amt+=(+s.amount||0); rd[k].closes++; });
const sorted=Object.values(rd).sort((a,b)=>b.amt-a.amt);
const maxAmt=sorted[0]?.amt||1;
$(â€˜lb-emptyâ€™).style.display = sorted.length ? â€˜noneâ€™ : â€˜flexâ€™;
$(â€˜lb-tblâ€™).style.display   = sorted.length ? â€˜tableâ€™ : â€˜noneâ€™;
const podium=$(â€˜lb-podiumâ€™);
if(sorted.length>=1) {
podium.style.display=â€˜gridâ€™;
podium.innerHTML = sorted.slice(0,3).map((d,i)=>{
const rep=rObj(d.rid), color=rep?.color||â€™#2563ebâ€™;
const doors=DB.pins.filter(p=>p.rep==d.rid).length;
const medals=[â€˜goldâ€™,â€˜silverâ€™,â€˜bronzeâ€™], icons=[â€˜ğŸ¥‡â€™,â€˜ğŸ¥ˆâ€™,â€˜ğŸ¥‰â€™];
return `<div class="pod-card ${medals[i]}"> <div class="pod-medal">${icons[i]}</div> <div class="pod-av" style="background:${color}22;color:${color};border-color:${color}44">${rep?inits(rep):'?'}</div> <div class="pod-name">${rep?`${rep.fname} ${rep.lname}`.trim():'Unknown'}</div> <div class="pod-area">${rep?.areaId?DB.areas.find(a=>a.id==rep.areaId)?.name||'â€”':'â€”'}</div> <div class="pod-amt">${fmtAmt(d.amt)}</div> <div class="pod-meta">${d.closes} close${d.closes!==1?'s':''} Â· ${doors} doors</div> </div>`;
}).join(â€™â€™);
} else { podium.style.display=â€˜noneâ€™; }
const rankCls=[â€˜b-amberâ€™,â€˜b-grayâ€™,â€˜b-violetâ€™];
$(â€˜lb-bodyâ€™).innerHTML = sorted.map((d,i)=>{
const rep=rObj(d.rid), color=rep?.color||â€™#475569â€™;
const doors=DB.pins.filter(p=>p.rep==d.rid).length;
const rate=doors>0?(d.closes/doors*100).toFixed(1)+â€™%â€™:â€™â€”â€™;
return `<tr> <td><span class="badge ${rankCls[i]||'b-gray'}" style="font-size:11px;font-weight:800">${i+1}</span></td> <td><div style="display:flex;align-items:center;gap:9px"> <div style="width:32px;height:32px;border-radius:8px;background:${color}22;color:${color};border:1px solid ${color}44;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0">${rep?inits(rep):'?'}</div> <div class="pri">${rep?`${rep.fname} ${rep.lname}`.trim():'Unknown'}</div> </div></td> <td class="mono">${rep?.areaId?DB.areas.find(a=>a.id==rep.areaId)?.name||'â€”':'â€”'}</td> <td><div style="font-size:15px;font-weight:800;color:var(--green)">${fmtAmt(d.amt)}</div> <div style="height:2px;background:var(--bg-elevated);border-radius:2px;margin-top:4px;width:80px"><div style="height:100%;width:${Math.round(d.amt/maxAmt*100)}%;background:${color};border-radius:2px"></div></div> </td> <td style="font-size:14px;font-weight:700;color:var(--blue-light);font-family:var(--mono)">${d.closes}</td> <td class="mono">${doors}</td> <td class="mono">${rate}</td> </tr>`;
}).join(â€™â€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AREAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAreas() {
const g=$(â€˜areas-gridâ€™);
if(!DB.areas.length) {
g.innerHTML=â€™<div class="empty" style="grid-column:1/-1"><div class="empty-icon">ğŸ—º</div><div class="empty-title">No territories defined</div><div class="empty-sub">Create territories to organize your canvassing zones.</div></div>â€™;
return;
}
g.innerHTML = DB.areas.map(a=>{
const rep=rObj(a.repId);
const pins=DB.pins.filter(p=>p.areaId==a.id).length;
const sold=DB.pins.filter(p=>p.areaId==a.id&&p.status===â€˜soldâ€™).length;
const rate=pins>0?(sold/pins*100).toFixed(1):0;
return `<div class="area-card"> <div class="area-stripe" style="background:${a.color}"></div> <div class="area-name">${a.name}</div> <div class="area-meta">ZIP: ${a.zip||'â€”'} Â· ${rep?`${rep.fname} ${rep.lname}`.trim():'Unassigned'}</div> <div class="area-stats"> <div><div class="area-sv" style="color:${a.color}">${pins}</div><div class="area-sl">Doors</div></div> <div><div class="area-sv" style="color:var(--green)">${sold}</div><div class="area-sl">Sold</div></div> <div><div class="area-sv" style="color:var(--text-muted)">${rate}%</div><div class="area-sl">Rate</div></div> </div> <div class="area-prog"><div class="area-prog-fill" style="width:${Math.min(100,+rate*4)}%;background:${a.color}"></div></div> ${a.notes?`<div class="area-note">${a.notes}</div>`:''} </div>`;
}).join(â€™â€™);
}
function openAreaModal() { refreshSelects(); $(â€˜area-nameâ€™).value=â€™â€™; $(â€˜area-zipâ€™).value=â€™â€™; $(â€˜area-repâ€™).value=â€™â€™; $(â€˜area-notesâ€™).value=â€™â€™; openModal(â€˜modal-areaâ€™); }
function saveArea() {
if(!$(â€˜area-nameâ€™).value.trim()) { toast(â€˜Area name requiredâ€™,â€˜errorâ€™); return; }
const a = {id:IDs.area++, name:$(â€˜area-nameâ€™).value.trim(), zip:$(â€˜area-zipâ€™).value.trim(), repId:$(â€˜area-repâ€™).value, notes:$(â€˜area-notesâ€™).value.trim(), color:AREA_COLORS[DB.areas.length%AREA_COLORS.length]};
DB.areas.push(a);
saveAll(); refreshSelects(); renderAreas();
closeModal(â€˜modal-areaâ€™); toast(â€˜Territory createdâ€™,â€˜successâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TEAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTeam() {
$(â€˜team-gridâ€™).innerHTML = DB.reps.map(r=>{
const rev       = DB.sales.filter(s=>s.rep==r.id).reduce((t,s)=>t+(+s.amount||0),0);
const leads     = DB.pins.filter(p=>p.rep==r.id).length;
const appts     = DB.appts.filter(a=>a.rep==r.id).length;
const areaName  = r.areaId ? DB.areas.find(a=>a.id==r.areaId)?.name : â€˜â€”â€™;
return `<div class="team-card"> <div class="team-top"> <div class="team-av" style="background:${r.color}1a;color:${r.color};border-color:${r.color}33">${inits(r)}</div> <div> <div class="team-name">${`${r.fname} ${r.lname}`.trim()}</div> <div class="team-role">${r.role}</div> <div class="team-area-lbl">${areaName||'No territory'}</div> </div> </div> <div class="team-metrics"> <div><div class="tm-val" style="color:var(--green)">${rev>0?fmtAmt(rev):'$0'}</div><div class="tm-lbl">Revenue</div></div> <div><div class="tm-val" style="color:var(--blue-light)">${leads}</div><div class="tm-lbl">Leads</div></div> <div><div class="tm-val" style="color:var(--violet)">${appts}</div><div class="tm-lbl">Appts</div></div> </div> </div>`;
}).join(â€™â€™);
}
function openRepModal() { refreshSelects(); $(â€˜rep-fnameâ€™).value=â€™â€™; $(â€˜rep-lnameâ€™).value=â€™â€™; $(â€˜rep-roleâ€™).value=â€˜repâ€™; $(â€˜rep-phoneâ€™).value=â€™â€™; $(â€˜rep-areaâ€™).value=â€™â€™; openModal(â€˜modal-repâ€™); }
function saveRep() {
if(!$(â€˜rep-fnameâ€™).value.trim()||!$(â€˜rep-lnameâ€™).value.trim()) { toast(â€˜First and last name requiredâ€™,â€˜errorâ€™); return; }
const r = {id:IDs.rep++, fname:$(â€˜rep-fnameâ€™).value.trim(), lname:$(â€˜rep-lnameâ€™).value.trim(), role:$(â€˜rep-roleâ€™).value, phone:$(â€˜rep-phoneâ€™).value.trim(), areaId:$(â€˜rep-areaâ€™).value, color:AREA_COLORS[DB.reps.length%AREA_COLORS.length]};
DB.reps.push(r);
saveAll(); refreshSelects(); renderTeam();
closeModal(â€˜modal-repâ€™); toast(`${r.fname} ${r.lname} added to team`,â€˜successâ€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
WEATHER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let wxLoaded=false;
const WX_ICONS={113:â€˜â˜€ï¸â€™,116:â€˜â›…â€™,119:â€˜â˜ï¸â€™,122:â€˜ğŸŒ«â€™,143:â€˜ğŸŒ«â€™,176:â€˜ğŸŒ¦â€™,179:â€˜ğŸŒ¨â€™,182:â€˜ğŸŒ§â€™,185:â€˜ğŸŒ§â€™,200:â€˜â›ˆâ€™,263:â€˜ğŸŒ¦â€™,266:â€˜ğŸŒ§â€™,281:â€˜ğŸŒ§â€™,284:â€˜ğŸŒ§â€™,293:â€˜ğŸŒ¦â€™,296:â€˜ğŸŒ§â€™,299:â€˜ğŸŒ§â€™,302:â€˜ğŸŒ§â€™,305:â€˜ğŸŒ§â€™,308:â€˜ğŸŒ§â€™,317:â€˜ğŸŒ§â€™,320:â€˜ğŸŒ¨â€™,323:â€˜ğŸŒ¨â€™,326:â€˜ğŸŒ¨â€™,329:â€˜â„ï¸â€™,332:â€˜â„ï¸â€™,335:â€˜â„ï¸â€™,338:â€˜â„ï¸â€™,353:â€˜ğŸŒ¦â€™,356:â€˜ğŸŒ§â€™,359:â€˜ğŸŒ§â€™,362:â€˜ğŸŒ¨â€™,365:â€˜ğŸŒ¨â€™,368:â€˜ğŸŒ¨â€™,386:â€˜â›ˆâ€™,389:â€˜â›ˆâ€™,392:â€˜â›ˆâ€™,395:â€˜â„ï¸â€™};
const wxIcon = c => WX_ICONS[+c]||â€˜ğŸŒ¡â€™;

async function loadWeather(force=false) {
if(wxLoaded&&!force) return;
$(â€˜wx-bodyâ€™).innerHTML=â€™<div class="load-wrap"><div class="spinner"></div><div class="load-txt">Fetching live weather from wttr.inâ€¦</div></div>â€™;
$(â€˜wx-alertâ€™).innerHTML=â€™â€™;
try {
const res=await fetch(â€˜https://wttr.in/Salinas,CA?format=j1â€™);
if(!res.ok) throw new Error(â€˜HTTP â€˜+res.status);
const d=await res.json(); wxLoaded=true;
const cur=d.current_condition[0];
const icon=wxIcon(cur.weatherCode), temp=cur.temp_F, feels=cur.FeelsLikeF, desc=cur.weatherDesc[0].value;
const hum=cur.humidity, wind=`${cur.windspeedMiles} mph ${cur.winddir16Point}`;
const vis=cur.visibility+â€™ miâ€™, uv=cur.uvIndex, cloud=cur.cloudcover+â€™%â€™;
$(â€˜top-wx-iconâ€™).textContent=icon; $(â€˜top-wx-tempâ€™).textContent=temp+â€˜Â°Fâ€™; $(â€˜top-wx-condâ€™).textContent=desc;
const fc=d.weather.slice(0,7);
const DS=[â€˜Sunâ€™,â€˜Monâ€™,â€˜Tueâ€™,â€˜Wedâ€™,â€˜Thuâ€™,â€˜Friâ€™,â€˜Satâ€™];
const isRain=desc.toLowerCase().includes(â€˜rainâ€™)||desc.toLowerCase().includes(â€˜drizzleâ€™);
const wNum=+cur.windspeedMiles, uvNum=+uv, tNum=+temp;
const grade=!isRain&&tNum>52&&tNum<92?â€˜Excellentâ€™:!isRain&&tNum>42?â€˜Goodâ€™:isRain?â€˜Poorâ€™:â€˜Fairâ€™;
const gc=grade===â€˜Excellentâ€™?â€˜goodâ€™:grade===â€˜Goodâ€™?â€˜okâ€™:â€˜badâ€™;
if(isRain||wNum>20||tNum<42) {
$(â€˜wx-alertâ€™).innerHTML=`<div class="wx-alert"><div class="wx-alert-ico">âš ï¸</div><div class="wx-alert-txt"><strong>Field Advisory â€” </strong>${isRain?'Rain detected. Consider rescheduling canvassing. ':''}${wNum>20?'High winds may affect activities. ':''}${tNum<42?'Cold temps below 42Â°F.':''}</div></div>`;
}
$(â€˜wx-bodyâ€™).innerHTML=` <div class="wx-hero"> <div class="wx-main"> <div class="wx-big-icon">${icon}</div> <div><div class="wx-temp">${temp}Â°F</div><div class="wx-feels">Feels like ${feels}Â°F</div><div class="wx-cond">${desc}</div><div class="wx-loc">ğŸ“ Salinas / Monterey County, CA</div></div> </div> <div class="wx-details"> <div class="wx-row"><span class="wx-row-lbl">Humidity</span><span class="wx-row-val">${hum}%</span></div> <div class="wx-row"><span class="wx-row-lbl">Wind</span><span class="wx-row-val">${wind}</span></div> <div class="wx-row"><span class="wx-row-lbl">Visibility</span><span class="wx-row-val">${vis}</span></div> <div class="wx-row"><span class="wx-row-lbl">UV Index</span><span class="wx-row-val" style="color:${uvNum<=2?'var(--green)':uvNum<=5?'var(--amber)':'var(--red)'}">${uv}</span></div> <div class="wx-row"><span class="wx-row-lbl">Cloud Cover</span><span class="wx-row-val">${cloud}</span></div> <div class="wx-row"><span class="wx-row-lbl">Precipitation</span><span class="wx-row-val">${cur.precipMM} mm</span></div> </div> </div> <div style="font-size:10px;font-family:var(--mono);letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:10px">7-Day Forecast</div> <div class="fc-row">${fc.map(day=>{const dd=new Date(day.date);return`<div class="fc-day"><div class="fc-lbl">${DS[dd.getDay()]}</div><div class="fc-ico">${wxIcon(day.hourly[4]?.weatherCode||113)}</div><div class="fc-hi">${day.maxtempF}Â°</div><div class="fc-lo">${day.mintempF}Â°</div></div>`;}).join('')}</div> <div class="wx-impact"> <h4>Field Canvassing Impact Assessment</h4> <div class="impact-grid"> <div class="imp"><div class="imp-ico">ğŸš¶</div><div class="imp-lbl">Canvassing</div><div class="imp-val imp-${gc}">${grade}</div></div> <div class="imp"><div class="imp-ico">ğŸŒ§</div><div class="imp-lbl">Rain Risk</div><div class="imp-val imp-${isRain?'bad':'good'}">${isRain?'Active':'None'}</div></div> <div class="imp"><div class="imp-ico">ğŸ’¨</div><div class="imp-lbl">Wind</div><div class="imp-val imp-${wNum<10?'good':wNum<20?'ok':'bad'}">${wNum<10?'Calm':wNum<20?'Breezy':'Windy'}</div></div> <div class="imp"><div class="imp-ico">â˜€ï¸</div><div class="imp-lbl">UV Risk</div><div class="imp-val imp-${uvNum<=2?'good':uvNum<=5?'ok':'bad'}">${uvNum<=2?'Low':uvNum<=5?'Moderate':'High'}</div></div> </div> </div>`;
} catch(err) {
$(â€˜wx-bodyâ€™).innerHTML=`<div style="background:var(--red-ghost);border:1px solid var(--red-border);border-radius:9px;padding:18px;color:var(--red);font-size:13px">âš  Could not load weather: ${err.message}</div>`;
}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CRIME MAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let crimeMap=null, crimeLoaded=false, crimeData=[], crimeMkrs=[];
const CRIME_COL={theft:â€™#f59e0bâ€™,burglary:â€™#ef4444â€™,assault:â€™#ef4444â€™,vandalism:â€™#8b5cf6â€™,arrest:â€™#06b6d4â€™,other:â€™#94a3b8â€™};
const cColor = t => { const k=Object.keys(CRIME_COL).find(c=>t.toLowerCase().includes(c)); return CRIME_COL[k||â€˜otherâ€™]; };

async function loadCrime(force=false) {
if(crimeLoaded&&!force) return;
$(â€˜crime-barâ€™).className=â€˜crime-barâ€™;
$(â€˜crime-barâ€™).textContent=â€˜ğŸ“¡ Loading crime data from SpotCrimeâ€¦â€™;
if(!crimeMap) {
crimeMap=L.map(â€˜crime-map-wrapâ€™,{center:[36.677,-121.655],zoom:12});
L.tileLayer(â€˜https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.pngâ€™,{attribution:â€˜Â© OpenStreetMapâ€™,maxZoom:19}).addTo(crimeMap);
}
crimeMkrs.forEach(m=>crimeMap.removeLayer(m)); crimeMkrs=[];
try {
const res=await fetch(â€˜https://api.spotcrime.com/crimes.json?lat=36.677&lon=-121.655&r=0.025&key=spotcrimeâ€™);
if(!res.ok) throw new Error(â€˜HTTP â€˜+res.status);
const data=await res.json();
crimeData=data.crimes||[];
if(!crimeData.length) throw new Error(â€˜No incidents for this areaâ€™);
crimeLoaded=true;
renderCrimeMarkers(â€˜allâ€™);
$(â€˜crime-barâ€™).className=â€˜crime-bar okâ€™;
$(â€˜crime-barâ€™).textContent=`âœ… ${crimeData.length} recent incidents loaded for Salinas / Monterey County`;
$(â€˜crime-filtersâ€™).style.display=â€˜flexâ€™;
$(â€˜crime-logâ€™).style.display=â€˜blockâ€™;
setTimeout(()=>crimeMap.invalidateSize(),200);
} catch(err) {
$(â€˜crime-barâ€™).className=â€˜crime-bar errâ€™;
$(â€˜crime-barâ€™).innerHTML=`âš ï¸ SpotCrime data unavailable: ${err.message}<br><span style="font-size:11px;opacity:.75">SpotCrime may not cover all Monterey County zip codes. The map is still interactive.</span>`;
setTimeout(()=>crimeMap.invalidateSize(),200);
}
}
function renderCrimeMarkers(type) {
crimeMkrs.forEach(m=>crimeMap.removeLayer(m)); crimeMkrs=[];
const filtered=type===â€˜allâ€™?crimeData:crimeData.filter(c=>(c.type||â€™â€™).toLowerCase().includes(type));
filtered.forEach(c=>{
if(!c.lat||!c.lon)return;
const col=cColor(c.type||â€™â€™);
const m=L.circleMarker([c.lat,c.lon],{radius:7,color:col,fillColor:col,fillOpacity:.7,weight:2}).addTo(crimeMap);
m.bindPopup(`<div style="font-family:'Outfit',sans-serif;min-width:160px;padding:4px 0"><b style="color:${col};font-size:12px">${c.type||'Unknown'}</b><br><span style="font-size:11px;color:#64748b">${c.address||''}</span><br><span style="font-size:10px;color:#94a3b8">${c.date||''}</span></div>`);
crimeMkrs.push(m);
});
$(â€˜crime-ctâ€™).textContent=filtered.length+â€™ incidentsâ€™;
$(â€˜crime-rowsâ€™).innerHTML=filtered.slice(0,25).map(c=>{
const col=cColor(c.type||â€™â€™);
return `<div class="log-row"> <span class="log-time">${c.date||'Unknown'}</span> <span class="log-msg">${c.address||'Unknown location'}</span> <span class="badge" style="background:${col}22;color:${col};border:1px solid ${col}44;font-size:9px">${c.type||'Unknown'}</span> </div>`;
}).join(â€™â€™);
}
function filterCrime(type, btn) {
document.querySelectorAll(â€™.cf-btnâ€™).forEach(b=>b.classList.remove(â€˜activeâ€™));
btn.classList.add(â€˜activeâ€™); renderCrimeMarkers(type);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SERVICE STATUS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SERVICES=[
{id:â€˜internetâ€™, name:â€˜Internetâ€™,     desc:â€˜General connectivityâ€™, url:â€˜https://www.google.comâ€™},
{id:â€˜mapsâ€™,     name:â€˜Map Tilesâ€™,    desc:â€˜OpenStreetMapâ€™,        url:â€˜https://tile.openstreetmap.org/0/0/0.pngâ€™},
{id:â€˜weatherâ€™,  name:â€˜Weather APIâ€™,  desc:â€˜wttr.inâ€™,              url:â€˜https://wttr.in/test?format=j1â€™},
{id:â€˜spotcrimeâ€™,name:â€˜Crime APIâ€™,    desc:â€˜SpotCrimeâ€™,            url:â€˜https://api.spotcrime.comâ€™},
{id:â€˜overpassâ€™, name:â€˜Overpass APIâ€™, desc:â€˜Building dataâ€™,        url:â€˜https://overpass-api.deâ€™},
{id:â€˜fontsâ€™,    name:â€˜CDN / Fontsâ€™,  desc:â€˜Google Fontsâ€™,         url:â€˜https://fonts.googleapis.comâ€™},
];
let svcState={}, svcLog=[];

async function checkOne(svc) {
const t=Date.now();
try { await fetch(svc.url,{mode:â€˜no-corsâ€™,cache:â€˜no-storeâ€™,signal:AbortSignal.timeout(6000)}); return{ok:true,ms:Date.now()-t}; }
catch { return{ok:false,ms:null}; }
}
async function runChecks() {
renderSvcCards(true);
const btn=$(â€˜check-btnâ€™); btn.disabled=true; btn.textContent=â€˜Checkingâ€¦â€™;
const results=await Promise.all(SERVICES.map(async s=>{ const r=await checkOne(s); svcState[s.id]=r; return{â€¦s,â€¦r}; }));
const allOk=results.every(r=>r.ok);
const banner=$(â€˜ov-bannerâ€™), netDot=$(â€˜net-dotâ€™), netLbl=$(â€˜net-lblâ€™);
const netIndicator=$(â€˜sb-net-dotâ€™);
if(allOk) {
banner.className=â€˜ov-banner all-okâ€™;
banner.innerHTML=`<div class="ov-icon">âœ…</div><div><div class="ov-title">All Systems Operational</div><div class="ov-sub">Last checked: ${new Date().toLocaleTimeString()}</div></div>`;
netDot.className=â€˜net-dotâ€™; netLbl.textContent=â€˜Onlineâ€™;
if(netIndicator) netIndicator.style.background=â€˜var(â€“green)â€™;
} else {
banner.className=â€˜ov-banner issuesâ€™;
const downCount=results.filter(r=>!r.ok).length;
banner.innerHTML=`<div class="ov-icon">âš ï¸</div><div><div class="ov-title">${downCount} Service${downCount>1?'s':''} Unreachable</div><div class="ov-sub">Last checked: ${new Date().toLocaleTimeString()}</div></div>`;
netDot.className=â€˜net-dot warnâ€™; netLbl.textContent=â€˜Issuesâ€™;
if(netIndicator) netIndicator.style.background=â€˜var(â€“amber)â€™;
}
svcLog.unshift({ts:new Date().toLocaleTimeString(), ok:results.filter(r=>r.ok).length, total:results.length, msg:allOk?â€˜All checks passedâ€™:results.filter(r=>!r.ok).map(r=>r.name).join(â€™, â€˜)+â€™ unreachableâ€™});
if(svcLog.length>20) svcLog.pop();
$(â€˜log-ctâ€™).textContent=svcLog.length+â€™ check runsâ€™;
$(â€˜status-logâ€™).innerHTML=svcLog.map(l=>` <div class="log-row"> <span class="log-time">${l.ts}</span> <span class="log-msg">${l.msg}</span> <span class="log-score" style="color:${l.ok===l.total?'var(--green)':'var(--amber)'}">${l.ok}/${l.total}</span> </div>`).join(â€™â€™);
renderSvcCards(false);
btn.disabled=false; btn.textContent=â€˜â†» Run Checksâ€™;
}
function renderSvcCards(checking) {
$(â€˜svc-gridâ€™).innerHTML=SERVICES.map(s=>{
const st=svcState[s.id], status=checking?â€˜chkâ€™:st?(st.ok?â€˜okâ€™:â€˜downâ€™):â€˜chkâ€™;
const colors={ok:â€˜var(â€“green)â€™,down:â€˜var(â€“red)â€™,chk:â€˜var(â€“amber)â€™};
const labels={ok:â€˜ONLINEâ€™,down:â€˜UNREACHABLEâ€™,chk:â€˜CHECKINGâ€™};
const bars=Array.from({length:22},(_,i)=>`<div class="svc-bar" style="height:${8+Math.random()*34}px;background:${status==='ok'?'var(--blue-light)':status==='down'?'var(--red-ghost)':'var(--amber-ghost)'}22"></div>`).join(â€™â€™);
return `<div class="svc-card" style="${status!=='ok'?'border-color:'+colors[status]+'44':''}"> <div class="svc-top"> <div><div class="svc-name">${s.name}</div><div class="svc-desc">${s.desc}</div></div> <div class="dot ${status==='ok'?'g':status==='down'?'r':'a'}" style="margin-top:4px"></div> </div> <div class="svc-spark">${bars}</div> <div class="svc-bot"> <span class="${status}">${labels[status]}</span> <span>${st?.ok?st.ms+'ms':'â€”'}</span> </div> </div>`;
}).join(â€™â€™);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INTERSECTION OBSERVER â€” lazy init map/crime
when those sections scroll into view
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setupLazyLoad() {
const scroller = $(â€˜scrollâ€™);
const lazyObs  = new IntersectionObserver(entries => {
entries.forEach(e => {
if(!e.isIntersecting) return;
const id = e.target.id;
if(id===â€˜sec-mapâ€™     && !mapInitialized) initMap();
if(id===â€˜sec-weatherâ€™ && !wxLoaded)        loadWeather(false);
if(id===â€˜sec-crimeâ€™   && !crimeLoaded)     loadCrime(false);
if(id===â€˜sec-statusâ€™)                      runChecks();
});
}, { root: scroller, threshold: 0.05 });
[â€˜sec-mapâ€™,â€˜sec-weatherâ€™,â€˜sec-crimeâ€™,â€˜sec-statusâ€™].forEach(id => {
const el=$(id); if(el) lazyObs.observe(el);
});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener(â€˜DOMContentLoadedâ€™, () => {
// Load all persisted data first
loadAll();

// Render all UI with loaded data
updateDash();
renderCal();
renderSales();
renderLeaderboard();
renderAreas();
renderTeam();
renderSvcCards(false);
refreshSelects();

// Setup scroll spy + lazy loaders
setupScrollSpy();
setupLazyLoad();

// Set default dates in date inputs
document.querySelectorAll(â€˜input[type=date]â€™).forEach(el=>{ if(!el.value) el.value=iso(); });

// Silent weather fetch for topbar widget
setTimeout(() => {
fetch(â€˜https://wttr.in/Salinas,CA?format=j1â€™)
.then(r=>r.json())
.then(d => {
const cur=d.current_condition[0];
$(â€˜top-wx-iconâ€™).textContent=wxIcon(cur.weatherCode);
$(â€˜top-wx-tempâ€™).textContent=cur.temp_F+â€˜Â°Fâ€™;
$(â€˜top-wx-condâ€™).textContent=cur.weatherDesc[0].value;
}).catch(()=>{});
}, 1000);

// Auto-refresh dashboard stats every minute
setInterval(updateDash, 60000);

// Show a â€œdata loadedâ€ notice if we had saved data
const saved=localStorage.getItem(STORE_KEY);
if(saved) {
const parsed=JSON.parse(saved);
const total=(parsed.pins||[]).length+(parsed.appts||[]).length+(parsed.sales||[]).length;
if(total>0) toast(`Session restored â€” ${total} record${total!==1?'s':''} loaded`,â€˜successâ€™);
}
});
</script>

</body>
</html>
